<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Master - D√©partements</title>
<style>
.hidden { display: none !important; }

body {
    margin: 0;
    font-family: 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #0f1115, #1c1c24);
    color: #f0f0f0;
}

#hover-warning {
    position: absolute;
    padding: 8px 14px;
    background: rgba(0, 0, 0, 0.85);
    color: white;
    font-size: 14px;
    border-radius: 6px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.4s ease;
    z-index: 9999;
}

header {
    width: 100%;
    background: rgba(20, 20, 28, 0.8);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid #333;
    position: sticky;
    top: 0;
    z-index: 1000;
}

.navbar {
    max-width: 1100px;
    margin: auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px;
}

.nav-title {
    font-size: 1.4em;
    font-weight: 600;
    color: #eaeaea;
    letter-spacing: 1px;
}

.user-info {
    display: flex;
    gap: 15px;
    align-items: center;
}

.user-stats {
    font-size: 0.9em;
    text-align: right;
}

.logout-btn {
    padding: 8px 16px;
    background: #dc3545;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    transition: 0.25s;
}

.logout-btn:hover {
    background: #c82333;
}

.dropdown {
    position: relative;
}

.dropdown-btn {
    padding: 10px 20px;
    border-radius: 10px;
    background: #2e2e3d;
    color: #f0f0f0;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: 0.25s;
}

.dropdown-btn:hover {
    background: #45455a;
}

.dropdown-content {
    position: absolute;
    right: 0;
    top: 45px;
    background: #1f1f28;
    border-radius: 12px;
    padding: 10px;
    width: 260px;
    display: none;
    flex-direction: column;
    gap: 8px;
    border: 1px solid #333;
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    z-index: 100;
}

.dropdown.open .dropdown-content {
    display: flex;
}

.dropdown-subtitle {
    font-size: 0.9em;
    color: #cfcfcf;
    margin: 5px 0;
}

.dropdown-item {
    width: 100%;
    padding: 10px 15px;
    border-radius: 8px;
    border: none;
    background: #2c2c3a;
    color: #eaeaea;
    text-align: left;
    cursor: pointer;
    transition: 0.25s;
}

.dropdown-item:hover {
    background: #3d3d50;
}

.dropdown-item.disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

/* AUTH SECTION */
#auth-section {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 80vh;
}

.auth-container {
    background: #1f1f28;
    padding: 40px;
    border-radius: 15px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

.auth-container h2 {
    margin-top: 0;
    text-align: center;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-size: 0.95em;
}

.form-group input {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #333;
    background: #2c2c3a;
    color: #f0f0f0;
    font-size: 1em;
    box-sizing: border-box;
}

.auth-btn {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    background: #9c28a7;
    color: white;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: 0.25s;
    margin-top: 10px;
}

.auth-btn:hover {
    background: #7d1f85;
}

.auth-switch {
    text-align: center;
    margin-top: 20px;
    font-size: 0.9em;
}

.auth-switch a {
    color: #9c28a7;
    cursor: pointer;
    text-decoration: underline;
}

.error-msg {
    background: #dc3545;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
    text-align: center;
}

/* HOME SECTION */
#home-section {
    padding: 80px 20px;
    text-align: center;
}

.home-center h2 {
    font-size: 2.2em;
    margin-bottom: 10px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    max-width: 800px;
    margin: 40px auto;
}

.stat-card {
    background: #262633;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

.stat-card h3 {
    margin-top: 0;
    color: #9c28a7;
}

.stat-value {
    font-size: 2.5em;
    font-weight: bold;
    color: #f0f0f0;
}

.level-badge {
    display: inline-block;
    padding: 8px 16px;
    background: linear-gradient(135deg, #9c28a7, #7d1f85);
    border-radius: 20px;
    font-weight: 600;
    margin-top: 10px;
}

/* LEADERBOARD */
#leaderboard-section {
    max-width: 800px;
    margin: 40px auto;
    padding: 0 20px;
}

.leaderboard-container {
    background: #262633;
    border-radius: 15px;
    padding: 30px;
}

.leaderboard-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    margin: 10px 0;
    background: #2c2c3a;
    border-radius: 10px;
}

.leaderboard-rank {
    font-size: 1.5em;
    font-weight: bold;
    width: 50px;
}

.leaderboard-name {
    flex: 1;
    font-weight: 500;
}

.leaderboard-score {
    font-size: 1.2em;
    color: #9c28a7;
    font-weight: bold;
}

/* QUIZ SECTION */
#quiz-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 40px;
}

.quiz-container {
    display: flex;
    gap: 35px;
    width: 90%;
    max-width: 1000px;
    justify-content: center;
}

.question-box {
    flex: 2;
    background: #262633;
    padding: 30px;
    border-radius: 15px;
    font-size: 1.8em;
    font-weight: 600;
    min-height: 140px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    box-shadow: 0 0 20px rgba(0,0,0,0.35);
}

.answers-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.answer-btn {
    padding: 15px;
    font-size: 1.2em;
    border-radius: 12px;
    background: #323248;
    color: #f0f0f0;
    cursor: pointer;
    border: none;
    transition: 0.18s;
}

.answer-btn:hover:not(:disabled) {
    transform: scale(1.04);
    background: #4a4a65;
}

.answer-btn:disabled {
    cursor: not-allowed;
}

.correct {
    background-color: #2ecc71 !important;
}

.incorrect {
    background-color: #e74c3c !important;
}

#timers-container {
    width: 92%;
    max-width: 1000px;
    margin-top: 25px;
}

#timer-bar-container, 
#question-timer-bar-container {
    margin: 10px 0;
    text-align: left;
    font-size: 0.95em;
}

#timer-bar, 
#question-timer-bar {
    width: 100%;
    height: 28px;
    background: #2b2b3a;
    border-radius: 10px;
    margin-top: 6px;
    overflow: hidden;
}

#timer-fill, 
#question-timer-fill {
    height: 100%;
    width: 100%;
    border-radius: 10px;
    transition: width 0.15s linear;
}

#timer-fill { background: #9c28a7ff; }
#question-timer-fill { background: #a832d6; }

#score-lives {
    margin-top: 20px;
    display: flex;
    gap: 80px;
    justify-content: center;
    font-size: 1.3em;
}

#lives {
    color: #ff4b4b;
    font-size: 1.4em;
}

/* RESULT SECTION */
#result-section {
    margin-top: 60px;
    text-align: center;
}

.result-stats {
    background: #262633;
    padding: 30px;
    border-radius: 15px;
    max-width: 500px;
    margin: 30px auto;
}

.result-stats h3 {
    color: #9c28a7;
    margin-top: 0;
}

.action-btn {
    margin: 10px;
    padding: 12px 25px;
    border-radius: 10px;
    background: #3a3a50;
    border: none;
    cursor: pointer;
    color: #f0f0f0;
    transition: 0.25s;
}

.action-btn:hover {
    background: #4e4e6a;
}

@media screen and (max-width: 750px) {
    .quiz-container {
        flex-direction: column;
    }
    .question-box {
        font-size: 1.8em;
    }
    #score-lives {
        flex-direction: column;
        gap: 15px;
    }
    .dropdown-content {
        width: 200px;
        right: -20px;
    }
}
</style>
</head>
<body>

<header>
    <nav class="navbar">
        <div class="nav-left">
            <span class="nav-title">üéØ Quiz Master</span>
        </div>

        <div class="nav-right" id="nav-logged-out">
            <!-- Vide quand d√©connect√© -->
            <button class="action-btn" onclick="window.location.href='settings.html'" style="margin-left:10px;">R√©glages</button>
        </div>

        <div class="nav-right hidden" id="nav-logged-in">
            <div class="user-info">
                <div class="user-stats">
                    <div><strong id="user-pseudo">Joueur</strong></div>
                    <div>Score Global: <strong id="user-global-score">0</strong></div>
                </div>
                <div class="dropdown">
                    <button class="dropdown-btn">Quiz ‚ñæ</button>
                    <div class="dropdown-content">
                        <span class="dropdown-subtitle">üìç Quiz D√©partements</span>
                        <button class="dropdown-item" data-mode="1">Mode 1 : Nom ‚Üí Num√©ro</button>
                        <button class="dropdown-item" data-mode="2">Mode 2 : Num√©ro ‚Üí Nom</button>
                        <button class="dropdown-item" data-mode="3">Mode 3 : Forme ‚Üí Nom/Num</button>
                        <button class="dropdown-item" data-mode="4">Mode 4 : Pr√©fecture ‚Üí D√©pt</button>
                        <button class="dropdown-item" data-mode="5">Mode 5 : Mix Nom/Num/Pr√©f</button>
                        <button class="dropdown-item" data-mode="6">Mode 6 : Mix Total</button>
                    </div>
                </div>
                <button class="action-btn" onclick="window.location.href='settings.html'" style="margin-left:10px;">R√©glages</button>
                <button class="logout-btn" onclick="logout()">D√©connexion</button>
            </div>
        </div>
    </nav>
</header>

<main>
    <!-- SECTION AUTHENTIFICATION -->
    <section id="auth-section">
        <div class="auth-container">
            <h2 id="auth-title">Connexion</h2>
            <div id="auth-error" class="error-msg hidden"></div>
            
            <form id="auth-form" onsubmit="return false;">
                <div class="form-group" id="pseudo-group" style="display:none;">
                    <label>Pseudo</label>
                    <input type="text" id="auth-pseudo" placeholder="Ton pseudo">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="auth-email" placeholder="ton@email.com" required>
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="auth-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button class="auth-btn" id="auth-submit-btn">Se connecter</button>
            </form>

            <div class="auth-switch">
                <span id="auth-switch-text">Pas encore de compte ? </span>
                <a id="auth-switch-link" onclick="toggleAuthMode()">S'inscrire</a>
            </div>
        </div>
    </section>

    <!-- SECTION ACCUEIL -->
    <section id="home-section" class="hidden">
        <div class="home-center">
            <h2>Bienvenue <span id="welcome-pseudo">Joueur</span> ! üëã</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>üåç Score Global</h3>
                    <div class="stat-value" id="home-global-score">0</div>
                    <div class="level-badge" id="global-level">D√©butant</div>
                </div>
                <div class="stat-card">
                    <h3>üó∫Ô∏è Quiz D√©partements</h3>
                    <div class="stat-value" id="home-dept-score">0</div>
                    <div class="level-badge" id="dept-level">Niveau 1</div>
                </div>
            </div>

            <p style="opacity: 0.8; margin-top: 30px;">S√©lectionne un quiz dans le menu pour commencer !</p>
        </div>

        <!-- CLASSEMENT -->
        <div id="leaderboard-section">
            <div class="leaderboard-container">
                <h2 style="text-align: center;">üèÜ Classement Mondial</h2>
                <div id="leaderboard-list">
                    <div style="text-align: center; opacity: 0.6;">Chargement...</div>
                </div>
            </div>
        </div>
    </section>

    <!-- SECTION QUIZ -->
    <section id="quiz-section" class="hidden">
        <div class="quiz-container">
            <div class="question-box">
                <div id="question"></div>
            </div>
            <div class="answers-container">
                <button class="answer-btn"></button>
                <button class="answer-btn"></button>
                <button class="answer-btn"></button>
                <button class="answer-btn"></button>
                <button class="answer-btn"></button>
            </div>
        </div>

        <div id="timers-container">
            <div id="timer-bar-container">
                <span>‚è±Ô∏è Temps restant : <span id="timer">0</span>s</span>
                <div id="timer-bar"><div id="timer-fill"></div></div>
            </div>
            <div id="question-timer-bar-container">
                <span>‚ö° Question : <span id="question-timer">0</span>s</span>
                <div id="question-timer-bar"><div id="question-timer-fill"></div></div>
            </div>
        </div>

        <div id="score-lives">
            <div>Score : <span id="score">0</span></div>
            <div id="lives">‚ù§‚ù§‚ù§‚ù§‚ù§</div>
        </div>
    </section>

    <!-- SECTION R√âSULTAT -->
    <section id="result-section" class="hidden">
        <h2>Partie termin√©e ! üéâ</h2>
        <div class="result-stats">
            <h3>R√©sum√©</h3>
            <p>Score de la partie : <strong id="final-score">0</strong></p>
            <p>Nouveau score global : <strong id="new-global-score">0</strong></p>
            <p>Score d√©partements : <strong id="new-dept-score">0</strong></p>
            <div id="level-up-msg" class="hidden" style="color: #2ecc71; margin-top: 15px; font-weight: bold;">
                üéä NIVEAU SUP√âRIEUR ATTEINT !
            </div>
        </div>
        <button id="restart-btn" class="action-btn">Rejouer</button>
        <button id="home-btn" class="action-btn">Accueil</button>
    </section>
</main>

<div id="hover-warning"></div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyDytQnPS_ZVbVuTkS8m3iUAOGMgm64A0XE",
  authDomain: "quiz-master-io.firebaseapp.com",
  projectId: "quiz-master-io",
  storageBucket: "quiz-master-io.firebasestorage.app",
  messagingSenderId: "773382469164",
  appId: "1:773382469164:web:5e24a9a62ce543f5190389"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.auth = auth;
window.db = db;
window.currentUser = null;

// D√©partements data
const departements = [
    { nom: "Ain", numero: "01", prefecture: "Bourg-en-Bresse" },
    { nom: "Aisne", numero: "02", prefecture: "Laon" },
    { nom: "Allier", numero: "03", prefecture: "Moulins" },
    { nom: "Alpes-de-Haute-Provence", numero: "04", prefecture: "Digne-les-Bains" },
    { nom: "Hautes-Alpes", numero: "05", prefecture: "Gap" },
    { nom: "Alpes-Maritimes", numero: "06", prefecture: "Nice" },
    { nom: "Ard√®che", numero: "07", prefecture: "Privas" },
    { nom: "Ardennes", numero: "08", prefecture: "Charleville-M√©zi√®res" },
    { nom: "Ari√®ge", numero: "09", prefecture: "Foix" },
    { nom: "Aube", numero: "10", prefecture: "Troyes" },
    { nom: "Aude", numero: "11", prefecture: "Carcassonne" },
    { nom: "Aveyron", numero: "12", prefecture: "Rodez" },
    { nom: "Bouches-du-Rh√¥ne", numero: "13", prefecture: "Marseille" },
    { nom: "Calvados", numero: "14", prefecture: "Caen" },
    { nom: "Cantal", numero: "15", prefecture: "Aurillac" },
    { nom: "Charente", numero: "16", prefecture: "Angoul√™me" },
    { nom: "Charente-Maritime", numero: "17", prefecture: "La Rochelle" },
    { nom: "Cher", numero: "18", prefecture: "Bourges" },
    { nom: "Corr√®ze", numero: "19", prefecture: "Tulle" },
    { nom: "Corse-du-Sud", numero: "2A", prefecture: "Ajaccio" },
    { nom: "Haute-Corse", numero: "2B", prefecture: "Bastia" },
    { nom: "C√¥te-d'Or", numero: "21", prefecture: "Dijon" },
    { nom: "C√¥tes-d'Armor", numero: "22", prefecture: "Saint-Brieuc" },
    { nom: "Creuse", numero: "23", prefecture: "Gu√©ret" },
    { nom: "Dordogne", numero: "24", prefecture: "P√©rigueux" },
    { nom: "Doubs", numero: "25", prefecture: "Besan√ßon" },
    { nom: "Dr√¥me", numero: "26", prefecture: "Valence" },
    { nom: "Eure", numero: "27", prefecture: "√âvreux" },
    { nom: "Eure-et-Loir", numero: "28", prefecture: "Chartres" },
    { nom: "Finist√®re", numero: "29", prefecture: "Quimper" },
    { nom: "Gard", numero: "30", prefecture: "N√Æmes" },
    { nom: "Haute-Garonne", numero: "31", prefecture: "Toulouse" },
    { nom: "Gers", numero: "32", prefecture: "Auch" },
    { nom: "Gironde", numero: "33", prefecture: "Bordeaux" },
    { nom: "H√©rault", numero: "34", prefecture: "Montpellier" },
    { nom: "Ille-et-Vilaine", numero: "35", prefecture: "Rennes" },
    { nom: "Indre", numero: "36", prefecture: "Ch√¢teauroux" },
    { nom: "Indre-et-Loire", numero: "37", prefecture: "Tours" },
    { nom: "Is√®re", numero: "38", prefecture: "Grenoble" },
    { nom: "Jura", numero: "39", prefecture: "Lons-le-Saunier" },
    { nom: "Landes", numero: "40", prefecture: "Mont-de-Marsan" },
    { nom: "Loir-et-Cher", numero: "41", prefecture: "Blois" },
    { nom: "Loire", numero: "42", prefecture: "Saint-√âtienne" },
    { nom: "Haute-Loire", numero: "43", prefecture: "Le Puy-en-Velay" },
    { nom: "Loire-Atlantique", numero: "44", prefecture: "Nantes" },
    { nom: "Loiret", numero: "45", prefecture: "Orl√©ans" },
    { nom: "Lot", numero: "46", prefecture: "Cahors" },
    { nom: "Lot-et-Garonne", numero: "47", prefecture: "Agen" },
    { nom: "Loz√®re", numero: "48", prefecture: "Mende" },
    { nom: "Maine-et-Loire", numero: "49", prefecture: "Angers" },
    { nom: "Manche", numero: "50", prefecture: "Saint-L√¥" },
    { nom: "Marne", numero: "51", prefecture: "Ch√¢lons-en-Champagne" },
    { nom: "Haute-Marne", numero: "52", prefecture: "Chaumont" },
    { nom: "Mayenne", numero: "53", prefecture: "Laval" },
    { nom: "Meurthe-et-Moselle", numero: "54", prefecture: "Nancy" },
    { nom: "Meuse", numero: "55", prefecture: "Bar-le-Duc" },
    { nom: "Morbihan", numero: "56", prefecture: "Vannes" },
    { nom: "Moselle", numero: "57", prefecture: "Metz" },
    { nom: "Ni√®vre", numero: "58", prefecture: "Nevers" },
    { nom: "Nord", numero: "59", prefecture: "Lille" },
    { nom: "Oise", numero: "60", prefecture: "Beauvais" },
    { nom: "Orne", numero: "61", prefecture: "Alen√ßon" },
    { nom: "Pas-de-Calais", numero: "62", prefecture: "Arras" },
    { nom: "Puy-de-D√¥me", numero: "63", prefecture: "Clermont-Ferrand" },
    { nom: "Pyr√©n√©es-Atlantiques", numero: "64", prefecture: "Pau" },
    { nom: "Hautes-Pyr√©n√©es", numero: "65", prefecture: "Tarbes" },
    { nom: "Pyr√©n√©es-Orientales", numero: "66", prefecture: "Perpignan" },
    { nom: "Bas-Rhin", numero: "67", prefecture: "Strasbourg" },
    { nom: "Haut-Rhin", numero: "68", prefecture: "Colmar" },
    { nom: "Rh√¥ne", numero: "69", prefecture: "Lyon" },
    { nom: "Haute-Sa√¥ne", numero: "70", prefecture: "Vesoul" },
    { nom: "Sa√¥ne-et-Loire", numero: "71", prefecture: "M√¢con" },
    { nom: "Sarthe", numero: "72", prefecture: "Le Mans" },
    { nom: "Savoie", numero: "73", prefecture: "Chamb√©ry" },
    { nom: "Haute-Savoie", numero: "74", prefecture: "Annecy" },
    { nom: "Paris", numero: "75", prefecture: "Paris" },
    { nom: "Seine-Maritime", numero: "76", prefecture: "Rouen" },
    { nom: "Seine-et-Marne", numero: "77", prefecture: "Melun" },
    { nom: "Yvelines", numero: "78", prefecture: "Versailles" },
    { nom: "Deux-S√®vres", numero: "79", prefecture: "Niort" },
    { nom: "Somme", numero: "80", prefecture: "Amiens" },
    { nom: "Tarn", numero: "81", prefecture: "Albi" },
    { nom: "Tarn-et-Garonne", numero: "82", prefecture: "Montauban" },
    { nom: "Var", numero: "83", prefecture: "Toulon" },
    { nom: "Vaucluse", numero: "84", prefecture: "Avignon" },
    { nom: "Vend√©e", numero: "85", prefecture: "La Roche-sur-Yon" },
    { nom: "Vienne", numero: "86", prefecture: "Poitiers" },
    { nom: "Haute-Vienne", numero: "87", prefecture: "Limoges" },
    { nom: "Vosges", numero: "88", prefecture: "√âpinal" },
    { nom: "Yonne", numero: "89", prefecture: "Auxerre" },
    { nom: "Territoire de Belfort", numero: "90", prefecture: "Belfort" },
    { nom: "Essonne", numero: "91", prefecture: "√âvry-Courcouronnes" },
    { nom: "Hauts-de-Seine", numero: "92", prefecture: "Nanterre" },
    { nom: "Seine-Saint-Denis", numero: "93", prefecture: "Bobigny" },
    { nom: "Val-de-Marne", numero: "94", prefecture: "Cr√©teil" },
    { nom: "Val-d'Oise", numero: "95", prefecture: "Cergy" },
    { nom: "Guadeloupe", numero: "971", prefecture: "Basse-Terre" },
    { nom: "Martinique", numero: "972", prefecture: "Fort-de-France" },
    { nom: "Guyane", numero: "973", prefecture: "Cayenne" },
    { nom: "La R√©union", numero: "974", prefecture: "Saint-Denis" },
    { nom: "Mayotte", numero: "976", prefecture: "Mamoudzou" }
];

const modes = {
    1: { time: 40, qTime: 4, lives: 5, questionType: "nom_to_num" },
    2: { time: 40, qTime: 4, lives: 5, questionType: "num_to_nom" },
    3: { time: 80, qTime: 8, lives: 8, questionType: "shape_to_nom_num" },
    4: { time: 70, qTime: 7, lives: 7, questionType: "prefecture_to_nom" },
    5: { time: 60, qTime: 4, lives: 6, questionType: "mix_nom_num_prefecture" },
    6: { time: 70, qTime: 4, lives: 7, questionType: "mix_all" }
};

const requiredModeUnlock = { 2: 10, 3: 30, 4: 60, 5: 90, 6: 125 };

let currentMode = 0, score = 0, lives = 0, timeLeft = 0, qTime = 0;
let timerInterval = null, qTimerInterval = null, awaitingNext = false;
let previousQuestions = [];
let correctAnswer;
let isAuthMode = 'login';

// AUTH FUNCTIONS
window.toggleAuthMode = function() {
    isAuthMode = isAuthMode === 'login' ? 'signup' : 'login';
    const title = document.getElementById('auth-title');
    const submitBtn = document.getElementById('auth-submit-btn');
    const switchText = document.getElementById('auth-switch-text');
    const switchLink = document.getElementById('auth-switch-link');
    const pseudoGroup = document.getElementById('pseudo-group');
    
    if (isAuthMode === 'signup') {
        title.textContent = 'Inscription';
        submitBtn.textContent = "S'inscrire";
        switchText.textContent = 'D√©j√† un compte ? ';
        switchLink.textContent = 'Se connecter';
        pseudoGroup.style.display = 'block';
    } else {
        title.textContent = 'Connexion';
        submitBtn.textContent = 'Se connecter';
        switchText.textContent = "Pas encore de compte ? ";
        switchLink.textContent = "S'inscrire";
        pseudoGroup.style.display = 'none';
    }
};

document.getElementById('auth-submit-btn').addEventListener('click', async () => {
    const email = document.getElementById('auth-email').value;
    const password = document.getElementById('auth-password').value;
    const pseudo = document.getElementById('auth-pseudo').value;
    const errorDiv = document.getElementById('auth-error');
    
    errorDiv.classList.add('hidden');
    
    try {
        if (isAuthMode === 'signup') {
            if (!pseudo || pseudo.trim().length < 3) {
                throw new Error('Le pseudo doit contenir au moins 3 caract√®res');
            }
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            
            await setDoc(doc(db, 'users', user.uid), {
                pseudo: pseudo.trim(),
                email: email,
                globalScore: 0,
                quizScores: {
                    departements: 0
                },
                createdAt: new Date().toISOString()
            });
        } else {
            await signInWithEmailAndPassword(auth, email, password);
        }
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
    }
});

window.logout = async function() {
    await signOut(auth);
};

// AUTH STATE OBSERVER
onAuthStateChanged(auth, async (user) => {
    const authSection = document.getElementById('auth-section');
    const homeSection = document.getElementById('home-section');
    const navLoggedOut = document.getElementById('nav-logged-out');
    const navLoggedIn = document.getElementById('nav-logged-in');
    
    if (user) {
        window.currentUser = user;
        authSection.classList.add('hidden');
        homeSection.classList.remove('hidden');
        navLoggedOut.classList.add('hidden');
        navLoggedIn.classList.remove('hidden');
        
        await loadUserData();
        await loadLeaderboard();
    } else {
        window.currentUser = null;
        authSection.classList.remove('hidden');
        homeSection.classList.add('hidden');
        navLoggedOut.classList.remove('hidden');
        navLoggedIn.classList.add('hidden');
    }
});

async function loadUserData() {
    try {
        const userDocRef = doc(db, 'users', currentUser.uid);
        const userDoc = await getDoc(userDocRef);
        
        let userData = userDoc.data();
        
        // Si le profil n'existe pas, le cr√©er
        if (!userData) {
            console.log('Cr√©ation du profil utilisateur manquant...');
            const defaultData = {
                pseudo: currentUser.email.split('@')[0],
                email: currentUser.email,
                globalScore: 0,
                quizScores: {
                    departements: 0
                },
                createdAt: new Date().toISOString()
            };
            await setDoc(userDocRef, defaultData);
            userData = defaultData;
        }
        
        document.getElementById('user-pseudo').textContent = userData.pseudo;
        document.getElementById('welcome-pseudo').textContent = userData.pseudo;
        document.getElementById('user-global-score').textContent = userData.globalScore || 0;
        document.getElementById('home-global-score').textContent = userData.globalScore || 0;
        document.getElementById('home-dept-score').textContent = userData.quizScores?.departements || 0;
        
        // Calculate levels
        const globalLevel = getGlobalLevel(userData.globalScore || 0);
        const deptLevel = getDeptLevel(userData.quizScores?.departements || 0);
        
        document.getElementById('global-level').textContent = globalLevel;
        document.getElementById('dept-level').textContent = deptLevel;
        
        // Update mode buttons based on global score
        updateModeButtons(userData.globalScore || 0);
    } catch (error) {
        console.error('Erreur chargement donn√©es:', error);
        alert('Erreur de chargement. Essayez de vous reconnecter.');
    }
}

function getGlobalLevel(score) {
    if (score >= 500) return 'üèÜ Expert';
    if (score >= 300) return '‚≠ê Avanc√©';
    if (score >= 150) return 'üìö Interm√©diaire';
    if (score >= 50) return 'üå± Apprenti';
    return 'üÜï D√©butant';
}

function getDeptLevel(score) {
    const level = Math.floor(score / 50) + 1;
    return `Niveau ${level}`;
}

function updateModeButtons(globalScore) {
    modeButtons.forEach(btn => {
        const modeNum = parseInt(btn.dataset.mode);
        if (modeNum > 1 && globalScore < requiredModeUnlock[modeNum]) {
            btn.classList.add('disabled');
        } else {
            btn.classList.remove('disabled');
        }
    });
}

async function loadLeaderboard() {
    const leaderboardList = document.getElementById('leaderboard-list');
    leaderboardList.innerHTML = '<div style="text-align: center; opacity: 0.6;">Chargement...</div>';
    
    try {
        const q = query(collection(db, 'users'), orderBy('globalScore', 'desc'), limit(10));
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
            leaderboardList.innerHTML = '<div style="text-align: center; opacity: 0.6;">Aucun joueur pour le moment</div>';
            return;
        }
        
        leaderboardList.innerHTML = '';
        let rank = 1;
        
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            const item = document.createElement('div');
            item.className = 'leaderboard-item';
            
            let medal = '';
            if (rank === 1) medal = 'ü•á';
            else if (rank === 2) medal = 'ü•à';
            else if (rank === 3) medal = 'ü•â';
            
            item.innerHTML = `
                <div class="leaderboard-rank">${medal || rank}</div>
                <div class="leaderboard-name">${data.pseudo}</div>
                <div class="leaderboard-score">${data.globalScore}</div>
            `;
            
            leaderboardList.appendChild(item);
            rank++;
        });
    } catch (error) {
        leaderboardList.innerHTML = '<div style="text-align: center; opacity: 0.6;">Erreur de chargement</div>';
    }
}

// QUIZ LOGIC
const homeSection = document.getElementById('home-section');
const quizSection = document.getElementById('quiz-section');
const resultSection = document.getElementById('result-section');
const modeButtons = document.querySelectorAll('.dropdown-item');
const restartBtn = document.getElementById('restart-btn');
const homeBtn = document.getElementById('home-btn');
const answerBtns = document.querySelectorAll('.answer-btn');
const questionBox = document.getElementById('question');
const scoreDisplay = document.getElementById('score');
const livesDisplay = document.getElementById('lives');
const timerDisplay = document.getElementById('timer');
const qTimerDisplay = document.getElementById('question-timer');
const timerFill = document.getElementById('timer-fill');
const qTimerFill = document.getElementById('question-timer-fill');
const finalScore = document.getElementById('final-score');
const dropdown = document.querySelector('.dropdown');
const dropdownBtn = document.querySelector('.dropdown-btn');

dropdownBtn.addEventListener('click', () => dropdown.classList.toggle('open'));
document.addEventListener('click', (e) => {
    if (!dropdown.contains(e.target)) dropdown.classList.remove('open');
});

modeButtons.forEach(btn => {
    btn.addEventListener('click', async e => {
        e.preventDefault();
        e.stopPropagation();
        
        const selected = parseInt(btn.dataset.mode);
        if (!selected) return;

        try {
            const userDocRef = doc(db, 'users', currentUser.uid);
            const userDoc = await getDoc(userDocRef);
            let userData = userDoc.data();
            
            // Cr√©er le profil si manquant
            if (!userData) {
                const defaultData = {
                    pseudo: currentUser.email.split('@')[0],
                    email: currentUser.email,
                    globalScore: 0,
                    quizScores: { departements: 0 },
                    createdAt: new Date().toISOString()
                };
                await setDoc(userDocRef, defaultData);
                userData = defaultData;
            }
            
            const globalScore = userData.globalScore || 0;
            
            if (selected > 1 && globalScore < requiredModeUnlock[selected]) {
                showHoverWarning(
                    `Vous devez avoir ${requiredModeUnlock[selected]} points globaux pour d√©bloquer ce mode`,
                    e.pageX,
                    e.pageY
                );
                return;
            }

            currentMode = selected;
            dropdown.classList.remove('open');
            startMode();
        } catch (error) {
            console.error('Erreur lors du lancement du mode:', error);
            alert('Erreur lors du chargement. Veuillez r√©essayer.');
        }
    });
});

function showHoverWarning(text, x, y) {
    const warn = document.getElementById("hover-warning");
    warn.textContent = text;
    warn.style.left = (x + 12) + "px";
    warn.style.top = (y + 12) + "px";
    warn.style.opacity = 1;
    setTimeout(() => { warn.style.opacity = 0; }, 1800);
}

function startMode() {
    if (!modes[currentMode]) return;
    stopAllTimers();
    const mode = modes[currentMode];
    score = 0;
    lives = mode.lives;
    timeLeft = mode.time;
    qTime = mode.qTime;
    awaitingNext = false;
    previousQuestions = [];
    updateLives();
    scoreDisplay.textContent = score;
    homeSection.classList.add('hidden');
    resultSection.classList.add('hidden');
    quizSection.classList.remove('hidden');
    generateQuestion();
    startMainTimer();
}

function generateQuestion() {
    if (awaitingNext) return;
    let dep;
    do { dep = departements[Math.floor(Math.random() * departements.length)]; }
    while (previousQuestions.includes(dep.numero) && previousQuestions.length < departements.length);
    previousQuestions.push(dep.numero);
    if (previousQuestions.length > 20) previousQuestions.shift();

    qTime = modes[currentMode].qTime;
    qTimerDisplay.textContent = qTime;
    qTimerFill.style.width = '100%';

    let questionText;
    switch (modes[currentMode].questionType) {
        case "nom_to_num":
            questionText = `Quel est le num√©ro du d√©partement ?<br><span style="font-size:1.4em;">${dep.nom}</span>`;
            correctAnswer = dep.numero;
            break;
        case "num_to_nom":
            questionText = `Quel est le nom du d√©partement ?<br><span style="font-size:1.4em;">${dep.numero}</span>`;
            correctAnswer = dep.nom;
            break;
        case "shape_to_nom_num":
            questionText = `<img src="images/${dep.numero}.png" alt="${dep.nom}" style="width:100%;max-height:200px;">`;
            correctAnswer = Math.random() > 0.5 ? dep.nom : dep.numero;
            break;
        case "prefecture_to_nom":
            questionText = `Dans quel d√©partement se trouve cette pr√©fecture ?<br><span style="font-size:1.4em;">${dep.prefecture}</span>`;
            correctAnswer = dep.nom;
            break;
        case "mix_nom_num_prefecture":
            const randType = Math.random();
            if (randType < 0.33) {
                questionText = `Quel est le num√©ro du d√©partement ?<br><span style="font-size:1.4em;">${dep.nom}</span>`;
                correctAnswer = dep.numero;
            } else if (randType < 0.66) {
                questionText = `Quel est le nom du d√©partement ?<br><span style="font-size:1.4em;">${dep.numero}</span>`;
                correctAnswer = dep.nom;
            } else {
                questionText = `Dans quel d√©partement se trouve cette pr√©fecture ?<br><span style="font-size:1.4em;">${dep.prefecture}</span>`;
                correctAnswer = dep.nom;
            }
            break;
        case "mix_all":
            const allTypes = Math.random();
            if (allTypes < 0.25) {
                questionText = `Quel est le num√©ro du d√©partement ?<br><span style="font-size:1.4em;">${dep.nom}</span>`;
                correctAnswer = dep.numero;
            } else if (allTypes < 0.5) {
                questionText = `Quel est le nom du d√©partement ?<br><span style="font-size:1.4em;">${dep.numero}</span>`;
                correctAnswer = dep.nom;
            } else if (allTypes < 0.75) {
                questionText = `Dans quel d√©partement se trouve cette pr√©fecture ?<br><span style="font-size:1.4em;">${dep.prefecture}</span>`;
                correctAnswer = dep.nom;
            } else {
                questionText = `<img src="images/${dep.numero}.png" alt="${dep.nom}" style="width:100%;max-height:200px;">`;
                correctAnswer = Math.random() > 0.5 ? dep.nom : dep.numero;
            }
            break;
    }
    questionBox.innerHTML = questionText;

    let wrongAnswers = [];
    const otherDeps = departements.filter(d => d !== dep).sort(() => Math.random() - 0.5);
    
    if (modes[currentMode].questionType === "nom_to_num" || (correctAnswer === dep.numero)) {
        wrongAnswers = otherDeps.slice(0, 4).map(d => d.numero);
    } else if (modes[currentMode].questionType === "num_to_nom" || modes[currentMode].questionType === "prefecture_to_nom" || correctAnswer === dep.nom) {
        wrongAnswers = otherDeps.slice(0, 4).map(d => d.nom);
    } else {
        wrongAnswers = otherDeps.slice(0, 4).map(d => Math.random() > 0.5 ? d.nom : d.numero);
    }

    let options = [...wrongAnswers, correctAnswer].sort(() => Math.random() - 0.5);
    answerBtns.forEach((btn, i) => {
        btn.textContent = options[i];
        btn.disabled = false;
        btn.classList.remove("correct", "incorrect");
        btn.onclick = () => handleAnswer(options[i]);
    });
    startQTimer();
}

function handleAnswer(selected) {
    if(awaitingNext) return;
    awaitingNext = true;
    clearInterval(qTimerInterval);
    answerBtns.forEach(btn => {
        btn.disabled = true;
        if(btn.textContent === correctAnswer) btn.classList.add("correct");
        if(btn.textContent === selected && selected !== correctAnswer) btn.classList.add("incorrect");
    });
    if(selected === correctAnswer) score++;
    else 
        if  (lives > 0) lives--;
        else lives = 0;
        updateLives();
    scoreDisplay.textContent = score;
    setTimeout(() => {
        awaitingNext = false;
        if(lives <= 0) endGame();
        else generateQuestion();
    }, 800);
}

function updateLives() {
    const safeLives = Math.max(0, lives);
    const maxLives = modes[currentMode].lives;
    livesDisplay.textContent = '‚ù§'.repeat(safeLives) + '‚ô°'.repeat(Math.max(0, maxLives - safeLives));
}

function startMainTimer() {
    timerDisplay.textContent = timeLeft;
    timerFill.style.width = '100%';
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = timeLeft;
        timerFill.style.width = (timeLeft / modes[currentMode].time * 100) + '%';
        if(timeLeft <= 5) timerFill.style.background='#dc3545';
        else if(timeLeft <= 10) timerFill.style.background='#ffa500';
        else timerFill.style.background='#9c28a7ff';
        if(timeLeft <= 0){ clearInterval(timerInterval); endGame(); }
    },1000);
}

function startQTimer() {
    clearInterval(qTimerInterval);
    qTimerInterval = setInterval(() => {
        qTime -= 0.1;
        qTimerDisplay.textContent = Math.ceil(qTime);
        qTimerFill.style.width = (qTime / modes[currentMode].qTime * 100) + '%';
        if(qTime<=0){ clearInterval(qTimerInterval); if (lives > 0) lives--; updateLives(); handleAnswer(''); }
    }, 100);
}

async function endGame() {
    quizSection.classList.add('hidden');
    resultSection.classList.remove('hidden');
    finalScore.textContent = score;
    stopAllTimers();
    
    try {
        const userDocRef = doc(db, 'users', currentUser.uid);
        const userDoc = await getDoc(userDocRef);
        let userData = userDoc.data();
        
        // Cr√©er le profil si manquant
        if (!userData) {
            userData = {
                pseudo: currentUser.email.split('@')[0],
                email: currentUser.email,
                globalScore: 0,
                quizScores: { departements: 0 },
                createdAt: new Date().toISOString()
            };
            await setDoc(userDocRef, userData);
        }
        
        const oldGlobalScore = userData.globalScore || 0;
        const oldDeptScore = userData.quizScores?.departements || 0;
        
        const newGlobalScore = oldGlobalScore + score;
        const newDeptScore = oldDeptScore + score;
        
        await updateDoc(userDocRef, {
            globalScore: newGlobalScore,
            'quizScores.departements': newDeptScore
        });
        
        // Update all displays
        document.getElementById('new-global-score').textContent = newGlobalScore;
        document.getElementById('new-dept-score').textContent = newDeptScore;
        document.getElementById('user-global-score').textContent = newGlobalScore;
        document.getElementById('home-global-score').textContent = newGlobalScore;
        document.getElementById('home-dept-score').textContent = newDeptScore;
        
        // Update levels
        document.getElementById('global-level').textContent = getGlobalLevel(newGlobalScore);
        document.getElementById('dept-level').textContent = getDeptLevel(newDeptScore);
        
        // Update mode buttons
        updateModeButtons(newGlobalScore);
        
        const oldLevel = Math.floor(oldDeptScore / 50);
        const newLevel = Math.floor(newDeptScore / 50);
        
        if (newLevel > oldLevel) {
            document.getElementById('level-up-msg').classList.remove('hidden');
        } else {
            document.getElementById('level-up-msg').classList.add('hidden');
        }
        
        await loadLeaderboard();
    } catch (error) {
        console.error('Erreur sauvegarde scores:', error);
        alert('Erreur lors de la sauvegarde des scores. V√©rifiez votre connexion.');
    }
}

function stopAllTimers() {
    clearInterval(timerInterval);
    clearInterval(qTimerInterval);
}

restartBtn.onclick = startMode;
homeBtn.onclick = async () => {
    stopAllTimers();
    quizSection.classList.add('hidden');
    resultSection.classList.add('hidden');
    homeSection.classList.remove('hidden');
    await loadUserData();
};

</script>

</body>
</html>