<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quiz Master - Math√©matiques</title>
    <style>
        /* === Style global === */
        body {
            background: linear-gradient(135deg, #0f1115, #1c1c24);
            color: #f0f0f0;
            font-family: 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
        }

        .navbar {
            background: #1a1a24;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .nav-title {
            font-size: 1.2em;
            font-weight: 600;
        }

        .nav-right {
            display: flex;
            gap: 10px;
        }

        .center {
            max-width: 1000px;
            margin: 40px auto;
            background: #23233a;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        h1 {
            text-align: center;
            margin-bottom: 6px;
        }

        .subtitle {
            text-align: center;
            color: #aaa;
            margin-bottom: 18px;
            font-size: 1.05em;
        }

        .action-btn {
            padding: 10px 18px;
            border-radius: 10px;
            background: #3a3a50;
            border: none;
            cursor: pointer;
            color: #f0f0f0;
            transition: 0.20s;
            font-size: 0.98em;
        }

        .action-btn:hover {
            background: #4e4e6a;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 28px;
            font-size: 1.1em;
            color: #aaa;
        }

        /* Timers */
        #timers-container {
            margin-bottom: 18px;
        }

        .timer-bar-wrapper {
            margin-bottom: 8px;
        }

        .timer-label {
            font-size: 0.9em;
            color: #ddd;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timer-bar {
            width: 100%;
            height: 12px;
            background-color: #2a2a3a;
            border-radius: 6px;
            overflow: hidden;
        }

        #timer-fill {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
            transition: width 0.3s linear;
        }

        #question-timer-fill {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            transition: width 0.3s linear;
        }

        /* Quiz layout */
        #quiz-main {
            display: none;
        }

        #quiz-content {
            display: flex;
            gap: 20px;
            margin-bottom: 18px;
        }

        /* Question √† gauche */
        .question-box {
            flex: 1;
            background: #2a2a3a;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .question-text {
            font-size: 1.25em;
            line-height: 1.4;
            text-align: center;
        }

        /* R√©ponses √† droite */
        .answers-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .answer-btn {
            width: 100%;
            padding: 14px 16px;
            border-radius: 10px;
            background: #3a3a50;
            border: none;
            cursor: pointer;
            color: #f0f0f0;
            font-size: 0.95em;
            text-align: left;
            transition: transform .12s, background .12s;
        }

        .answer-btn:hover:not(:disabled) {
            transform: translateX(5px);
            background: #4e4e6a;
        }

        .answer-btn:disabled {
            opacity: 0.85;
            cursor: default;
            transform: none;
        }

        .stats {
            margin: 12px 0;
            display: flex;
            justify-content: space-between;
            gap: 12px;
            font-size: 1.05em;
        }

        .stats div {
            flex: 1;
            text-align: center;
            font-weight: 600;
            background: #2a2a3a;
            padding: 10px;
            border-radius: 8px;
        }

        #quiz-next-btn,
        #quiz-restart-btn {
            display: none;
            width: 100%;
            margin-top: 6px;
        }

        #quiz-result {
            display: none;
            text-align: center;
        }

        .final-score {
            font-size: 1.8em;
            color: #2ecc71;
            margin: 12px 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            #quiz-content {
                flex-direction: column;
            }

            .question-box {
                min-height: 150px;
            }
        }
    </style>
</head>

<body>
    <header>
        <nav class="navbar">
            <div class="nav-left"><span class="nav-title">üè• Quiz Master - Math√©matiques</span></div>
            <div class="nav-right">
                <button class="action-btn" onclick="window.location.href='index.html'">‚Üê Retour</button>
                <button class="action-btn" onclick="window.location.href='settings.html'">R√©glages</button>
            </div>
        </nav>
    </header>

    <div class="center">
        <div id="loading" class="loading">
            <p>Chargement du quiz‚Ä¶</p>
        </div>

        <!-- Quiz main -->
        <div id="quiz-main">
            <h1 id="quiz-title">Quiz Math√©matiques</h1>
            <p class="subtitle" id="quiz-subtitle"></p>

            <!-- Timers -->
            <div id="timers-container">
                <div class="timer-bar-wrapper">
                    <div class="timer-label">
                        <span>‚è±Ô∏è Temps restant</span>
                        <strong id="timer">0:00</strong>
                    </div>
                    <div class="timer-bar">
                        <div id="timer-fill"></div>
                    </div>
                </div>
                <div class="timer-bar-wrapper">
                    <div class="timer-label">
                        <span>‚ö° Question</span>
                        <strong id="question-timer">0s</strong>
                    </div>
                    <div class="timer-bar">
                        <div id="question-timer-fill"></div>
                    </div>
                </div>
            </div>

            <!-- Question + R√©ponses c√¥te √† c√¥te -->
            <div id="quiz-content">
                <div class="question-box">
                    <div id="quiz-question" class="question-text"></div>
                </div>
                <div class="answers-container" id="quiz-answers"></div>
            </div>

            <div class="stats">
                <div>Score : <span id="quiz-score">0</span></div>
                <div>Vies : <span id="quiz-lives">‚ù§‚ù§‚ù§</span></div>
                <div>Question : <span id="quiz-index">0</span>/<span id="quiz-total">0</span></div>
            </div>

            <button class="action-btn" id="quiz-next-btn">Question suivante</button>
            <button class="action-btn" id="quiz-restart-btn">Recommencer ce niveau</button>
        </div>

        <!-- Result -->
        <div id="quiz-result">
            <h1>üéâ Quiz termin√© !</h1>
            <div class="final-score">Score : <span id="quiz-final-score">0</span></div>
            <p id="result-message" style="font-size: 1.05em; margin: 8px 0 16px 0;"></p>

            <button class="action-btn" onclick="window.location.href='index.html'"
                style="width: 100%; margin-top: 8px;">Retour au menu principal</button>
            <button class="action-btn" id="retry-btn" style="width: 100%; margin-top: 10px;">Recommencer ce
                niveau</button>
        </div>
    </div>

    <script type="module">
        // ==========================================
        // DONN√âES DES QUIZ
        // ==========================================
        const quizData = {
            1: {
                title: "Niveau 1 : Addition et Soustraction",
                subtitle: "Simple additions et soustractions.",
                time: 300,
                qTime: 20,
                lives: 3,
                questions: [
                    { q: "5 + 3 = ?", a: "8", opts: ["7", "8", "9", "10"] },
                    { q: "12 - 7 = ?", a: "5", opts: ["4", "5", "6", "7"] },
                    { q: "8 + 6 = ?", a: "14", opts: ["13", "14", "15", "16"] },
                    { q: "10 - 4 = ?", a: "6", opts: ["5", "6", "7", "8"] },
                    { q: "9 + 2 = ?", a: "11", opts: ["10", "11", "12", "13"] }
                ]
            },
            2: {
                title: "Niveau 2 : Multiplication et Division",
                subtitle: "Multiplications et divisions simples.",
                time: 300,
                qTime: 25,
                lives: 4,
                questions: [
                    { q: "4 * 6 = ?", a: "24", opts: ["22", "23", "24", "25"] },
                    { q: "21 / 7 = ?", a: "3", opts: ["2", "3", "4", "5"] },
                    { q: "9 * 8 = ?", a: "72", opts: ["68", "70", "72", "74"] },
                    { q: "32 / 8 = ?", a: "4", opts: ["3", "4", "5", "6"] },
                    { q: "15 * 2 = ?", a: "30", opts: ["28", "29", "30", "31"] }
                ]
            },
            3: {
                title: "Niveau 3 : Probl√®mes Simples",
                subtitle: "Probl√®mes simples en utilisant les op√©rations de base.",
                time: 400,
                qTime: 30,
                lives: 5,
                questions: [
                    { q: "Si tu as 12 pommes et tu donnes 5 √† un ami, combien en a-tu maintenant ?", a: "7", opts: ["6", "7", "8", "9"] },
                    { q: "Combien vaut 3 * 4 + 2 ?", a: "14", opts: ["12", "13", "14", "15"] },
                    { q: "Si une balle co√ªte 2 euros, combien co√ªtent 7 balles ?", a: "14", opts: ["12", "13", "14", "15"] },
                    { q: "Combien vaut 100 / 10 - 5 ?", a: "5", opts: ["4", "5", "6", "7"] },
                    { q: "Si tu as 25 bonbons et tu en donnes √† tes amis jusqu'√† ce que tu n'aies plus que 8, combien as-tu donn√© ?", a: "17", opts: ["16", "17", "18", "19"] }
                ]
            },
            4: {
                title: "Niveau 4 : Th√©or√®me de Pythagore",
                subtitle: "Utilisation du th√©or√®me de Pythagore pour calculer des longueurs.",
                time: 500,
                qTime: 35,
                lives: 6,
                questions: [
                    { q: "Dans un triangle rectangle ABC, AB = 3 cm, AC = 4 cm. Quelle est la longueur de BC ?", a: "5", opts: ["4", "5", "6", "7"] },
                    { q: "Si le c√¥t√© hypot√©nuse d'un triangle rectangle mesure 10 cm et l'un des c√¥t√©s mesure 6 cm, quelle est la longueur du second c√¥t√© ?", a: "8", opts: ["7", "8", "9", "10"] },
                    { q: "Calculer l'hypot√©nuse d'un triangle rectangle dont les deux autres c√¥t√©s mesurent 5 cm et 12 cm.", a: "13", opts: ["11", "12", "13", "14"] },
                    { q: "Dans un triangle rectangle, AB = 7 cm, AC = 24 cm. Quelle est la longueur de BC ?", a: "25", opts: ["23", "24", "25", "26"] },
                    { q: "Si le c√¥t√© hypot√©nuse d'un triangle rectangle mesure 15 cm et l'un des c√¥t√©s mesure 9 cm, quelle est la longueur du second c√¥t√© ?", a: "12", opts: ["10", "11", "12", "13"] }
                ]
            },
            5: {
                title: "Niveau 5 : Th√©or√®me de Thales",
                subtitle: "Utilisation du th√©or√®me de Thales pour calculer des longueurs.",
                time: 600,
                qTime: 40,
                lives: 7,
                questions: [
                    { q: "Dans un triangle ABC, D est sur AB et E est sur AC tels que DE // BC. Si AD = 3 cm, DB = 5 cm, AE = 4 cm. Quelle est la longueur EC ?", a: "6", opts: ["5", "6", "7", "8"] },
                    { q: "Dans un triangle ABC, D est sur AB et E est sur AC tels que DE // BC. Si AD = 2 cm, DB = 6 cm, AE = 3 cm. Quelle est la longueur EC ?", a: "9", opts: ["8", "9", "10", "11"] },
                    { q: "Dans un triangle ABC, D est sur AB et E est sur AC tels que DE // BC. Si AD = 4 cm, DB = 6 cm, AE = 5 cm. Quelle est la longueur EC ?", a: "7.5", opts: ["7", "7.5", "8", "8.5"] },
                    { q: "Dans un triangle ABC, D est sur AB et E est sur AC tels que DE // BC. Si AD = 5 cm, DB = 10 cm, AE = 6 cm. Quelle est la longueur EC ?", a: "12", opts: ["10", "11", "12", "13"] },
                    { q: "Dans un triangle ABC, D est sur AB et E est sur AC tels que DE // BC. Si AD = 6 cm, DB = 9 cm, AE = 8 cm. Quelle est la longueur EC ?", a: "12", opts: ["10", "11", "12", "13"] }
                ]
            },
        };

        // ==========================================
        // CONSTANTES
        // ==========================================
        let TOTAL_TIME_SECONDS = 300;
        let QUESTION_TIME_SECONDS = 20;
        let INITIAL_LIVES = 3;

        // ==========================================
        // VARIABLES D'√âTAT
        // ==========================================
        let currentLevel = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let lives = INITIAL_LIVES;
        let answered = false;
        let globalTimerInterval = null;
        let questionTimerInterval = null;
        let globalTimeRemaining = 0;
        let questionTimeRemaining = 0;

        // ==========================================
        // √âL√âMENTS DOM
        // ==========================================
        const loadingEl = document.getElementById('loading');
        const timersContainer = document.getElementById('timers-container');
        const quizMain = document.getElementById('quiz-main');
        const quizResult = document.getElementById('quiz-result');
        const quizTitle = document.getElementById('quiz-title');
        const quizSubtitle = document.getElementById('quiz-subtitle');
        const quizQuestion = document.getElementById('quiz-question');
        const quizAnswers = document.getElementById('quiz-answers');
        const quizScore = document.getElementById('quiz-score');
        const quizLives = document.getElementById('quiz-lives');
        const quizIndex = document.getElementById('quiz-index');
        const quizTotal = document.getElementById('quiz-total');
        const quizNextBtn = document.getElementById('quiz-next-btn');
        const quizRestartBtn = document.getElementById('quiz-restart-btn');
        const quizFinalScore = document.getElementById('quiz-final-score');
        const resultMessage = document.getElementById('result-message');
        const retryBtn = document.getElementById('retry-btn');
        const timerDisplay = document.getElementById('timer');
        const questionTimerDisplay = document.getElementById('question-timer');
        const timerFill = document.getElementById('timer-fill');
        const questionTimerFill = document.getElementById('question-timer-fill');

        // ==========================================
        // GESTION DES TIMERS
        // ==========================================
        function startGlobalTimer() {
            clearInterval(globalTimerInterval);
            globalTimeRemaining = TOTAL_TIME_SECONDS;
            updateGlobalTimerDisplay();

            globalTimerInterval = setInterval(() => {
                globalTimeRemaining--;
                updateGlobalTimerDisplay();

                if (globalTimeRemaining <= 0) {
                    clearInterval(globalTimerInterval);
                    endQuiz(true);
                }
            }, 1000);
        }

        function updateGlobalTimerDisplay() {
            const minutes = Math.floor(globalTimeRemaining / 60);
            const seconds = globalTimeRemaining % 60;
            timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            const percent = ((TOTAL_TIME_SECONDS - globalTimeRemaining) / TOTAL_TIME_SECONDS) * 100;
            timerFill.style.width = percent + '%';
        }

        function startQuestionTimer() {
            clearInterval(questionTimerInterval);
            questionTimeRemaining = QUESTION_TIME_SECONDS;
            updateQuestionTimerDisplay();

            questionTimerInterval = setInterval(() => {
                questionTimeRemaining--;
                updateQuestionTimerDisplay();

                if (questionTimeRemaining <= 0) {
                    clearInterval(questionTimerInterval);
                    handleQuestionTimeout();
                }
            }, 1000);
        }

        function updateQuestionTimerDisplay() {
            questionTimerDisplay.textContent = questionTimeRemaining + 's';
            const percent = ((QUESTION_TIME_SECONDS - questionTimeRemaining) / QUESTION_TIME_SECONDS) * 100;
            questionTimerFill.style.width = percent + '%';
        }

        function stopQuestionTimer() {
            clearInterval(questionTimerInterval);
            questionTimerFill.style.width = '0%';
        }

        function stopAllTimers() {
            clearInterval(globalTimerInterval);
            clearInterval(questionTimerInterval);
        }

        // ==========================================
        // GESTION DU QUIZ
        // ==========================================
        function initQuiz() {
            const hash = window.location.hash.replace('#', '');
            const level = parseInt(hash, 10);

            if (!level || !quizData[level]) {
                window.location.href = 'index.html';
                return;
            }

            currentLevel = level;
            const data = quizData[level];

            // Configuration
            TOTAL_TIME_SECONDS = data.time;
            QUESTION_TIME_SECONDS = data.qTime;
            INITIAL_LIVES = data.lives;

            quizTitle.textContent = data.title;
            quizSubtitle.textContent = data.subtitle;
            questions = [...data.questions].sort(() => Math.random() - 0.5);
            currentQuestionIndex = 0;
            score = 0;
            lives = INITIAL_LIVES;
            answered = false;

            // Affichage
            loadingEl.style.display = 'none';
            quizMain.style.display = 'block';
            quizResult.style.display = 'none';

            updateStats();
            showQuestion();
            startGlobalTimer();
        }

        function showQuestion() {
            stopQuestionTimer();

            if (currentQuestionIndex >= questions.length || lives <= 0) {
                endQuiz(false);
                return;
            }

            answered = false;
            quizNextBtn.style.display = 'none';
            quizRestartBtn.style.display = 'none';

            const question = questions[currentQuestionIndex];
            quizQuestion.innerHTML = question.q;

            // S√©parer la bonne r√©ponse des mauvaises r√©ponses
            const correctAnswer = question.a;
            const wrongAnswers = question.opts.filter(opt => opt !== correctAnswer);

            // Tirer 4 mauvaises r√©ponses al√©atoires
            const selectedWrongAnswers = wrongAnswers
                .sort(() => Math.random() - 0.5)
                .slice(0, 4);

            // Combiner et m√©langer la bonne r√©ponse avec les 4 mauvaises
            const options = [...selectedWrongAnswers, correctAnswer].sort(() => Math.random() - 0.5);

            // Afficher les 5 options
            quizAnswers.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = opt;
                btn.disabled = false;
                btn.onclick = () => selectAnswer(opt, correctAnswer);
                quizAnswers.appendChild(btn);
            });

            // Mise √† jour compteurs
            quizIndex.textContent = currentQuestionIndex + 1;
            quizTotal.textContent = questions.length;

            startQuestionTimer();
        }

        function selectAnswer(selected, correct) {
            if (answered) return;
            answered = true;
            stopQuestionTimer();

            // Colorisation des r√©ponses
            Array.from(quizAnswers.children).forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === correct) {
                    btn.style.background = '#2ecc71';
                } else if (btn.textContent === selected) {
                    btn.style.background = '#e74c3c';
                }
            });

            // Mise √† jour score/vies
            if (selected === correct) {
                score++;
            } else {
                lives--;
            }

            updateStats();
            showNextButton();
        }

        function handleQuestionTimeout() {
            if (answered) return;
            answered = true;

            const question = questions[currentQuestionIndex];

            // R√©v√©ler la bonne r√©ponse
            Array.from(quizAnswers.children).forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === question.a) {
                    btn.style.background = '#2ecc71';
                }
            });

            lives--;
            updateStats();
            showNextButton();
        }

        function showNextButton() {
            // Passage automatique apr√®s 800ms
            setTimeout(() => {
                if (lives > 0 && currentQuestionIndex < questions.length - 1) {
                    currentQuestionIndex++;
                    showQuestion();
                } else {
                    endQuiz(false);
                }
            }, 800);
        }

        function updateStats() {
            quizScore.textContent = score;
            quizLives.textContent = '‚ù§'.repeat(Math.max(0, lives)) + '‚ô°'.repeat(Math.max(0, INITIAL_LIVES - lives));
        }

        function updateGlobalScore(points) {
            try {
                let globalScore = parseInt(localStorage.getItem('globalScore') || '0', 10);
                globalScore += points;
                localStorage.setItem('globalScore', globalScore.toString());
                console.log(`‚úÖ Score global mis √† jour : +${points} ‚Üí ${globalScore}`);
                return globalScore;
            } catch (error) {
                console.error('‚ùå Erreur mise √† jour globalScore:', error);
                return 0;
            }
        }

        function endQuiz(timeout = false) {
            stopAllTimers();

            // Mise √† jour du score global
            const newGlobalScore = updateGlobalScore(score);

            quizMain.style.display = 'none';
            quizResult.style.display = 'block';

            quizFinalScore.textContent = score + ' / ' + questions.length;

            // Message personnalis√©
            if (timeout) {
                resultMessage.textContent = '‚è≥ Temps √©coul√© ! Essayez encore ‚Äî vous pouvez recommencer le niveau.';
            } else {
                const percentage = questions.length > 0 ? (score / questions.length) * 100 : 0;
                if (percentage === 100) {
                    resultMessage.textContent = `üèÜ Parfait ! Vous ma√Ætrisez ce niveau ! Score global : ${newGlobalScore}`;
                } else if (percentage >= 80) {
                    resultMessage.textContent = `üëè Excellent travail ! Score global : ${newGlobalScore}`;
                } else if (percentage >= 60) {
                    resultMessage.textContent = `üëç Bon travail ! Score global : ${newGlobalScore}`;
                } else {
                    resultMessage.textContent = `üí™ Continuez √† pratiquer ! Score global : ${newGlobalScore}`;
                }
            }
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        quizNextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            showQuestion();
        });

        quizRestartBtn.addEventListener('click', () => {
            stopAllTimers();
            initQuiz();
        });

        retryBtn.addEventListener('click', () => {
            stopAllTimers();
            initQuiz();
        });

        window.addEventListener('hashchange', () => {
            stopAllTimers();
            initQuiz();
        });

        // ==========================================
        // D√âMARRAGE
        // ==========================================
        window.addEventListener('load', initQuiz);
    </script>
</body>

</html>
