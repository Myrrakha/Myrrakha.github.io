<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Quiz Master - Chinois N5</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .hidden {
            display: none !important;
        }
        /* GLOBAL */
        body {
            margin: 0;
            padding: 0;
            font-family: "Noto Serif SC", serif;
            background: linear-gradient(145deg, #fff7ef, #fde3d0);
            background-image: url('images/cloud-pattern.png');
            background-size: cover;
            color: #2a2a2a;
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
            opacity: 0.98;
        }
        .lanterne {
            width: 60px;
            height: 90px;
            background-image: url('images/red-lantern.png');
            background-size: cover;
            position: absolute;
            top: -20px;
            animation: flotter 3.5s ease-in-out infinite alternate;
            filter: drop-shadow(0 0 6px rgba(255, 80, 0, 0.8));
            z-index: -1;
        }
        .lanterne:nth-child(1) {
            left: 15%;
            animation-delay: 0s;
        }
        .lanterne:nth-child(2) {
            right: 15%;
            animation-delay: 1.2s;
        }
        @keyframes flotter {
            0% {
                transform: translateY(0) rotate(-2deg);
                opacity: 0.95;
            }
            100% {
                transform: translateY(12px) rotate(2deg);
                opacity: 1;
            }
        }
        #hover-warning {
            position: absolute;
            padding: 8px 14px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            font-size: 14px;
            border-radius: 6px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: 9999;
        }
        /* ‚ú® CENTRAGE PRINCIPAL */
        main {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100%;
            padding: 0 15px;
            box-sizing: border-box;
            position: relative;
        }
        /* GAME SECTION */
        #game-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 1200px;
        }
        #game-container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
        }
        #scene {
            background-image: url('images/chinese-night-street2.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            width: 100%;
            max-width: 1200px;
            height: 650px;
            position: relative;
            border-radius: 14px;
            box-shadow: 0 0 16px rgba(255, 60, 60, 0.2);
            border: 2px solid rgba(180, 0, 0, 0.2);
            overflow: hidden;
            margin: 10px auto;
        }
        #lantern-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .lantern-hitbox {
            position: absolute;
            cursor: pointer;
            pointer-events: auto;
            z-index: 10;
            transform: translate(-50%, -50%);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .debug-mode .lantern-hitbox {
            border: 2px dashed rgba(255, 0, 0, 0.7);
            background: rgba(0, 255, 255, 0.2);
        }
        .lantern-number {
            position: absolute;
            font-family: "Noto Serif SC", serif;
            font-weight: 700;
            font-size: 24px;
            color: #f8f4e9;
            text-shadow: 0 0 4px rgba(255, 255, 255, 0.8);
            z-index: 11;
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        .lantern-hitbox.glow .lantern-number,
        .lantern-hitbox.lit .lantern-number {
            opacity: 1;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.9);
        }
        .debug-mode .lantern-number {
            color: red;
            text-shadow: none;
        }
        #timers-container {
            width: 100%;
            max-width: 1000px;
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        #timer-bar-container {
            width: 100%;
            max-width: 310px;
            text-align: left;
            font-size: 0.9em;
            color: #b40000;
            font-weight: 600;
        }
        #timer-bar {
            width: 100%;
            height: 10px;
            background: #fde3d0;
            border-radius: 7px;
            margin-top: 5px;
            overflow: hidden;
            border: 1px solid rgba(180, 0, 0, 0.2);
        }
        #timer-fill {
            height: 100%;
            width: 100%;
            border-radius: 7px;
            transition: width 0.3s linear;
            background: linear-gradient(90deg, #b40000, #ff4d2e, #ff9b00);
        }
        #lives-container {
            margin-top: 12px;
            display: flex;
            justify-content: center;
            gap: 8px;
        }
        .heart {
            font-size: 28px;
            margin: 0 3px;
            color: #d35949;
            text-shadow: 0 0 4px rgba(211, 89, 73, 0.6);
        }
        .heart.empty {
            color: #b40000;
            text-shadow: 0 0 4px rgba(180, 0, 0, 0.4);
        }
        @media (max-width: 899px) {
            #scene {
                height: 500px;
                max-width: 100%;
            }
            #mobile-quiz-ui-row {
                display: flex;
                gap: 8px;
                justify-content: center;
                margin-top: 8px;
                padding: 0 15px;
                width: 100%;
                max-width: 1200px;
            }
            #mobile-back-container {
                background: rgba(255, 250, 240, 0.85);
                padding: 12px 10px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.2);
                border: 2px solid rgba(180, 0, 0, 0.15);
                min-width: 44px;
                height: fit-content;
            }
            #mobile-back-container .action-btn {
                padding: 5px 9px;
                font-size: 1.1em;
                display: block;
                width: 100%;
                text-align: center;
                background: rgba(255, 240, 230, 0.9);
                border-radius: 9px;
                cursor: pointer;
                transition: .2s;
                border: 2px solid rgba(180, 0, 0, 0.2);
                color: #b40000;
                font-family: "Noto Serif SC", serif;
            }
            #mobile-back-container .action-btn:hover {
                background: rgba(255, 230, 220, 0.95);
                box-shadow: 0 0 8px rgba(255, 100, 80, 0.3);
            }
        }
        @media (min-width: 900px) {
            #mobile-quiz-ui-row {
                display: none !important;
            }
            #mobile-back-btn {
                display: none !important;
            }
        }
        /* RESULT SECTION */
        #result-section {
            text-align: center;
            padding: 16px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 1200px;
        }
        .result-stats {
            background: rgba(255, 250, 240, 0.95);
            backdrop-filter: blur(8px);
            padding: 22px;
            border-radius: 14px;
            max-width: 480px;
            margin: 22px auto;
            box-shadow: 0 0 16px rgba(255, 60, 60, 0.2);
            border: 2px solid rgba(180, 0, 0, 0.2);
            width: calc(100% - 30px);
        }
        .result-stats h3 {
            color: #b40000;
            margin-top: 0;
            font-weight: 700;
            letter-spacing: 0.8px;
            text-shadow: 0 0 5px rgba(200, 0, 0, 0.4);
            font-family: "Noto Serif SC", serif;
        }
        .action-btn {
            margin: 8px;
            padding: 10px 20px;
            border-radius: 10px;
            background: linear-gradient(145deg, #ffecd9, #f2c19b);
            border: 2px solid rgba(180, 0, 0, 0.2);
            cursor: pointer;
            color: #b40000;
            transition: 0.2s;
            font-family: "Noto Serif SC", serif;
            font-size: 15px;
            font-weight: 600;
        }
        .action-btn:hover {
            background: linear-gradient(145deg, #fde3d0, #ffb380);
            box-shadow: 0 0 8px rgba(255, 100, 80, 0.3);
            transform: translateY(-1px);
        }
        /* Unlock Message */
        #level-unlock-msg {
            color: #9bc24f;
            margin-top: 12px;
            font-weight: bold;
            display: none;
            text-shadow: 0 0 5px rgba(155, 194, 79, 0.4);
            font-family: "Noto Serif SC", serif;
        }
        #level-up-msg,
        #perfect-score-msg {
            font-family: "Noto Serif SC", serif;
        }
    </style>
</head>
<body>
    <div class="lanterne"></div>
    <div class="lanterne"></div>
    <main>
        <section id="game-section" class="hidden">
            <div id="game-container">
                <div id="scene">
                    <div id="lantern-container"></div>
                </div>
            </div>
            <div id="timers-container">
                <div id="timer-bar-container">
                    <span>‚è±Ô∏è Temps restant : <span id="timer">0</span>s</span>
                    <div id="timer-bar">
                        <div id="timer-fill"></div>
                    </div>
                </div>
            </div>
            <div id="lives-container">
                <span class="heart">‚ù§</span>
                <span class="heart">‚ù§</span>
                <span class="heart">‚ù§</span>
                <span class="heart">‚ù§</span>
                <span class="heart">‚ù§</span>
            </div>
            <div id="mobile-quiz-ui-row">
                <div id="mobile-back-container">
                    <button id="mobile-back-btn" class="action-btn">‚Üê</button>
                </div>
            </div>
        </section>
        <section id="result-section" class="hidden">
            <h2>Partie termin√©e ! üéâ</h2>
            <div class="result-stats">
                <h3>R√©sultat</h3>
                <p id="game-result-message"></p>
                <p>Temps restant : <strong id="remaining-time">0</strong> secondes</p>
                <div id="level-up-msg" class="hidden" style="color: #9bc24f; margin-top: 12px; font-weight: bold;">
                    üéä NIVEAU SUP√âRIEUR ATTEINT !
                </div>
                <div id="perfect-score-msg" class="hidden" style="color: #d4af37; margin-top: 10px; font-weight: bold;">
                    üåü SCORE PARFAIT !
                </div>
                <div id="level-unlock-msg">üîì Niveau 6 d√©bloqu√© !</div>
            </div>
            <button id="restart-btn" class="action-btn">Rejouer</button>
            <button id="home-btn" class="action-btn">Accueil</button>
        </section>
    </main>
    <div id="hover-warning"></div>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import {
            getAuth, onAuthStateChanged, signOut
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import {
            getFirestore, doc, updateDoc, increment, runTransaction, getDoc
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        // üîë CONFIGURATION
        const THEME = 'chinois';
        const QUIZ_TITLE = 'Chinois N5';
        const DEBUG_MODE = false; // Mettre √† false en production
        // üåê Firebase init
        const firebaseConfig = {
            apiKey: "AIzaSyDytQnPS_ZVbVuTkS8m3iUAOGMgm64A0XE",
            authDomain: "quiz-master-io.firebaseapp.com",
            projectId: "quiz-master-io",
            storageBucket: "quiz-master-io.firebasestorage.app",
            messagingSenderId: "773382469164",
            appId: "1:773382469164:web:5e24a9a62ce543f5190389"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        window.currentUser = null;
        // ‚úÖ DOM
        const gameSection = document.getElementById('game-section');
        const resultSection = document.getElementById('result-section');
        const timerDisplay = document.getElementById('timer');
        const timerFill = document.getElementById('timer-fill');
        const mobileBackBtn = document.getElementById('mobile-back-btn');
        const restartBtn = document.getElementById('restart-btn');
        const homeBtn = document.getElementById('home-btn');
        const levelUnlockMsg = document.getElementById('level-unlock-msg');
        const levelUpMsg = document.getElementById('level-up-msg');
        const perfectScoreMsg = document.getElementById('perfect-score-msg');
        const livesContainer = document.getElementById('lives-container');
        const gameResultMessage = document.getElementById('game-result-message');
        const remainingTimeDisplay = document.getElementById('remaining-time');
        // üîß DEBUG MODE - Ajoute une classe pour visualiser les hitboxes
        if (DEBUG_MODE) {
            document.body.classList.add('debug-mode');
        }
        // ‚úÖ √âtats du jeu
        let timeLeft = 0;
        let timerInterval = null;
        let gameCompleted = false;
        let nextExpectedNumber = 0;
        let lives = 5;
        let wrongAnswers = 0;
        
        // Chiffres chinois
        const chineseNumbers = ["Èõ∂", "‰∏Ä", "‰∫å", "‰∏â", "Âõõ", "‰∫î", "ÂÖ≠", "‰∏É", "ÂÖ´", "‰πù", "ÂçÅ"];
        
        // ‚è±Ô∏è Config du niveau
        const levelConfig = {
            time: 60,
            lives: 5
        };
        
        // üîß Positions et tailles des hitboxes
        const lanterns = [
            { id: "ling", value: 0, top: "54%", left: "40%", width: "3%", height: "4%" }, // Èõ∂ (centre)    
            { id: "yi", value: 1, top: "56.5%", left: "61.5%", width: "1.65%", height: "2.85%" },   // ‰∏Ä  ‚úÖ  
            { id: "er", value: 2, top: "48%", left: "72.5%", width: "6%", height: "8%" },   // ‰∫å    ‚úÖ
            { id: "san", value: 3, top: "44.1%", left: "14%", width: "8%", height: "9%" },  // ‰∏â   ‚úÖ
            { id: "si", value: 4, top: "55%", left: "44.5%", width: "2%", height: "3%" },   // Âõõ    
            { id: "wu", value: 5, top: "47%", left: "26.1%", width: "6%", height: "6.5%" },  // ‰∫î    ‚úÖ
            { id: "liu", value: 6, top: "53%", left: "67.5%", width: "3%", height: "5%" },  // ÂÖ≠     ‚úÖ
            { id: "qi", value: 7, top: "57%", left: "58%", width: "1.5%", height: "2%" },   // ‰∏É   ‚úÖ (modifi√©)
            { id: "ba", value: 8, top: "43%", left: "89.5%", width: "8.5%", height: "12%" },  // ÂÖ´    ‚úÖ
            { id: "jiu", value: 9, top: "54%", left: "64.5%", width: "2.3%", height: "4%" },  // ‰πù    ‚úÖ (modifi√©)
            { id: "shi", value: 10, top: "53%", left: "35%", width: "4%", height: "5%" } // ÂçÅ    ‚úÖ
        ];
        
        // üîÅ Fonctions utilitaires
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function updateQuizHeaderVisibility(isQuizActive) {
            if (window.innerWidth <= 899) {
                document.body.classList.toggle('quiz-active', isQuizActive);
                mobileBackBtn.classList.toggle('hidden', !isQuizActive);
            } else {
                mobileBackBtn.classList.add('hidden');
            }
        }
        
        function updateResultHeaderVisibility(isResultActive) {
            if (window.innerWidth <= 899) {
                document.body.classList.toggle('result-active', isResultActive);
            }
        }
        
        function updateLivesDisplay() {
            const hearts = livesContainer.querySelectorAll('.heart');
            hearts.forEach((heart, i) => {
                if (i < lives) {
                    heart.textContent = '‚ù§';
                    heart.classList.remove('empty');
                } else {
                    heart.textContent = '‚ô°';
                    heart.classList.add('empty');
                }
            });
        }
        
        // üî• Lantern UI functions
        function createLanterns() {
            const container = document.getElementById('lantern-container');
            container.innerHTML = '';
            lanterns.forEach(lantern => {
                const hitbox = document.createElement('div');
                hitbox.className = 'lantern-hitbox';
                hitbox.dataset.value = lantern.value;
                hitbox.dataset.id = lantern.id;
                hitbox.style.top = lantern.top;
                hitbox.style.left = lantern.left;
                hitbox.style.width = lantern.width;
                hitbox.style.height = lantern.height;
                const number = document.createElement('div');
                number.className = 'lantern-number';
                number.textContent = chineseNumbers[lantern.value];
                hitbox.appendChild(number);
                hitbox.addEventListener('click', () => handleLanternClick(lantern.value, hitbox));
                container.appendChild(hitbox);
            });
        }
        
        function resetLanterns() {
            const hitboxes = document.querySelectorAll('.lantern-hitbox');
            hitboxes.forEach(box => {
                box.classList.remove('lit');
            });
            nextExpectedNumber = 0;
        }
        
        function handleLanternClick(value, element) {
            if (gameCompleted) return;
            
            // V√©rifier si c'est le prochain chiffre attendu
            if (value === nextExpectedNumber) {
                // Clic correct
                element.classList.add('lit');
                nextExpectedNumber++;
                
                // Si on a cliqu√© sur toutes les lanternes (0 √† 10)
                if (nextExpectedNumber > 10) {
                    finishGame(true);
                }
            } else {
                // Clic incorrect - perdre une vie
                if (lives > 0) {
                    lives--;
                    wrongAnswers++;
                    updateLivesDisplay();
                    
                    if (lives <= 0) {
                        finishGame(false);
                    }
                }
            }
        }
        
        function finishGame(success) {
            gameCompleted = true;
            clearInterval(timerInterval);
            
            if (success) {
                gameResultMessage.textContent = "üéâ F√©licitations ! Vous avez r√©solu l'√©nigme !";
                gameResultMessage.style.color = "#9bc24f";
                remainingTimeDisplay.textContent = timeLeft;
                
                // Gestion d√©verrouillage niveau 6 et score parfait
                handleVictory();
            } else {
                gameResultMessage.textContent = "‚è∞ Vous avez perdu toutes vos vies ! R√©essayez.";
                gameResultMessage.style.color = "#d35949";
                remainingTimeDisplay.textContent = "0";
            }
            
            gameSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
            updateQuizHeaderVisibility(false);
            updateResultHeaderVisibility(true);
            window.scrollTo(0, 0);
        }
        
        async function handleVictory() {
            if (!window.currentUser?.uid) return;
            
            const userRef = doc(db, 'users', window.currentUser.uid);
            const userDoc = await getDoc(userRef);
            
            if (userDoc.exists()) {
                const data = userDoc.data();
                const niveaux = data.niveaux || {};
                const niveaux100 = data.niveaux100 || {};
                const currentLevel = niveaux[THEME] || 0;
                const currentPerfectLevel = niveaux100[THEME] || 0;
                const updates = {};
                
                // D√©verrouiller le niveau suivant si n√©cessaire
                if (currentLevel === 5) {
                    updates[`niveaux.${THEME}`] = 6;
                    levelUnlockMsg.style.display = 'block';
                }
                
                // Mettre √† jour le niveau parfait si n√©cessaire
                if (currentPerfectLevel === 4) {
                    updates[`niveaux100.${THEME}`] = 5;
                    perfectScoreMsg.classList.remove('hidden');
                }
                
                // Si on a d√©bloqu√© un nouveau niveau g√©n√©ral
                const themeScore = data.quizScores?.[THEME] || 0;
                if (Math.floor((themeScore + 25) / 50) > Math.floor(themeScore / 50)) {
                    levelUpMsg.classList.remove('hidden');
                }
                
                // Enregistrer les scores et niveaux
                if (Object.keys(updates).length > 0) {
                    await updateDoc(userRef, updates);
                }
                
                // Incr√©menter le score global et th√©matique
                try {
                    await runTransaction(db, async (transaction) => {
                        const currentUserDoc = await transaction.get(userRef);
                        if (!currentUserDoc.exists()) {
                            throw "Document utilisateur non trouv√©!";
                        }
                        
                        const currentGlobal = currentUserDoc.data().globalScore || 0;
                        const currentTheme = currentUserDoc.data().quizScores?.[THEME] || 0;
                        
                        transaction.update(userRef, {
                            globalScore: increment(25),
                            [`quizScores.${THEME}`]: increment(25)
                        });
                        
                        // Sauvegarde locale
                        localStorage.setItem('globalScore', (currentGlobal + 25).toString());
                        const quizScores = JSON.parse(localStorage.getItem('quizScores') || '{}');
                        quizScores[THEME] = (currentTheme + 25);
                        localStorage.setItem('quizScores', JSON.stringify(quizScores));
                    });
                } catch (error) {
                    console.error("Erreur transaction score:", error);
                }
            }
        }
        
        // üéÆ Logique de jeu
        function startGame() {
            if (gameCompleted) return;
            clearInterval(timerInterval);
            
            timeLeft = levelConfig.time;
            lives = levelConfig.lives;
            nextExpectedNumber = 0;
            gameCompleted = false;
            wrongAnswers = 0;
            
            gameSection.classList.remove('hidden');
            resultSection.classList.add('hidden');
            updateQuizHeaderVisibility(true);
            updateResultHeaderVisibility(false);
            updateLivesDisplay();
            
            resetLanterns();
            createLanterns();
            startTimer();
            window.scrollTo(0, 0);
        }
        
        function startTimer() {
            timerDisplay.textContent = timeLeft;
            timerFill.style.width = (timeLeft / levelConfig.time * 100) + '%';
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                timerFill.style.width = (timeLeft / levelConfig.time * 100) + '%';
                
                // Changement de couleur selon le temps restant
                if (timeLeft <= 5) {
                    timerFill.style.background = 'linear-gradient(90deg, #ff4757, #ff6b81)';
                } else if (timeLeft <= 10) {
                    timerFill.style.background = 'linear-gradient(90deg, #ffa502, #ff7b25)';
                } else {
                    timerFill.style.background = 'linear-gradient(90deg,#b40000,#ff4d2e,#ff9b00)';
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    finishGame(false);
                }
            }, 1000);
        }
        
        async function handleBack() {
            if (gameCompleted) {
                window.location.href = 'index.html';
                return;
            }
            clearInterval(timerInterval);
            window.location.href = 'index.html';
        }
        
        // üîÑ Navigation
        mobileBackBtn.addEventListener('click', handleBack);
        restartBtn.addEventListener('click', () => {
            gameCompleted = false;
            startGame();
        });
        homeBtn.addEventListener('click', handleBack);
        
        // üîê Auth
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            window.currentUser = user;
            const pseudo = localStorage.getItem('userPseudo') || user.email.split('@')[0];
            
            try {
                const userRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userRef);
                if (!userDoc.exists()) {
                    console.warn("Utilisateur non trouv√© dans Firestore");
                    window.location.href = 'index.html';
                    return;
                }
                const userData = userDoc.data();
                const globalScore = userData.globalScore ?? 0;
                const niveauChinois = (userData.niveaux?.[THEME]) ?? 0;
                
                // ‚úÖ V√©rifications obligatoires avant de lancer le quiz
                if (globalScore < 0 || niveauChinois < 5) { // Niveau 5 requis
                    console.warn("Acc√®s refus√© : globalScore < 0 ou niveaux.chinois < 5");
                    window.location.href = 'index.html';
                    return;
                }
                
                // ‚úÖ Tout est OK ‚Üí lancer le quiz
                startGame();
            } catch (error) {
                console.error("Erreur lors de la v√©rification des pr√©requis :", error);
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>

