<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quiz Master - Chinois N2</title>
    <style>
        .hidden { display: none !important; }
        body {
            margin: 0;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f1115, #1c1c24);
            color: #f0f0f0;
        }
        #hover-warning {
            position: absolute;
            padding: 8px 14px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            font-size: 14px;
            border-radius: 6px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: 9999;
        }
        header {
            width: 100%;
            background: rgba(20, 20, 28, 0.8);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .navbar {
            max-width: 1100px;
            margin: auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
        }
        .nav-title { font-size: 1.4em; font-weight: 600; color: #eaeaea; letter-spacing: 1px; }
        .user-info { display: flex; gap: 15px; align-items: center; }
        .user-stats { font-size: 0.9em; text-align: right; }
        .logout-btn {
            padding: 8px 16px;
            background: #dc3545;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: 0.25s;
        }
        .logout-btn:hover { background: #c82333; }
        #quiz-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 40px;
            padding: 0 20px;
        }
        .quiz-container {
            display: flex;
            gap: 25px;
            width: 100%;
            max-width: 1200px;
            justify-content: center;
        }
        @media (min-width: 900px) {
            .question-box { flex: 2; }
            .answers-container { flex: 1; }
            #leaderboard-section.desktop { display: block; flex: 1; margin-top: 0; max-height: 500px; }
        }
        .question-box {
            background: #262633;
            padding: 30px;
            border-radius: 15px;
            font-size: 1.8em;
            font-weight: 600;
            min-height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.35);
        }
        .answers-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .answer-btn {
            padding: 15px;
            font-size: 1.2em;
            border-radius: 12px;
            background: #323248;
            color: #f0f0f0;
            cursor: pointer;
            border: none;
            transition: 0.18s;
        }
        .answer-btn:hover:not(:disabled) {
            transform: scale(1.04);
            background: #4a4a65;
        }
        .answer-btn:disabled { cursor: not-allowed; }
        .correct { background-color: #2ecc71 !important; }
        .incorrect { background-color: #e74c3c !important; }
        #timers-container {
            width: 100%;
            max-width: 1000px;
            margin-top: 25px;
        }
        #timer-bar-container, #question-timer-bar-container {
            margin: 10px 0;
            text-align: left;
            font-size: 0.95em;
        }
        #timer-bar, #question-timer-bar {
            width: 100%;
            height: 28px;
            background: #2b2b3a;
            border-radius: 10px;
            margin-top: 6px;
            overflow: hidden;
        }
        #timer-fill, #question-timer-fill {
            height: 100%;
            width: 100%;
            border-radius: 10px;
            transition: width 0.15s linear;
        }
        #timer-fill { background: #9c28a7ff; }
        #question-timer-fill { background: #a832d6; }
        #score-lives {
            margin-top: 20px;
            display: flex;
            gap: 80px;
            justify-content: center;
            font-size: 1.3em;
            position: relative;
        }
        #lives { color: #ff4b4b; font-size: 1.4em; }
        @media (max-width: 899px) {
            body.quiz-active header { display: none; }
            .quiz-container { flex-direction: column; gap: 15px; }
            .question-box { font-size: 1.6em; padding: 16px; min-height: 90px; }
            .answers-container { gap: 10px; }
            .answer-btn { padding: 12px; font-size: 1.1em; }
            #score-lives { flex-direction: column; gap: 10px; margin-top: 15px; }
            #leaderboard-section.desktop { display: none !important; }
            #mobile-quiz-ui-row {
                display: flex;
                gap: 12px;
                justify-content: center;
                margin-top: 15px;
                padding: 0 20px;
                width: 100%;
                max-width: 1200px;
            }
            #leaderboard-section.mobile {
                margin: 0;
                flex: 1;
                max-width: 220px;
            }
            #mobile-back-container {
                background: #262633;
                padding: 20px 16px;
                border-radius: 15px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                min-width: 60px;
                height: fit-content;
            }
            #mobile-back-container .action-btn {
                padding: 8px 12px;
                font-size: 1.2em;
                display: block;
                width: 100%;
                text-align: center;
            }
        }
        @media (min-width: 900px) {
            #leaderboard-section.mobile, #mobile-quiz-ui-row { display: none !important; }
            #mobile-back-btn { display: none !important; }
        }
        #result-section {
            margin-top: 60px;
            text-align: center;
        }
        .result-stats {
            background: #262633;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            margin: 30px auto;
        }
        .result-stats h3 { color: #9c28a7; margin-top: 0; }
        .action-btn {
            margin: 10px;
            padding: 12px 25px;
            border-radius: 10px;
            background: #3a3a50;
            border: none;
            cursor: pointer;
            color: #f0f0f0;
            transition: 0.25s;
        }
        .action-btn:hover { background: #4e4e6a; }
        .leaderboard-section {
            background: #262633;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .leaderboard-section .leaderboard-title {
            text-align: center;
            margin-bottom: 15px;
            color: #9c28a7;
            font-size: 1.3em;
        }
        .leaderboard-section .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 6px 0;
            background: #2c2c3a;
            border-radius: 8px;
        }
        .leaderboard-section .leaderboard-rank { font-size: 1.1em; font-weight: bold; width: 30px; }
        .leaderboard-section .leaderboard-name { flex: 1; font-weight: 500; }
        .leaderboard-section .leaderboard-score { font-size: 1em; color: #9c28a7; font-weight: bold; }
    </style>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-left">
                <span class="nav-title">ğŸ¯ Quiz Master - Chinois N2</span>
                <button id="back-btn" class="action-btn" style="margin-left:10px;">Retour</button>
            </div>
            <div class="nav-right hidden" id="nav-logged-in">
                <div class="user-info">
                    <div class="user-stats">
                        <div><strong id="user-pseudo">Joueur</strong></div>
                        <div>Score Global: <strong id="user-global-score">0</strong></div>
                    </div>
                    <button class="action-btn" onclick="window.location.href='settings.html'" style="margin-left:10px;">RÃ©glages</button>
                    <button class="logout-btn" onclick="logout()">DÃ©connexion</button>
                </div>
            </div>
        </nav>
    </header>
    <main>
        <section id="quiz-section" class="hidden">
            <div class="quiz-container">
                <div class="question-box">
                    <div id="question">[Question]</div>
                </div>
                <div class="answers-container" id="answers-container">
                    <!-- Buttons will be generated dynamically -->
                </div>
                <!-- Leaderboard desktop -->
                <div id="leaderboard-section" class="desktop leaderboard-section">
                    <h3 class="leaderboard-title">ğŸ† Classement</h3>
                    <div class="leaderboard-list">
                        <div style="text-align: center; opacity: 0.6;">Chargement...</div>
                    </div>
                </div>
            </div>
            <div id="timers-container">
                <div id="timer-bar-container">
                    <span>â±ï¸ Temps restant : <span id="timer">0</span>s</span>
                    <div id="timer-bar"><div id="timer-fill"></div></div>
                </div>
                <div id="question-timer-bar-container">
                    <span>âš¡ Question : <span id="question-timer">0</span>s</span>
                    <div id="question-timer-bar"><div id="question-timer-fill"></div></div>
                </div>
            </div>
            <div id="score-lives">
                <div>Score : <span id="score">0</span></div>
                <div id="lives">â¤â¤â¤</div>
            </div>
            <!-- Mobile UI row (leaderboard + retour) -->
            <div id="mobile-quiz-ui-row">
                <div id="leaderboard-section" class="mobile leaderboard-section">
                    <h3 class="leaderboard-title">ğŸ† Classement</h3>
                    <div class="leaderboard-list">
                        <div style="text-align: center; opacity: 0.6;">Chargement...</div>
                    </div>
                </div>
                <div id="mobile-back-container">
                    <button id="mobile-back-btn" class="action-btn">â†</button>
                </div>
            </div>
        </section>
        <section id="result-section" class="hidden">
            <h2>Partie terminÃ©e ! ğŸ‰</h2>
            <div class="result-stats">
                <h3>RÃ©sumÃ©</h3>
                <p>Score de la partie : <strong id="final-score">0</strong></p>
                <p>Nouveau score global : <strong id="new-global-score">0</strong></p>
                <p>Score chinois : <strong id="new-dept-score">0</strong></p>
                <p>Quiz complÃ©tÃ©s : <strong id="new-quiz-completed">0</strong></p>
                <div id="level-up-msg" class="hidden" style="color: #2ecc71; margin-top: 15px; font-weight: bold;">
                    ğŸŠ NIVEAU SUPÃ‰RIEUR ATTEINT !
                </div>
            </div>
            <button id="restart-btn" class="action-btn">Rejouer</button>
            <button id="home-btn" class="action-btn">Accueil</button>
        </section>
    </main>
    <div id="hover-warning"></div>
    <script type="module">
        // ğŸ”§ INITIALISATION FIREBASE (identique Ã  tous les quiz)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, updateDoc, collection, query, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDytQnPS_ZVbVuTkS8m3iUAOGMgm64A0XE",
            authDomain: "quiz-master-io.firebaseapp.com",
            projectId: "quiz-master-io",
            storageBucket: "quiz-master-io.firebasestorage.app",
            messagingSenderId: "773382469164",
            appId: "1:773382469164:web:5e24a9a62ce543f5190389"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        window.auth = auth;
        window.db = db;
        window.currentUser = null;

        // âœï¸ Liste utilisÃ©e pour calculer le score global
        function computeGlobalScore(quizScores) {
            const keys = [
                'departements', 'chinois', 'medecine', 'math', 'anglais',
                'neerlandais', 'allemand', 'italien', 'espagnol',
                'geographie', 'animaux'
            ];
            return keys.reduce((sum, key) => sum + (quizScores[key] || 0), 0);
        }

        // Configuration du mode (durÃ©e, nombre de vies, etc.)
        const mode = { time: 90, qTime: 10, lives: 10 };

        // Ã‰tats du jeu
        let score = 0, lives = 0, timeLeft = 0, qTime = 0;
        let timerInterval = null, qTimerInterval = null, awaitingNext = false;
        let currentQuestionData = null;
        let gameCompleted = false;
        let questions = [];
        let currentQuestionIndex = 0;

        // Ã‰lÃ©ments DOM
        const quizSection = document.getElementById('quiz-section');
        const resultSection = document.getElementById('result-section');
        const backBtn = document.getElementById('back-btn');
        const mobileBackBtn = document.getElementById('mobile-back-btn');
        const answersContainer = document.getElementById('answers-container');
        const questionBox = document.getElementById('question');
        const scoreDisplay = document.getElementById('score');
        const livesDisplay = document.getElementById('lives');
        const timerDisplay = document.getElementById('timer');
        const qTimerDisplay = document.getElementById('question-timer');
        const timerFill = document.getElementById('timer-fill');
        const qTimerFill = document.getElementById('question-timer-fill');

        // DONNÃ‰ES NIVEAU 2
        const vocabulaireN2 = [
            // Temps
            { fr: "Hier", ch: "æ˜¨å¤©", py: "zuÃ³tiÄn" },
            { fr: "Aujourd'hui", ch: "ä»Šå¤©", py: "jÄ«ntiÄn" },
            { fr: "Demain", ch: "æ˜å¤©", py: "mÃ­ngtiÄn" },
            { fr: "Matin", ch: "æ—©ä¸Š", py: "zÇoshang" },
            { fr: "AprÃ¨s-midi", ch: "ä¸‹åˆ", py: "xiÃ wÇ”" },
            { fr: "Soir", ch: "æ™šä¸Š", py: "wÇnshang" },
            { fr: "Maintenant", ch: "ç°åœ¨", py: "xiÃ nzÃ i" },
            { fr: "Plus tard", ch: "ä»¥å", py: "yÇhÃ²u" },
            { fr: "Ã€ plus tard", ch: "å¾…ä¼šè§", py: "dÃ ihuÇ jiÃ n" },
            // Lieux / spatial
            { fr: "Ici", ch: "è¿™é‡Œ", py: "zhÃ¨lÇ" },
            { fr: "LÃ -bas", ch: "é‚£é‡Œ", py: "nÃ lÇ" },
            { fr: "Ã€ droite", ch: "å³è¾¹", py: "yÃ²ubiÄn" },
            { fr: "Ã€ gauche", ch: "å·¦è¾¹", py: "zuÇ’biÄn" },
            { fr: "Devant", ch: "å‰é¢", py: "qiÃ¡nmiÃ n" },
            { fr: "DerriÃ¨re", ch: "åé¢", py: "hÃ²umiÃ n" },
            { fr: "Ã€ cÃ´tÃ©", ch: "æ—è¾¹", py: "pÃ¡ngbiÄn" },
            // Expressions utiles
            { fr: "Bonjour", ch: "ä½ å¥½", py: "nÇ hÇo" },
            { fr: "Bonsoir", ch: "æ™šä¸Šå¥½", py: "wÇnshang hÇo" },
            { fr: "Merci", ch: "è°¢è°¢", py: "xiÃ¨xiÃ¨" },
            { fr: "Merci beaucoup", ch: "éå¸¸æ„Ÿè°¢", py: "fÄ“ichÃ¡ng gÇnxiÃ¨" },
            { fr: "De rien", ch: "ä¸å®¢æ°”", py: "bÃº kÃ¨qi" },
            { fr: "Excusez-moi", ch: "ä¸å¥½æ„æ€", py: "bÃ¹ hÇoyÃ¬si" },
            { fr: "Pardon", ch: "å¯¹ä¸èµ·", py: "duÃ¬buqÇ" },
            { fr: "Oui", ch: "æ˜¯", py: "shÃ¬" },
            { fr: "Non", ch: "ä¸æ˜¯", py: "bÃº shÃ¬" },
            { fr: "D'accord", ch: "å¥½çš„", py: "hÇo de" },
            { fr: "Je ne comprends pas", ch: "æˆ‘ä¸æ‡‚", py: "wÇ’ bÃ¹ dÇ’ng" },
            { fr: "Comment vas-tu ?", ch: "ä½ å¥½å—ï¼Ÿ", py: "nÇ hÇo ma?" },
            { fr: "Ã‡a va", ch: "æˆ‘å¾ˆå¥½", py: "wÇ’ hÄ›n hÇo" },
            { fr: "EnchantÃ©", ch: "å¾ˆé«˜å…´è®¤è¯†ä½ ", py: "hÄ›n gÄoxÃ¬ng rÃ¨nshi nÇ" },
            { fr: "Je comprends", ch: "æˆ‘æ‡‚äº†", py: "wÇ’ dÇ’ng le" },
            { fr: "Au revoir", ch: "å†è§", py: "zÃ ijiÃ n" },
            { fr: "Ã€ demain", ch: "æ˜å¤©è§", py: "mÃ­ngtiÄn jiÃ n" },
            // Jours / calendrier
            { fr: "Lundi", ch: "æ˜ŸæœŸä¸€", py: "xÄ«ngqÄ« yÄ«" },
            { fr: "Mardi", ch: "æ˜ŸæœŸäºŒ", py: "xÄ«ngqÄ« Ã¨r" },
            { fr: "Mercredi", ch: "æ˜ŸæœŸä¸‰", py: "xÄ«ngqÄ« sÄn" },
            { fr: "Jeudi", ch: "æ˜ŸæœŸå››", py: "xÄ«ngqÄ« sÃ¬" },
            { fr: "Vendredi", ch: "æ˜ŸæœŸäº”", py: "xÄ«ngqÄ« wÇ”" },
            { fr: "Samedi", ch: "æ˜ŸæœŸå…­", py: "xÄ«ngqÄ« liÃ¹" },
            { fr: "Dimanche", ch: "æ˜ŸæœŸå¤©", py: "xÄ«ngqÄ« tiÄn" },
            { fr: "Week-end", ch: "å‘¨æœ«", py: "zhÅumÃ²" },
            // FÃªtes
            { fr: "Nouvel an chinois", ch: "æ˜¥èŠ‚", py: "ChÅ«njiÃ©" },
            { fr: "FÃªte de la Lune", ch: "ä¸­ç§‹èŠ‚", py: "ZhÅngqiÅ«jiÃ©" },
            { fr: "FÃªte nationale", ch: "å›½åº†èŠ‚", py: "GuÃ³qÃ¬ngjiÃ©" },
            //vocabulaire utile
            { fr: "Maison", ch: "å®¶", py: "jiÄ" },
            { fr: "Ã‰cole", ch: "å­¦æ ¡", py: "xuÃ©xiÃ o" },
            { fr: "Travail", ch: "å·¥ä½œ", py: "gÅngzuÃ²" },
            { fr: "Ville", ch: "åŸå¸‚", py: "chÃ©ngshÃ¬" },
            { fr: "Voiture", ch: "æ±½è½¦", py: "qÃ¬chÄ“" },
            { fr: "Bus", ch: "å…¬äº¤è½¦", py: "gÅngjiÄo chÄ“" },
            { fr: "Train", ch: "ç«è½¦", py: "huÇ’chÄ“" },
            { fr: "VÃ©lo", ch: "è‡ªè¡Œè½¦", py: "zÃ¬xÃ­ngchÄ“" },
            { fr: "TÃ©lÃ©phone", ch: "æ‰‹æœº", py: "shÇ’ujÄ«" },
            { fr: "Ordinateur", ch: "ç”µè„‘", py: "diÃ nnÇo" },
            { fr: "Table", ch: "æ¡Œå­", py: "zhuÅzi" },
            { fr: "Chaise", ch: "æ¤…å­", py: "yÇzi" },
            { fr: "Livre", ch: "ä¹¦", py: "shÅ«" },
            { fr: "Eau", ch: "æ°´", py: "shuÇ" },
            { fr: "ThÃ©", ch: "èŒ¶", py: "chÃ¡" },
            { fr: "CafÃ©", ch: "å’–å•¡", py: "kÄfÄ“i" },
            { fr: "Pain", ch: "é¢åŒ…", py: "miÃ nbÄo" },
            { fr: "Riz", ch: "ç±³é¥­", py: "mÇfÃ n" },
            { fr: "VÃªtement", ch: "è¡£æœ", py: "yÄ«fu" },
            { fr: "Argent", ch: "é’±", py: "qiÃ¡n" },
            //quelques verbes
            { fr: "ÃŠtre", ch: "æ˜¯", py: "shÃ¬" },
            { fr: "Avoir", ch: "æœ‰", py: "yÇ’u" },
            { fr: "Aller", ch: "å»", py: "qÃ¹" },
            { fr: "Venir", ch: "æ¥", py: "lÃ¡i" },
            { fr: "Faire", ch: "åš", py: "zuÃ²" },
            { fr: "Dire", ch: "è¯´", py: "shuÅ" },
            { fr: "Voir", ch: "çœ‹", py: "kÃ n" },
            { fr: "Manger", ch: "åƒ", py: "chÄ«" },
            { fr: "Boire", ch: "å–", py: "hÄ“" },
            { fr: "Dormir", ch: "ç¡è§‰", py: "shuÃ¬jiÃ o" },
            { fr: "Apprendre", ch: "å­¦ä¹ ", py: "xuÃ©xÃ­" },
            { fr: "Aimer", ch: "å–œæ¬¢", py: "xÇhuan" },
            { fr: "Vouloir", ch: "è¦", py: "yÃ o" },
            { fr: "Pouvoir", ch: "èƒ½", py: "nÃ©ng" },
            { fr: "Donner", ch: "ç»™", py: "gÄ›i" },
            //expressions utiles
            { fr: "Combien Ã§a coÃ»te ?", ch: "å¤šå°‘é’±ï¼Ÿ", py: "duÅshao qiÃ¡n?" },
            { fr: "OÃ¹ estâ€¦ ?", ch: "â€¦åœ¨å“ªé‡Œï¼Ÿ", py: "â€¦zÃ i nÇlÇ?" },
            { fr: "Je veux Ã§a", ch: "æˆ‘è¦è¿™ä¸ª", py: "wÇ’ yÃ o zhÃ¨ge" },
            { fr: "J'ai faim", ch: "æˆ‘é¥¿äº†", py: "wÇ’ Ã¨ le" },
            { fr: "J'ai soif", ch: "æˆ‘æ¸´äº†", py: "wÇ’ kÄ› le" },
            { fr: "J'ai chaud", ch: "æˆ‘çƒ­", py: "wÇ’ rÃ¨" },
            { fr: "J'ai froid", ch: "æˆ‘å†·", py: "wÇ’ lÄ›ng" },
            { fr: "Je ne sais pas", ch: "æˆ‘ä¸çŸ¥é“", py: "wÇ’ bÃ¹ zhÄ«dÃ o" },
            { fr: "Attends", ch: "ç­‰ä¸€ä¸‹", py: "dÄ›ng yÃ­xiÃ " },
            { fr: "DÃ©pÃªche-toi", ch: "å¿«ç‚¹", py: "kuÃ i diÇn" },
            { fr: "Pas de problÃ¨me", ch: "æ²¡é—®é¢˜", py: "mÃ©i wÃ¨ntÃ­" },
            { fr: "Fais attention", ch: "å°å¿ƒ", py: "xiÇoxÄ«n" },
            { fr: "Bon appÃ©tit", ch: "æ…¢æ…¢åƒ", py: "mÃ nman chÄ«" },
            { fr: "Câ€™est dÃ©licieux", ch: "å¾ˆå¥½åƒ", py: "hÄ›n hÇochÄ«" },
            { fr: "Je tâ€™aime", ch: "æˆ‘çˆ±ä½ ", py: "wÇ’ Ã i nÇ" }
        ];

        const n2Patterns = [
            ["Je suis ici maintenant", "æˆ‘ç°åœ¨åœ¨è¿™é‡Œ", "wÇ’ xiÃ nzÃ i zÃ i zhÃ¨lÇ"],
            ["Je vais lÃ -bas demain", "æˆ‘æ˜å¤©å»é‚£é‡Œ", "wÇ’ mÃ­ngtiÄn qÃ¹ nÃ lÇ"],
            ["Je viens ce soir", "æˆ‘æ™šä¸Šæ¥", "wÇ’ wÇnshang lÃ¡i"],
            ["Nous partons aprÃ¨s-demain", "æˆ‘ä»¬åå¤©èµ°", "wÇ’men hÃ²utiÄn zÇ’u"],
            ["Elle arrive demain matin", "å¥¹æ˜å¤©æ—©ä¸Šåˆ°", "tÄ mÃ­ngtiÄn zÇoshang dÃ o"],
            ["Ils sont derriÃ¨re toi", "ä»–ä»¬åœ¨ä½ åé¢", "tÄmen zÃ i nÇ hÃ²umiÃ n"],
            ["Il est Ã  cÃ´tÃ© de moi", "ä»–åœ¨æˆ‘çš„æ—è¾¹", "tÄ zÃ i wÇ’ de pÃ¡ngbiÄn"],
            ["Je ne comprends pas", "æˆ‘ä¸æ‡‚", "wÇ’ bÃ¹ dÇ’ng"]
        ];

        // --- GÃ©nÃ©rateur de question pour niveau 2 ---
        function generateN2Question() {
            const type = Math.floor(Math.random() * 3) + 1;

            if (type === 1) {
                const item = vocabulaireN2[Math.floor(Math.random() * vocabulaireN2.length)];
                const wrong = new Set();
                while (wrong.size < 4) {
                    const r = vocabulaireN2[Math.floor(Math.random() * vocabulaireN2.length)];
                    if (r.ch !== item.ch) wrong.add(r);
                }
                const opts = [...wrong, item]
                    .sort(() => Math.random() - 0.5)
                    .map(o => ({
                        raw: o.ch,
                        display: `${o.ch} (${o.py})`
                    }));
                return {
                    q: `Comment s'Ã©crit : <b>${item.fr}</b> ?`,
                    a: item.ch,
                    opts
                };
            }

            if (type === 2) {
                const item = vocabulaireN2[Math.floor(Math.random() * vocabulaireN2.length)];
                const wrong = new Set();
                while (wrong.size < 4) {
                    const r = vocabulaireN2[Math.floor(Math.random() * vocabulaireN2.length)];
                    if (r.fr !== item.fr) wrong.add(r);
                }
                const opts = [...wrong, item]
                    .sort(() => Math.random() - 0.5)
                    .map(o => ({
                        raw: o.fr,
                        display: o.fr
                    }));
                return {
                    q: `Que signifie : <b>${item.ch}</b> (${item.py}) ?`,
                    a: item.fr,
                    opts
                };
            }

            if (type === 3) {
                const item = n2Patterns[Math.floor(Math.random() * n2Patterns.length)];
                const wrong = new Set();
                while (wrong.size < 4) {
                    const r = n2Patterns[Math.floor(Math.random() * n2Patterns.length)];
                    if (r[1] !== item[1]) wrong.add(r);
                }
                const opts = [...wrong, item]
                    .sort(() => Math.random() - 0.5)
                    .map(o => ({
                        raw: o[1],
                        display: `${o[1]} (${o[2]})`
                    }));
                return {
                    q: `Comment dit-on : <b>${item[0]}</b> ?`,
                    a: item[1],
                    opts
                };
            }
        }

        // --- GÃ©nÃ©ration de 50 questions pour niveau 2 ---
        function generateQuizN2() {
            const questions = [];
            for (let i = 0; i < 50; i++) {
                questions.push(generateN2Question());
            }
            return questions;
        }

        // Gestion UI header
        function updateQuizHeaderVisibility(isQuizActive) {
            if (window.innerWidth <= 899) {
                document.body.classList.toggle('quiz-active', isQuizActive);
                mobileBackBtn.classList.toggle('hidden', !isQuizActive);
            } else {
                mobileBackBtn.classList.add('hidden');
            }
        }

        // Sauvegarde partielle du score (ex: retour vers l'accueil)
        async function saveCurrentScore() {
            if (!window.currentUser || score <= 0 || gameCompleted) return;
            try {
                const quizKey = 'chinois';
                const userDocRef = doc(db, 'users', currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                let userData = userDoc.data();
                const defaultQuizScores = {
                    departements: 0, chinois: 0, medecine: 0, math: 0, anglais: 0,
                    neerlandais: 0, allemand: 0, italien: 0, espagnol: 0,
                    geographie: 0, animaux: 0
                };
                if (!userData) {
                    userData = {
                        pseudo: currentUser.email.split('@')[0],
                        email: currentUser.email,
                        quizScores: defaultQuizScores,
                        quizCompleted: 0,
                        createdAt: new Date().toISOString()
                    };
                    await setDoc(userDocRef, userData);
                }
                const quizScores = { ...(userData.quizScores || defaultQuizScores) };
                const oldDeptScore = quizScores[quizKey] || 0;
                const newDeptScore = oldDeptScore + score;
                quizScores[quizKey] = newDeptScore;
                const newGlobalScore = computeGlobalScore(quizScores);
                await updateDoc(userDocRef, { quizScores });
                localStorage.setItem('globalScore', newGlobalScore);
                document.getElementById('user-global-score').textContent = newGlobalScore;
            } catch (error) {
                console.error('Erreur sauvegarde partielle:', error);
            }
        }

        // Bouton retour
        backBtn.onclick = async function () {
            await saveCurrentScore();
            stopAllTimers();
            quizSection.classList.add('hidden');
            window.location.href = 'index.html';
        };
        mobileBackBtn.onclick = backBtn.onclick;

        function startMode() {
            stopAllTimers();
            score = 0;
            lives = mode.lives;
            timeLeft = mode.time;
            qTime = mode.qTime;
            awaitingNext = false;
            currentQuestionIndex = 0;
            questions = generateQuizN2().sort(() => Math.random() - 0.5);
            updateLives();
            scoreDisplay.textContent = score;
            resultSection.classList.add('hidden');
            quizSection.classList.remove('hidden');
            updateQuizHeaderVisibility(true);
            loadLeaderboard();
            generateQuestion();
            startMainTimer();
        }

        function generateQuestion() {
            if (awaitingNext || currentQuestionIndex >= questions.length || lives <= 0) {
                if (lives <= 0 || currentQuestionIndex >= questions.length) {
                    endGame();
                }
                return;
            }

            const qData = questions[currentQuestionIndex];
            currentQuestionData = qData;
            qTime = mode.qTime;
            qTimerDisplay.textContent = qTime.toFixed(1);
            qTimerFill.style.width = '100%';
            questionBox.innerHTML = qData.q;

            // Clear previous buttons
            answersContainer.innerHTML = '';

            // Create buttons for each option
            qData.opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.innerHTML = opt.display;
                btn.dataset.value = opt.raw;
                btn.onclick = () => handleAnswer(opt.raw);
                answersContainer.appendChild(btn);
            });

            setTimeout(() => {
                if (!awaitingNext) startQTimer();
            }, 100);
        }

        function handleAnswer(selected) {
            if (awaitingNext) return;
            awaitingNext = true;
            clearInterval(qTimerInterval);

            // Disable all buttons and highlight correct/incorrect
            const buttons = answersContainer.querySelectorAll('.answer-btn');
            buttons.forEach(btn => {
                btn.disabled = true;
                const btnValue = btn.dataset.value;
                if (btnValue === currentQuestionData.a) {
                    btn.classList.add("correct");
                }
                if (btnValue === selected && selected !== currentQuestionData.a) {
                    btn.classList.add("incorrect");
                }
            });

            if (selected === currentQuestionData.a) {
                score++;
            } else {
                lives--;
            }
            updateLives();
            scoreDisplay.textContent = score;

            setTimeout(() => {
                currentQuestionIndex++;
                awaitingNext = false;
                generateQuestion();
            }, 1000);
        }

        function updateLives() {
            const safeLives = Math.max(0, lives);
            const maxLives = mode.lives;
            livesDisplay.textContent = 'â¤'.repeat(safeLives) + 'â™¡'.repeat(Math.max(0, maxLives - safeLives));
        }

        function startMainTimer() {
            timerDisplay.textContent = timeLeft;
            timerFill.style.width = '100%';
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                timerFill.style.width = (timeLeft / mode.time * 100) + '%';
                if (timeLeft <= 5) timerFill.style.background = '#dc3545';
                else if (timeLeft <= 10) timerFill.style.background = '#ffa500';
                else timerFill.style.background = '#9c28a7ff';
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame();
                }
            }, 1000);
        }

        function startQTimer() {
            clearInterval(qTimerInterval);
            const qStartTime = mode.qTime;
            qTime = qStartTime;
            qTimerInterval = setInterval(() => {
                qTime -= 0.1;
                qTimerDisplay.textContent = qTime.toFixed(1);
                const percent = Math.max(0, qTime / qStartTime) * 100;
                qTimerFill.style.width = percent + '%';
                if (qTime <= 0) {
                    clearInterval(qTimerInterval);
                    handleAnswer('');
                }
            }, 100);
        }

        async function endGame() {
            if (gameCompleted) return;
            gameCompleted = true;
            quizSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
            updateQuizHeaderVisibility(false);
            document.getElementById('final-score').textContent = score;
            stopAllTimers();

            try {
                if (!window.currentUser) throw new Error('Utilisateur non connectÃ©');

                const quizKey = 'chinois';

                const userDocRef = doc(db, 'users', currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                let userData = userDoc.data();
                const defaultQuizScores = {
                    departements: 0, chinois: 0, medecine: 0, math: 0, anglais: 0,
                    neerlandais: 0, allemand: 0, italien: 0, espagnol: 0,
                    geographie: 0, animaux: 0
                };

                if (!userData) {
                    userData = {
                        pseudo: currentUser.email.split('@')[0],
                        email: currentUser.email,
                        quizScores: defaultQuizScores,
                        quizCompleted: 0,
                        createdAt: new Date().toISOString()
                    };
                    await setDoc(userDocRef, userData);
                }

                const quizScores = { ...(userData.quizScores || defaultQuizScores) };
                const oldDeptScore = quizScores[quizKey] || 0;
                const newDeptScore = oldDeptScore + score;
                quizScores[quizKey] = newDeptScore;

                const newGlobalScore = computeGlobalScore(quizScores);
                let quizCompleted = userData.quizCompleted || 0;
                if (lives > 0) quizCompleted += 1;

                await updateDoc(userDocRef, { quizScores, quizCompleted });

                localStorage.setItem('globalScore', newGlobalScore);
                localStorage.setItem('quizCompleted', quizCompleted);

                document.getElementById('new-global-score').textContent = newGlobalScore;
                document.getElementById('new-dept-score').textContent = newDeptScore;
                document.getElementById('new-quiz-completed').textContent = quizCompleted;

                const oldLevel = Math.floor(oldDeptScore / 50);
                const newLevel = Math.floor(newDeptScore / 50);
                if (newLevel > oldLevel) {
                    document.getElementById('level-up-msg').classList.remove('hidden');
                } else {
                    document.getElementById('level-up-msg').classList.add('hidden');
                }
            } catch (error) {
                console.error('Erreur sauvegarde fin de partie:', error);
                alert('Erreur lors de la sauvegarde.');
            }
        }

        function stopAllTimers() {
            clearInterval(timerInterval);
            clearInterval(qTimerInterval);
        }

        const restartBtn = document.getElementById('restart-btn');
        const homeBtn = document.getElementById('home-btn');
        restartBtn.onclick = () => {
            gameCompleted = false;
            startMode();
        };
        homeBtn.onclick = async function () {
            await saveCurrentScore();
            stopAllTimers();
            resultSection.classList.add('hidden');
            window.location.href = 'index.html';
        };

        window.logout = async function () {
            await signOut(auth);
            window.location.href = 'index.html';
        };

        // Chargement du leaderboard
        async function loadLeaderboard() {
            const mobileList = document.querySelector('#leaderboard-section.mobile .leaderboard-list');
            const desktopList = document.querySelector('#leaderboard-section.desktop .leaderboard-list');
            const placeholder = '<div style="text-align: center; opacity: 0.6;">Chargement...</div>';
            if (mobileList) mobileList.innerHTML = placeholder;
            if (desktopList) desktopList.innerHTML = placeholder;

            try {
                const q = query(collection(db, 'users'), orderBy('quizScores.chinois', 'desc'), limit(10));
                const querySnapshot = await getDocs(q);
                let rank = 1;
                let html = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data() || {};
                    const pseudo = data.pseudo || 'Anonyme';
                    const score = data.quizScores?.chinois || 0;
                    let medal = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '';
                    html += `<div class="leaderboard-item">
                        <div class="leaderboard-rank">${medal || rank}</div>
                        <div class="leaderboard-name">${pseudo}</div>
                        <div class="leaderboard-score">${score}</div>
                    </div>`;
                    rank++;
                });
                const finalHtml = html || '<div style="text-align: center; opacity: 0.6;">Aucun joueur</div>';
                if (mobileList) mobileList.innerHTML = finalHtml;
                if (desktopList) desktopList.innerHTML = finalHtml;
            } catch (error) {
                console.error('Erreur chargement leaderboard:', error);
                const errorMsg = '<div style="text-align: center; opacity: 0.6;">Erreur</div>';
                if (mobileList) mobileList.innerHTML = errorMsg;
                if (desktopList) desktopList.innerHTML = errorMsg;
            }
        }

        // Authentification â€“ ne jamais afficher le quiz sans auth
        onAuthStateChanged(auth, async (user) => {
            const navLoggedIn = document.getElementById('nav-logged-in');
            if (user) {
                window.currentUser = user;
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                const pseudoEl = document.getElementById('user-pseudo');
                const scoreEl = document.getElementById('user-global-score');
                let globalScore = 0;
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    const quizScores = data.quizScores || {};
                    pseudoEl.textContent = data.pseudo || user.email.split('@')[0];
                    globalScore = computeGlobalScore(quizScores);
                } else {
                    pseudoEl.textContent = user.email.split('@')[0];
                    globalScore = 0;
                }
                scoreEl.textContent = globalScore;
                localStorage.setItem('globalScore', globalScore);
                navLoggedIn.classList.remove('hidden');

                // VÃ©rifier accÃ¨s (Ã  adapter selon niveaux)
                const hash = window.location.hash.substring(1);
                const level = parseInt(hash) || 1;
                if (!canAccessLevel(level, globalScore)) {
                    alert(`Niveau ${level} verrouillÃ©.`);
                    window.location.href = 'index.html';
                    return;
                }

                startMode();
            } else {
                window.location.href = 'index.html';
            }
        });

        // Conditions dâ€™accÃ¨s
        function canAccessLevel(level, globalScore) {
            return level === 1;
        }
    </script>
</body>
</html>

