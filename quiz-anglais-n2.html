<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quiz Master - Anglais N2</title>
    <style>
        .hidden { display: none !important; }
        body {
            margin: 0;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f1115, #1c1c24);
            color: #f0f0f0;
        }
        #hover-warning {
            position: absolute;
            padding: 8px 14px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            font-size: 14px;
            border-radius: 6px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: 9999;
        }
        header {
            width: 100%;
            background: rgba(20, 20, 28, 0.8);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .navbar {
            max-width: 1100px;
            margin: auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
        }
        .nav-title { font-size: 1.4em; font-weight: 600; color: #eaeaea; letter-spacing: 1px; }
        .user-info { display: flex; gap: 15px; align-items: center; }
        .user-stats { font-size: 0.9em; text-align: right; }
        .logout-btn {
            padding: 8px 16px;
            background: #dc3545;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: 0.25s;
        }
        .logout-btn:hover { background: #c82333; }
        #quiz-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 40px;
            padding: 0 20px;
        }
        .quiz-container {
            display: flex;
            gap: 25px;
            width: 100%;
            max-width: 1200px;
            justify-content: center;
        }
        @media (min-width: 900px) {
            .question-box { flex: 2; }
            .answers-container { flex: 1; }
            #leaderboard-section.desktop { 
                display: block; 
                flex: 1; 
                margin-top: 0; 
                max-height: 500px; 
            }
        }
        .question-box {
            background: #262633;
            padding: 30px;
            border-radius: 15px;
            font-size: 1.8em;
            font-weight: 600;
            min-height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.35);
        }
        .answers-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .answer-btn {
            padding: 15px;
            font-size: 1.2em;
            border-radius: 12px;
            background: #323248;
            color: #f0f0f0;
            cursor: pointer;
            border: none;
            transition: 0.18s;
        }
        .answer-btn:hover:not(:disabled) {
            transform: scale(1.04);
            background: #4a4a65;
        }
        .answer-btn:disabled { cursor: not-allowed; }
        .correct { background-color: #2ecc71 !important; }
        .incorrect { background-color: #e74c3c !important; }
        #timers-container {
            width: 100%;
            max-width: 1000px;
            margin-top: 25px;
        }
        #timer-bar-container, #question-timer-bar-container {
            margin: 10px 0;
            text-align: left;
            font-size: 0.95em;
        }
        #timer-bar, #question-timer-bar {
            width: 100%;
            height: 28px;
            background: #2b2b3a;
            border-radius: 10px;
            margin-top: 6px;
            overflow: hidden;
        }
        #timer-fill, #question-timer-fill {
            height: 100%;
            width: 100%;
            border-radius: 10px;
            transition: width 0.15s linear;
        }
        #timer-fill { background: #9c28a7ff; }
        #question-timer-fill { background: #a832d6; }
        #score-lives {
            margin-top: 20px;
            display: flex;
            gap: 80px;
            justify-content: center;
            font-size: 1.3em;
            position: relative;
        }
        #lives { color: #ff4b4b; font-size: 1.4em; }
        @media (max-width: 899px) {
            body.quiz-active header { display: none; }
            .quiz-container { flex-direction: column; gap: 15px; }
            .question-box { font-size: 1.6em; padding: 16px; min-height: 90px; }
            .answers-container { gap: 10px; }
            .answer-btn { padding: 12px; font-size: 1.1em; }
            #score-lives { flex-direction: column; gap: 10px; margin-top: 15px; }
            #leaderboard-section.desktop { display: none !important; }
            #mobile-quiz-ui-row {
                display: flex;
                gap: 12px;
                justify-content: center;
                margin-top: 15px;
                padding: 0 20px;
                width: 100%;
                max-width: 1200px;
            }
            #leaderboard-section.mobile {
                margin: 0;
                flex: 1;
                max-width: 220px;
            }
            #mobile-back-container {
                background: #262633;
                padding: 20px 16px;
                border-radius: 15px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                min-width: 60px;
                height: fit-content;
            }
            #mobile-back-container .action-btn {
                padding: 8px 12px;
                font-size: 1.2em;
                display: block;
                width: 100%;
                text-align: center;
            }
        }
        @media (min-width: 900px) {
            #leaderboard-section.mobile, #mobile-quiz-ui-row { display: none !important; }
            #mobile-back-btn { display: none !important; }
        }
        #result-section {
            margin-top: 60px;
            text-align: center;
        }
        .result-stats {
            background: #262633;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            margin: 30px auto;
        }
        .result-stats h3 { color: #9c28a7; margin-top: 0; }
        .action-btn {
            margin: 10px;
            padding: 12px 25px;
            border-radius: 10px;
            background: #3a3a50;
            border: none;
            cursor: pointer;
            color: #f0f0f0;
            transition: 0.25s;
        }
        .action-btn:hover { background: #4e4e6a; }
        .leaderboard-section {
            background: #262633;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow: hidden;
        }
        .leaderboard-section .leaderboard-title {
            text-align: center;
            margin-bottom: 15px;
            color: #9c28a7;
            font-size: 1.3em;
        }
        .leaderboard-section .leaderboard-list {
            max-height: 320px;
            overflow-y: auto;
        }
        .leaderboard-section .leaderboard-list::-webkit-scrollbar {
            width: 8px;
        }
        .leaderboard-section .leaderboard-list::-webkit-scrollbar-track {
            background: #1e1e29;
            border-radius: 4px;
        }
        .leaderboard-section .leaderboard-list::-webkit-scrollbar-thumb {
            background: #9c28a7;
            border-radius: 4px;
        }
        .leaderboard-section .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 6px 0;
            background: #2c2c3a;
            border-radius: 8px;
        }
        .leaderboard-section .leaderboard-rank { font-size: 1.1em; font-weight: bold; width: 30px; }
        .leaderboard-section .leaderboard-name { flex: 1; font-weight: 500; }
        .leaderboard-section .leaderboard-score { font-size: 1em; color: #9c28a7; font-weight: bold; }
    </style>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-left">
                <span class="nav-title">üéØ Quiz Master</span>
                <button id="back-btn" class="action-btn" style="margin-left:10px;">Retour</button>
            </div>
            <div class="nav-right hidden" id="nav-logged-in">
                <div class="user-info">
                    <div class="user-stats">
                        <div><strong id="user-pseudo">Joueur</strong></div>
                        <div>Score Global: <strong id="user-global-score">0</strong></div>
                    </div>
                    <button class="action-btn" onclick="window.location.href='settings.html'" style="margin-left:10px;">R√©glages</button>
                    <button class="logout-btn" onclick="logout()">D√©connexion</button>
                </div>
            </div>
        </nav>
    </header>
    <main>
        <section id="quiz-section" class="hidden">
            <div class="quiz-container">
                <div class="question-box">
                    <div id="question">[Question]</div>
                </div>
                <div class="answers-container">
                    <button class="answer-btn"></button>
                    <button class="answer-btn"></button>
                    <button class="answer-btn"></button>
                    <button class="answer-btn"></button>
                    <button class="answer-btn"></button>
                </div>
                <!-- Leaderboard desktop -->
                <div id="leaderboard-section" class="desktop leaderboard-section">
                    <h3 class="leaderboard-title">üèÜ Classement</h3>
                    <div class="leaderboard-list">
                        <div style="text-align: center; opacity: 0.6;">Chargement...</div>
                    </div>
                </div>
            </div>
            <div id="timers-container">
                <div id="timer-bar-container">
                    <span>‚è±Ô∏è Temps restant : <span id="timer">0</span>s</span>
                    <div id="timer-bar"><div id="timer-fill"></div></div>
                </div>
                <div id="question-timer-bar-container">
                    <span>‚ö° Question : <span id="question-timer">0</span>s</span>
                    <div id="question-timer-bar"><div id="question-timer-fill"></div></div>
                </div>
            </div>
            <div id="score-lives">
                <div>Score : <span id="score">0</span></div>
                <div id="lives">‚ù§‚ù§‚ù§</div>
            </div>
            <!-- Mobile UI row (leaderboard + retour) -->
            <div id="mobile-quiz-ui-row">
                <div id="leaderboard-section" class="mobile leaderboard-section">
                    <h3 class="leaderboard-title">üèÜ Classement</h3>
                    <div class="leaderboard-list">
                        <div style="text-align: center; opacity: 0.6;">Chargement...</div>
                    </div>
                </div>
                <div id="mobile-back-container">
                    <button id="mobile-back-btn" class="action-btn">‚Üê</button>
                </div>
            </div>
        </section>
        <section id="result-section" class="hidden">
            <h2>Partie termin√©e ! üéâ</h2>
            <div class="result-stats">
                <h3>R√©sum√©</h3>
                <p>Score de la partie : <strong id="final-score">0</strong></p>
                <p>Nouveau score global : <strong id="new-global-score">0</strong></p>
                <p>Score anglais : <strong id="new-dept-score">0</strong></p>
                <p>Quiz compl√©t√©s : <strong id="new-quiz-completed">0</strong></p>
                <div id="level-up-msg" class="hidden" style="color: #2ecc71; margin-top: 15px; font-weight: bold;">
                    üéä NIVEAU SUP√âRIEUR ATTEINT !
                </div>
            </div>
            <button id="restart-btn" class="action-btn">Rejouer</button>
            <button id="home-btn" class="action-btn">Accueil</button>
        </section>
    </main>
    <div id="hover-warning"></div>
    <script type="module">
        // üîß INITIALISATION FIREBASE
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, updateDoc, collection, query, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        const firebaseConfig = {
            apiKey: "AIzaSyDytQnPS_ZVbVuTkS8m3iUAOGMgm64A0XE",
            authDomain: "quiz-master-io.firebaseapp.com",
            projectId: "quiz-master-io",
            storageBucket: "quiz-master-io.firebasestorage.app",
            messagingSenderId: "773382469164",
            appId: "1:773382469164:web:5e24a9a62ce543f5190389"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        window.auth = auth;
        window.db = db;
        window.currentUser = null;

        function computeGlobalScore(quizScores) {
            const keys = [
                'departements', 'chinois', 'medecine', 'math', 'anglais',
                'neerlandais', 'allemand', 'italien', 'espagnol',
                'geographie', 'animaux'
            ];
            return keys.reduce((sum, key) => sum + (quizScores[key] || 0), 0);
        }

        const mode = { time: 60, qTime: 5, lives: 3 };
        const irregularVerbs = [
          { base: "arise", past: "arose", ppart: "arisen", fr: "survenir" },
          { base: "awake", past: "awoke", ppart: "awoken", fr: "se r√©veiller" },
          { base: "be", past: "was/were", ppart: "been", fr: "√™tre" },
          { base: "bear", past: "bore", ppart: "borne/born", fr: "porter/supporter" },
          { base: "beat", past: "beat", ppart: "beaten", fr: "battre" },
          { base: "become", past: "became", ppart: "become", fr: "devenir" },
          { base: "begin", past: "began", ppart: "begun", fr: "commencer" },
          { base: "bend", past: "bent", ppart: "bent", fr: "plier" },
          { base: "bet", past: "bet", ppart: "bet", fr: "parier" },
          { base: "bind", past: "bound", ppart: "bound", fr: "lier" },
          { base: "bite", past: "bit", ppart: "bitten", fr: "mordre" },
          { base: "bleed", past: "bled", ppart: "bled", fr: "saigner" },
          { base: "blow", past: "blew", ppart: "blown", fr: "souffler" },
          { base: "break", past: "broke", ppart: "broken", fr: "casser" },
          { base: "breed", past: "bred", ppart: "bred", fr: "√©lever (animaux)" },
          { base: "bring", past: "brought", ppart: "brought", fr: "apporter" },
          { base: "broadcast", past: "broadcast", ppart: "broadcast", fr: "diffuser" },
          { base: "build", past: "built", ppart: "built", fr: "construire" },
          { base: "burn", past: "burnt/burned", ppart: "burnt/burned", fr: "br√ªler" },
          { base: "burst", past: "burst", ppart: "burst", fr: "√©clater" },
          { base: "buy", past: "bought", ppart: "bought", fr: "acheter" },
          { base: "cast", past: "cast", ppart: "cast", fr: "jeter" },
          { base: "catch", past: "caught", ppart: "caught", fr: "attraper" },
          { base: "choose", past: "chose", ppart: "chosen", fr: "choisir" },
          { base: "cling", past: "clung", ppart: "clung", fr: "s'accrocher" },
          { base: "come", past: "came", ppart: "come", fr: "venir" },
          { base: "cost", past: "cost", ppart: "cost", fr: "co√ªter" },
          { base: "creep", past: "crept", ppart: "crept", fr: "ramper" },
          { base: "cut", past: "cut", ppart: "cut", fr: "couper" },
          { base: "deal", past: "dealt", ppart: "dealt", fr: "distribuer" },
          { base: "dig", past: "dug", ppart: "dug", fr: "creuser" },
          { base: "do", past: "did", ppart: "done", fr: "faire" },
          { base: "draw", past: "drew", ppart: "drawn", fr: "dessiner/tirer" },
          { base: "dream", past: "dreamt/dreamed", ppart: "dreamt/dreamed", fr: "r√™ver" },
          { base: "drink", past: "drank", ppart: "drunk", fr: "boire" },
          { base: "drive", past: "drove", ppart: "driven", fr: "conduire" },
          { base: "dwell", past: "dwelt", ppart: "dwelt", fr: "habiter" },
          { base: "eat", past: "ate", ppart: "eaten", fr: "manger" },
          { base: "fall", past: "fell", ppart: "fallen", fr: "tomber" },
          { base: "feed", past: "fed", ppart: "fed", fr: "nourrir" },
          { base: "feel", past: "felt", ppart: "felt", fr: "sentir" },
          { base: "fight", past: "fought", ppart: "fought", fr: "se battre" },
          { base: "find", past: "found", ppart: "found", fr: "trouver" },
          { base: "flee", past: "fled", ppart: "fled", fr: "fuir" },
          { base: "fling", past: "flung", ppart: "flung", fr: "lancer violemment" },
          { base: "fly", past: "flew", ppart: "flown", fr: "voler" },
          { base: "forbid", past: "forbade", ppart: "forbidden", fr: "interdire" },
          { base: "forget", past: "forgot", ppart: "forgotten", fr: "oublier" },
          { base: "forgive", past: "forgave", ppart: "forgiven", fr: "pardonner" },
          { base: "freeze", past: "froze", ppart: "frozen", fr: "geler" },
          { base: "get", past: "got", ppart: "got/gotten", fr: "obtenir" },
          { base: "give", past: "gave", ppart: "given", fr: "donner" },
          { base: "go", past: "went", ppart: "gone", fr: "aller" },
          { base: "grind", past: "ground", ppart: "ground", fr: "moudre" },
          { base: "grow", past: "grew", ppart: "grown", fr: "grandir" },
          { base: "hang", past: "hung", ppart: "hung", fr: "pendre" },
          { base: "have", past: "had", ppart: "had", fr: "avoir" },
          { base: "hear", past: "heard", ppart: "heard", fr: "entendre" },
          { base: "hide", past: "hid", ppart: "hidden", fr: "cacher" },
          { base: "hit", past: "hit", ppart: "hit", fr: "frapper" },
          { base: "hold", past: "held", ppart: "held", fr: "tenir" },
          { base: "hurt", past: "hurt", ppart: "hurt", fr: "blesser" },
          { base: "keep", past: "kept", ppart: "kept", fr: "garder" },
          { base: "kneel", past: "knelt", ppart: "knelt", fr: "s'agenouiller" },
          { base: "knit", past: "knit", ppart: "knit", fr: "tricoter" },
          { base: "know", past: "knew", ppart: "known", fr: "savoir/conna√Ætre" },
          { base: "lay", past: "laid", ppart: "laid", fr: "poser" },
          { base: "lead", past: "led", ppart: "led", fr: "mener" },
          { base: "lean", past: "leant/leaned", ppart: "leant/leaned", fr: "se pencher" },
          { base: "leap", past: "leapt/leaped", ppart: "leapt/leaped", fr: "sauter" },
          { base: "learn", past: "learnt/learned", ppart: "learnt/learned", fr: "apprendre" },
          { base: "leave", past: "left", ppart: "left", fr: "laisser/quitter" },
          { base: "lend", past: "lent", ppart: "lent", fr: "pr√™ter" },
          { base: "let", past: "let", ppart: "let", fr: "permettre" },
          { base: "lie", past: "lay", ppart: "lain", fr: "√™tre allong√©" },
          { base: "light", past: "lit/lighted", ppart: "lit/lighted", fr: "allumer" },
          { base: "lose", past: "lost", ppart: "lost", fr: "perdre" },
          { base: "make", past: "made", ppart: "made", fr: "fabriquer" },
          { base: "mean", past: "meant", ppart: "meant", fr: "signifier" },
          { base: "meet", past: "met", ppart: "met", fr: "rencontrer" },
          { base: "pay", past: "paid", ppart: "paid", fr: "payer" },
          { base: "put", past: "put", ppart: "put", fr: "mettre" },
          { base: "quit", past: "quit", ppart: "quit", fr: "abandonner" },
          { base: "read", past: "read", ppart: "read", fr: "lire" },
          { base: "ride", past: "rode", ppart: "ridden", fr: "chevaucher" },
          { base: "ring", past: "rang", ppart: "rung", fr: "sonner" },
          { base: "rise", past: "rose", ppart: "risen", fr: "s'√©lever" },
          { base: "run", past: "ran", ppart: "run", fr: "courir" },
          { base: "say", past: "said", ppart: "said", fr: "dire" },
          { base: "see", past: "saw", ppart: "seen", fr: "voir" },
          { base: "sell", past: "sold", ppart: "sold", fr: "vendre" },
          { base: "send", past: "sent", ppart: "sent", fr: "envoyer" },
          { base: "set", past: "set", ppart: "set", fr: "placer" },
          { base: "sew", past: "sewed", ppart: "sewn/sewed", fr: "coudre" },
          { base: "shake", past: "shook", ppart: "shaken", fr: "secouer" },
          { base: "shine", past: "shone", ppart: "shone", fr: "briller" },
          { base: "shoot", past: "shot", ppart: "shot", fr: "tirer" },
          { base: "show", past: "showed", ppart: "shown", fr: "montrer" },
          { base: "shrink", past: "shrank", ppart: "shrunk", fr: "r√©tr√©cir" },
          { base: "shut", past: "shut", ppart: "shut", fr: "fermer" },
          { base: "sing", past: "sang", ppart: "sung", fr: "chanter" },
          { base: "sink", past: "sank", ppart: "sunk", fr: "couler" },
          { base: "sit", past: "sat", ppart: "sat", fr: "s'asseoir" },
          { base: "sleep", past: "slept", ppart: "slept", fr: "dormir" },
          { base: "slide", past: "slid", ppart: "slid", fr: "glisser" },
          { base: "sling", past: "slung", ppart: "slung", fr: "lancer (bras)" },
          { base: "speak", past: "spoke", ppart: "spoken", fr: "parler" },
          { base: "spend", past: "spent", ppart: "spent", fr: "d√©penser/passer" },
          { base: "spin", past: "spun", ppart: "spun", fr: "tourner" },
          { base: "spread", past: "spread", ppart: "spread", fr: "√©taler" },
          { base: "spring", past: "sprang", ppart: "sprung", fr: "bondir" },
          { base: "stand", past: "stood", ppart: "stood", fr: "se tenir debout" },
          { base: "steal", past: "stole", ppart: "stolen", fr: "voler" },
          { base: "stick", past: "stuck", ppart: "stuck", fr: "coller" },
          { base: "sting", past: "stung", ppart: "stung", fr: "piquer" },
          { base: "stink", past: "stank", ppart: "stunk", fr: "puer" },
          { base: "strike", past: "struck", ppart: "struck/stricken", fr: "frapper" },
          { base: "swear", past: "swore", ppart: "sworn", fr: "jurer" },
          { base: "sweep", past: "swept", ppart: "swept", fr: "balayer" },
          { base: "swim", past: "swam", ppart: "swum", fr: "nager" },
          { base: "take", past: "took", ppart: "taken", fr: "prendre" },
          { base: "teach", past: "taught", ppart: "taught", fr: "enseigner" },
          { base: "tear", past: "tore", ppart: "torn", fr: "d√©chirer" },
          { base: "tell", past: "told", ppart: "told", fr: "raconter/dire" },
          { base: "think", past: "thought", ppart: "thought", fr: "penser" },
          { base: "throw", past: "threw", ppart: "thrown", fr: "jeter" },
          { base: "thrust", past: "thrust", ppart: "thrust", fr: "pousser violemment" },
          { base: "understand", past: "understood", ppart: "understood", fr: "comprendre" },
          { base: "uphold", past: "upheld", ppart: "upheld", fr: "maintenir" },
          { base: "wake", past: "woke", ppart: "woken", fr: "r√©veiller" },
          { base: "wear", past: "wore", ppart: "worn", fr: "porter (v√™tement)" },
          { base: "weep", past: "wept", ppart: "wept", fr: "pleurer" },
          { base: "win", past: "won", ppart: "won", fr: "gagner" },
          { base: "write", past: "wrote", ppart: "written", fr: "√©crire" }
        ];
        const type5Questions = [
            { en: "He has written a letter", correct: "Il a √©crit une lettre", choices: ["Il a √©crit une lettre", "Il √©crivait une lettre", "Il √©crira une lettre", "Il avait √©crit une lettre", "Il √©crit une lettre"] },
            { en: "They have broken the window", correct: "Ils ont cass√© la fen√™tre", choices: ["Ils ont cass√© la fen√™tre", "Ils cassaient la fen√™tre", "Ils vont casser la fen√™tre", "Ils avaient cass√© la fen√™tre", "Ils cassent la fen√™tre"] },
            { en: "She has drunk too much coffee", correct: "Elle a bu trop de caf√©", choices: ["Elle a bu trop de caf√©", "Elle buvait trop de caf√©", "Elle boira trop de caf√©", "Elle avait bu trop de caf√©", "Elle boit trop de caf√©"] },
            { en: "We have seen this movie before", correct: "Nous avons d√©j√† vu ce film", choices: ["Nous avons d√©j√† vu ce film", "Nous voyons d√©j√† ce film", "Nous verrons ce film", "Nous avions d√©j√† vu ce film", "Nous voyions ce film"] },
            { en: "I have lost my keys", correct: "J'ai perdu mes cl√©s", choices: ["J'ai perdu mes cl√©s", "Je perds mes cl√©s", "Je perdais mes cl√©s", "J'avais perdu mes cl√©s", "Je vais perdre mes cl√©s"] },
            { en: "He has spoken to the manager", correct: "Il a parl√© au responsable", choices: ["Il a parl√© au responsable", "Il parlait au responsable", "Il parle au responsable", "Il avait parl√© au responsable", "Il va parler au responsable"] },
            { en: "They have built a new house", correct: "Ils ont construit une nouvelle maison", choices: ["Ils ont construit une nouvelle maison", "Ils construisaient une nouvelle maison", "Ils avaient construit une nouvelle maison", "Ils construisent une nouvelle maison", "Ils vont construire une nouvelle maison"] },
            { en: "She has chosen the red dress", correct: "Elle a choisi la robe rouge", choices: ["Elle a choisi la robe rouge", "Elle choisit la robe rouge", "Elle choisissait la robe rouge", "Elle avait choisi la robe rouge", "Elle va choisir la robe rouge"] },
            { en: "We have met him before", correct: "Nous l'avons d√©j√† rencontr√©", choices: ["Nous l'avons d√©j√† rencontr√©", "Nous le rencontrons d√©j√†", "Nous allons le rencontrer", "Nous l'avions d√©j√† rencontr√©", "Nous le rencontrions"] },
            { en: "I have slept very well", correct: "J'ai tr√®s bien dormi", choices: ["J'ai tr√®s bien dormi", "Je dors tr√®s bien", "Je dormais tr√®s bien", "J'avais tr√®s bien dormi", "Je vais tr√®s bien dormir"] },
            { en: "He has sold his car", correct: "Il a vendu sa voiture", choices: ["Il a vendu sa voiture", "Il vend sa voiture", "Il vendait sa voiture", "Il avait vendu sa voiture", "Il va vendre sa voiture"] },
            { en: "They have bought new shoes", correct: "Ils ont achet√© de nouvelles chaussures", choices: ["Ils ont achet√© de nouvelles chaussures", "Ils ach√®tent de nouvelles chaussures", "Ils achetaient de nouvelles chaussures", "Ils avaient achet√© de nouvelles chaussures", "Ils vont acheter de nouvelles chaussures"] },
            { en: "She has driven all night", correct: "Elle a conduit toute la nuit", choices: ["Elle a conduit toute la nuit", "Elle conduit toute la nuit", "Elle conduisait toute la nuit", "Elle avait conduit toute la nuit", "Elle va conduire toute la nuit"] },
            { en: "We have learned something new", correct: "Nous avons appris quelque chose de nouveau", choices: ["Nous avons appris quelque chose de nouveau", "Nous apprenons quelque chose de nouveau", "Nous apprenions quelque chose de nouveau", "Nous avions appris quelque chose de nouveau", "Nous allons apprendre quelque chose de nouveau"] },
            { en: "I have felt very tired lately", correct: "Je me suis senti tr√®s fatigu√© derni√®rement", choices: ["Je me suis senti tr√®s fatigu√© derni√®rement", "Je me sens tr√®s fatigu√© derni√®rement", "Je me sentais tr√®s fatigu√© derni√®rement", "Je m'√©tais senti tr√®s fatigu√© derni√®rement", "Je vais me sentir tr√®s fatigu√©"] },
            { en: "He has kept his promise", correct: "Il a tenu sa promesse", choices: ["Il a tenu sa promesse", "Il tient sa promesse", "Il tenait sa promesse", "Il avait tenu sa promesse", "Il va tenir sa promesse"] },
            { en: "They have won the game", correct: "Ils ont gagn√© le match", choices: ["Ils ont gagn√© le match", "Ils gagnent le match", "Ils gagnaient le match", "Ils avaient gagn√© le match", "Ils vont gagner le match"] },
            { en: "She has rung the bell", correct: "Elle a sonn√© la cloche", choices: ["Elle a sonn√© la cloche", "Elle sonne la cloche", "Elle sonnait la cloche", "Elle avait sonn√© la cloche", "Elle va sonner la cloche"] },
            { en: "We have flown over the mountains", correct: "Nous avons vol√© au-dessus des montagnes", choices: ["Nous avons vol√© au-dessus des montagnes", "Nous volons au-dessus des montagnes", "Nous volions au-dessus des montages", "Nous avions vol√© au-dessus des montagnes", "Nous allons voler au-dessus des montagnes"] },
            { en: "I have spoken to her already", correct: "Je lui ai d√©j√† parl√©", choices: ["Je lui ai d√©j√† parl√©", "Je lui parle d√©j√†", "Je lui parlais", "Je lui avais d√©j√† parl√©", "Je vais lui parler"] }
        ];
        const type2Questions = [
            { q: "What is the past simple of 'eat'?", a: "ate" },
            { q: "What is the past participle of 'eat'?", a: "eaten" },
            { q: "What is the past simple of 'see'?", a: "saw" },
            { q: "What is the past participle of 'see'?", a: "seen" },
            { q: "What is the past simple of 'take'?", a: "took" },
            { q: "What is the past participle of 'take'?", a: "taken" },
            { q: "What is the past simple of 'break'?", a: "broke" },
            { q: "What is the past participle of 'break'?", a: "broken" },
            { q: "What is the past simple of 'write'?", a: "wrote" },
            { q: "What is the past participle of 'write'?", a: "written" },
            { q: "What is the past simple of 'give'?", a: "gave" },
            { q: "What is the past participle of 'give'?", a: "given" },
            { q: "What is the past simple of 'drink'?", a: "drank" },
            { q: "What is the past participle of 'drink'?", a: "drunk" },
            { q: "What is the past simple of 'drive'?", a: "drove" },
            { q: "What is the past participle of 'drive'?", a: "driven" },
            { q: "What is the past simple of 'speak'?", a: "spoke" },
            { q: "What is the past participle of 'speak'?", a: "spoken" },
            { q: "What is the past simple of 'choose'?", a: "chose" },
            { q: "What is the past participle of 'choose'?", a: "chosen" }
        ];

        let score = 0, lives = 0, timeLeft = 0, qTime = 0;
        let timerInterval = null, qTimerInterval = null, awaitingNext = false;
        let currentQuestionData = null;
        let gameCompleted = false;

        const quizSection = document.getElementById('quiz-section');
        const resultSection = document.getElementById('result-section');
        const backBtn = document.getElementById('back-btn');
        const mobileBackBtn = document.getElementById('mobile-back-btn');
        const answerBtns = document.querySelectorAll('.answer-btn');
        const questionBox = document.getElementById('question');
        const scoreDisplay = document.getElementById('score');
        const livesDisplay = document.getElementById('lives');
        const timerDisplay = document.getElementById('timer');
        const qTimerDisplay = document.getElementById('question-timer');
        const timerFill = document.getElementById('timer-fill');
        const qTimerFill = document.getElementById('question-timer-fill');

        function updateQuizHeaderVisibility(isQuizActive) {
            if (window.innerWidth <= 899) {
                document.body.classList.toggle('quiz-active', isQuizActive);
                mobileBackBtn.classList.toggle('hidden', !isQuizActive);
            } else {
                mobileBackBtn.classList.add('hidden');
            }
        }

        async function saveCurrentScore() {
            if (!window.currentUser || score <= 0 || gameCompleted) return;
            try {
                const quizKey = 'anglais';
                const userDocRef = doc(db, 'users', currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                let userData = userDoc.data();
                const defaultQuizScores = {
                    departements: 0, chinois: 0, medecine: 0, math: 0, anglais: 0,
                    neerlandais: 0, allemand: 0, italien: 0, espagnol: 0,
                    geographie: 0, animaux: 0
                };
                if (!userData) {
                    userData = {
                        pseudo: currentUser.email.split('@')[0],
                        email: currentUser.email,
                        quizScores: defaultQuizScores,
                        quizCompleted: 0,
                        createdAt: new Date().toISOString()
                    };
                    await setDoc(userDocRef, userData);
                }
                const quizScores = { ...(userData.quizScores || defaultQuizScores) };
                const oldDeptScore = quizScores[quizKey] || 0;
                const newDeptScore = oldDeptScore + score;
                quizScores[quizKey] = newDeptScore;
                const newGlobalScore = computeGlobalScore(quizScores);
                await updateDoc(userDocRef, { quizScores });
                localStorage.setItem('globalScore', newGlobalScore);
                document.getElementById('user-global-score').textContent = newGlobalScore;
            } catch (error) {
                console.error('Erreur sauvegarde partielle:', error);
            }
        }

        backBtn.onclick = async function () {
            await saveCurrentScore();
            stopAllTimers();
            quizSection.classList.add('hidden');
            window.location.href = 'index.html';
        };
        mobileBackBtn.onclick = backBtn.onclick;

        function generateRandomQuestion() {
            const questionType = Math.floor(Math.random() * 4);
            if (questionType === 0) {
                const randomIndex = Math.floor(Math.random() * irregularVerbs.length);
                const verb = irregularVerbs[randomIndex];
                const questionTypes = ['past', 'ppart', 'base'];
                const qType = questionTypes[Math.floor(Math.random() * questionTypes.length)];
                let question, correctAnswer, options;
                if (qType === 'past') {
                    question = `Quel est le pr√©t√©rit de "${verb.base}" ?`;
                    correctAnswer = verb.past;
                } else if (qType === 'ppart') {
                    question = `Quel est le participe pass√© de "${verb.base}" ?`;
                    correctAnswer = verb.ppart;
                } else {
                    question = `Quel est l'infinitif de "${verb.past}" ?`;
                    correctAnswer = verb.base;
                }
                options = [correctAnswer];
                let availableVerbs = irregularVerbs.filter(v => v !== verb);
                for (let i = 0; i < 4 && availableVerbs.length > 0; i++) {
                    const randomIdx = Math.floor(Math.random() * availableVerbs.length);
                    const randomVerb = availableVerbs[randomIdx];
                    availableVerbs.splice(randomIdx, 1);
                    if (qType === 'past') {
                        options.push(randomVerb.past);
                    } else if (qType === 'ppart') {
                        options.push(randomVerb.ppart);
                    } else {
                        options.push(randomVerb.base);
                    }
                }
                options = options.sort(() => Math.random() - 0.5);
                return { q: question, a: correctAnswer, opts: options };
            } else if (questionType === 1) {
                const randomIndex = Math.floor(Math.random() * irregularVerbs.length);
                const verb = irregularVerbs[randomIndex];
                const question = `Quelle est la traduction de "${verb.base}" ?`;
                const correctAnswer = verb.fr;
                const options = [correctAnswer];
                let availableVerbs = irregularVerbs.filter(v => v !== verb);
                for (let i = 0; i < 4 && availableVerbs.length > 0; i++) {
                    const randomIdx = Math.floor(Math.random() * availableVerbs.length);
                    const randomVerb = availableVerbs[randomIdx];
                    availableVerbs.splice(randomIdx, 1);
                    options.push(randomVerb.fr);
                }
                options = options.sort(() => Math.random() - 0.5);
                return { q: question, a: correctAnswer, opts: options };
            } else if (questionType === 2) {
                const randomIndex = Math.floor(Math.random() * type2Questions.length);
                const q = type2Questions[randomIndex];
                const question = q.q;
                const correctAnswer = q.a;
                let options = [correctAnswer];
                let otherForms = [];
                irregularVerbs.forEach(v => {
                    if (v.past !== correctAnswer && v.ppart !== correctAnswer && v.base !== correctAnswer) {
                        otherForms.push(v.past, v.ppart);
                    }
                });
                otherForms = [...new Set(otherForms)].sort(() => Math.random() - 0.5).slice(0, 4);
                options = [...options, ...otherForms].slice(0, 5);
                options = options.sort(() => Math.random() - 0.5);
                return { q: question, a: correctAnswer, opts: options };
            } else {
                const randomIndex = Math.floor(Math.random() * type5Questions.length);
                const q = type5Questions[randomIndex];
                const question = `Traduisez : "${q.en}"`;
                const correctAnswer = q.correct;
                const options = [...q.choices].sort(() => Math.random() - 0.5);
                return { q: question, a: correctAnswer, opts: options };
            }
        }

        function startMode() {
            stopAllTimers();
            score = 0;
            lives = mode.lives;
            timeLeft = mode.time;
            qTime = mode.qTime;
            awaitingNext = false;
            updateLives();
            scoreDisplay.textContent = score;
            resultSection.classList.add('hidden');
            quizSection.classList.remove('hidden');
            updateQuizHeaderVisibility(true);
            loadLeaderboard();
            generateQuestion();
            startMainTimer();
        }

        function generateQuestion() {
            if (awaitingNext) return;
            const qData = generateRandomQuestion();
            currentQuestionData = qData;
            qTime = mode.qTime;
            qTimerDisplay.textContent = qTime.toFixed(1);
            qTimerFill.style.width = '100%';
            questionBox.innerHTML = qData.q;
            const opts = qData.opts.slice(0, 5);
            answerBtns.forEach((btn, i) => {
                if (i < 5) {
                    btn.innerHTML = opts[i] || "‚Äì";
                    btn.dataset.value = opts[i] || "";
                    btn.disabled = false;
                    btn.classList.remove("correct", "incorrect");
                    btn.onclick = () => handleAnswer(opts[i]);
                    btn.style.display = '';
                } else {
                    btn.style.display = 'none';
                }
            });
            setTimeout(() => {
                if (!awaitingNext) startQTimer();
            }, 100);
        }

        function handleAnswer(selected) {
            if (awaitingNext) return;
            awaitingNext = true;
            clearInterval(qTimerInterval);
            answerBtns.forEach(btn => {
                btn.disabled = true;
                if (btn.dataset.value === currentQuestionData.a) {
                    btn.classList.add("correct");
                }
                if (btn.dataset.value === selected && selected !== currentQuestionData.a) {
                    btn.classList.add("incorrect");
                }
            });
            if (selected === currentQuestionData.a) {
                score++;
            } else {
                lives--;
            }
            updateLives();
            scoreDisplay.textContent = score;
            setTimeout(() => {
                awaitingNext = false;
                if (lives <= 0) endGame();
                else generateQuestion();
            }, 1000);
        }

        function updateLives() {
            const safeLives = Math.max(0, lives);
            const maxLives = mode.lives;
            livesDisplay.textContent = '‚ù§'.repeat(safeLives) + '‚ô°'.repeat(Math.max(0, maxLives - safeLives));
        }

        function startMainTimer() {
            timerDisplay.textContent = timeLeft;
            timerFill.style.width = '100%';
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                timerFill.style.width = (timeLeft / mode.time * 100) + '%';
                if (timeLeft <= 5) timerFill.style.background = '#dc3545';
                else if (timeLeft <= 10) timerFill.style.background = '#ffa500';
                else timerFill.style.background = '#9c28a7ff';
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame();
                }
            }, 1000);
        }

        function startQTimer() {
            clearInterval(qTimerInterval);
            const qStartTime = mode.qTime;
            qTime = qStartTime;
            qTimerInterval = setInterval(() => {
                qTime -= 0.1;
                qTimerDisplay.textContent = qTime.toFixed(1);
                const percent = Math.max(0, qTime / qStartTime) * 100;
                qTimerFill.style.width = percent + '%';
                if (qTime <= 0) {
                    clearInterval(qTimerInterval);
                    handleAnswer('');
                }
            }, 100);
        }

        async function endGame() {
            if (gameCompleted) return;
            gameCompleted = true;
            quizSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
            updateQuizHeaderVisibility(false);
            document.getElementById('final-score').textContent = score;
            stopAllTimers();
            try {
                if (!window.currentUser) throw new Error('Utilisateur non connect√©');
                const quizKey = 'anglais';
                const userDocRef = doc(db, 'users', currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                let userData = userDoc.data();
                const defaultQuizScores = {
                    departements: 0, chinois: 0, medecine: 0, math: 0, anglais: 0,
                    neerlandais: 0, allemand: 0, italien: 0, espagnol: 0,
                    geographie: 0, animaux: 0
                };
                if (!userData) {
                    userData = {
                        pseudo: currentUser.email.split('@')[0],
                        email: currentUser.email,
                        quizScores: defaultQuizScores,
                        quizCompleted: 0,
                        createdAt: new Date().toISOString()
                    };
                    await setDoc(userDocRef, userData);
                }
                const quizScores = { ...(userData.quizScores || defaultQuizScores) };
                const oldDeptScore = quizScores[quizKey] || 0;
                const newDeptScore = oldDeptScore + score;
                quizScores[quizKey] = newDeptScore;
                const newGlobalScore = computeGlobalScore(quizScores);
                let quizCompleted = userData.quizCompleted || 0;
                if (lives > 0) quizCompleted += 1;
                await updateDoc(userDocRef, { quizScores, quizCompleted });
                localStorage.setItem('globalScore', newGlobalScore);
                localStorage.setItem('quizCompleted', quizCompleted);
                document.getElementById('new-global-score').textContent = newGlobalScore;
                document.getElementById('new-dept-score').textContent = newDeptScore;
                document.getElementById('new-quiz-completed').textContent = quizCompleted;
                const oldLevel = Math.floor(oldDeptScore / 50);
                const newLevel = Math.floor(newDeptScore / 50);
                if (newLevel > oldLevel) {
                    document.getElementById('level-up-msg').classList.remove('hidden');
                } else {
                    document.getElementById('level-up-msg').classList.add('hidden');
                }
            } catch (error) {
                console.error('Erreur sauvegarde fin de partie:', error);
                alert('Erreur lors de la sauvegarde.');
            }
        }

        function stopAllTimers() {
            clearInterval(timerInterval);
            clearInterval(qTimerInterval);
        }

        const restartBtn = document.getElementById('restart-btn');
        const homeBtn = document.getElementById('home-btn');
        restartBtn.onclick = () => {
            gameCompleted = false;
            startMode();
        };
        homeBtn.onclick = async function () {
            await saveCurrentScore();
            stopAllTimers();
            resultSection.classList.add('hidden');
            window.location.href = 'index.html';
        };

        window.logout = async function () {
            await signOut(auth);
            window.location.href = 'index.html';
        };

        async function loadLeaderboard() {
            const mobileList = document.querySelector('#leaderboard-section.mobile .leaderboard-list');
            const desktopList = document.querySelector('#leaderboard-section.desktop .leaderboard-list');
            const placeholder = '<div style="text-align: center; opacity: 0.6;">Chargement...</div>';
            if (mobileList) mobileList.innerHTML = placeholder;
            if (desktopList) desktopList.innerHTML = placeholder;
            try {
                const q = query(collection(db, 'users'), orderBy('quizScores.anglais', 'desc'), limit(10));
                const querySnapshot = await getDocs(q);
                let rank = 1;
                let html = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data() || {};
                    const pseudo = data.pseudo || 'Anonyme';
                    const score = data.quizScores?.anglais || 0;
                    let medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
                    html += `<div class="leaderboard-item">
                        <div class="leaderboard-rank">${medal || rank}</div>
                        <div class="leaderboard-name">${pseudo}</div>
                        <div class="leaderboard-score">${score}</div>
                    </div>`;
                    rank++;
                });
                const finalHtml = html || '<div style="text-align: center; opacity: 0.6;">Aucun joueur</div>';
                if (mobileList) mobileList.innerHTML = finalHtml;
                if (desktopList) desktopList.innerHTML = finalHtml;
            } catch (error) {
                console.error('Erreur chargement leaderboard:', error);
                const errorMsg = '<div style="text-align: center; opacity: 0.6;">Erreur</div>';
                if (mobileList) mobileList.innerHTML = errorMsg;
                if (desktopList) desktopList.innerHTML = errorMsg;
            }
        }

        // üîë V√©rifie que l'utilisateur a au moins 100 points de score global
        onAuthStateChanged(auth, async (user) => {
            const navLoggedIn = document.getElementById('nav-logged-in');
            if (user) {
                window.currentUser = user;
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                const pseudoEl = document.getElementById('user-pseudo');
                const scoreEl = document.getElementById('user-global-score');
                let globalScore = 0;
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    const quizScores = data.quizScores || {};
                    pseudoEl.textContent = data.pseudo || user.email.split('@')[0];
                    globalScore = computeGlobalScore(quizScores);
                } else {
                    pseudoEl.textContent = user.email.split('@')[0];
                    globalScore = 0;
                }
                scoreEl.textContent = globalScore;
                localStorage.setItem('globalScore', globalScore);
                navLoggedIn.classList.remove('hidden');

                // üîí V√©rification d'acc√®s au Niveau 2 (score global ‚â• 100)
                if (globalScore < 100) {
                    alert("üí° Vous devez avoir au moins 100 points de score global pour acc√©der √† ce quiz.");
                    window.location.href = 'index.html';
                    return;
                }

                // D√©marrer le quiz
                startMode();
            } else {
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>

