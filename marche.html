<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Place du march√©</title>

<style>
  body { background: linear-gradient(135deg,#181a20,#23233a); color:#f0f0f0; font-family:'Segoe UI',Roboto,sans-serif; margin:0; }
  .center { max-width:900px;margin:30px auto;background:#23233a;border-radius:16px;padding:28px;box-shadow:0 8px 32px rgba(0,0,0,0.4); }
  h1{text-align:center;margin-bottom:14px;}
  .tabs { display:flex; gap:10px; margin-bottom:20px; }
  .tab { padding:10px 20px; background:#2e2e3d; border-radius:10px 10px 0 0; cursor:pointer; transition:0.2s; font-weight:500; }
  .tab.active, .tab:hover { background:#45455a; color:#fff; }
  .tab-content { display:none; background:#28284a; padding:18px; border-radius:0 10px 10px 10px; }
  .tab-content.active { display:block; }
  .action-btn { margin:6px 6px 6px 0; padding:8px 16px; border-radius:8px; background:#3a3a50; border:none; cursor:pointer; color:#f0f0f0; transition:0.25s; }
  .action-btn:hover { background:#4e4e6a; }
  .action-btn:disabled { opacity:0.5; cursor:not-allowed; }
  .res-item { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  #score-exchange { margin-bottom:20px; background:#3a3a50; padding:12px; border-radius:10px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .exchange-control { flex:1; min-width:220px; }
  .small { font-size:0.9em; color:#ddd; }
  input[type="number"], input[type="text"] { width:100%; padding:8px; border-radius:6px; border:none; background:#1c1c28; color:#eee; margin-top:6px; }
  input[type="range"] { width:100%; margin-top:6px; }
  .inline { display:flex; gap:8px; align-items:center; }
  .badge { background:#2e2e3d; padding:6px 10px; border-radius:8px; font-weight:600; }
  .muted { color:#bdbdbd; font-size:0.95em; }
  .loading { text-align:center; padding:20px; color:#aaa; }
  .error { background:#e74c3c; color:#fff; padding:10px; border-radius:8px; margin-bottom:15px; }
  .success { background:#2ecc71; color:#fff; padding:10px; border-radius:8px; margin-bottom:15px; display:none; }
</style>
</head>

<body>
<div class="center">
  <h1>üè™ Place du march√©</h1>

  <!-- Messages -->
  <div id="error-message" class="error" style="display:none;"></div>
  <div id="success-message" class="success"></div>
  <div id="loading" class="loading">Chargement des donn√©es...</div>

  <div id="main-content" style="display:none;">
    <!-- Info niveau -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <div class="muted">Niveau du march√© : <span id="marche-level" class="badge">1</span></div>
      <div class="muted">ID Joueur : <span id="player-id" class="badge" style="font-size:0.8em;">-</span></div>
    </div>

    <!-- √âchange Score ‚Üí Or : slider + inputs -->
    <div id="score-exchange">
      <div class="exchange-control">
        <div><strong>√âchanger des points (Score) contre de l'Or</strong></div>
        <div class="small">Taux : <strong>20 points ‚Üí 1 Or</strong></div>

        <!-- Slider (nombre d'or √† obtenir) -->
        <label style="margin-top:8px;">Or √† obtenir : <span id="gold-count-display">0</span></label>
        <input id="gold-slider" type="range" min="0" max="0" step="1" value="0">

        <!-- Entr√©es num√©riques synchronis√©es -->
        <div style="display:flex; gap:10px; margin-top:8px;">
          <div style="flex:1;">
            <label>Or (nombre)</label>
            <input type="number" id="input-gold" min="0" value="0">
          </div>
          <div style="flex:1;">
            <label>Points (score) √† d√©penser</label>
            <input type="number" id="input-score" min="0" step="20" value="0">
          </div>
        </div>
      </div>

      <div style="min-width:220px;">
        <div style="margin-bottom:8px;"><strong>Votre Or :</strong> <span id="display-or" class="badge">0</span></div>
        <div style="margin-bottom:8px;"><strong>Score Global :</strong> <span id="display-global-score" class="badge">0</span></div>
        <div style="margin-top:12px;">
          <button class="action-btn" id="btn-exchange-confirm">üí∞ √âchanger</button>
          <button class="action-btn" id="btn-sync-server">üîÑ Synchroniser</button>
        </div>
        <div style="margin-top:10px;" class="small">Tu peux utiliser le slider ou saisir une valeur. L'√©change est valid√© sur Firebase.</div>
      </div>
    </div>

    <!-- Onglets -->
    <div class="tabs" style="margin-top:6px;">
      <div class="tab active" data-tab="nourriture">üçé Nourriture</div>
      <div class="tab" data-tab="ressources">‚õè Ressources</div>
      <div class="tab" data-tab="strat">üíé Strat√©giques</div>
      <div class="tab" data-tab="confort">üõã Confort</div>
      <div class="tab" data-tab="militaire">‚öî Militaire</div>
    </div>

    <!-- Contenus des onglets -->
    <div id="nourriture" class="tab-content active">
      <p class="muted">Achats de nourriture √† venir...</p>
    </div>
    <div id="ressources" class="tab-content">
      <p class="muted">Achats de ressources √† venir...</p>
    </div>
    <div id="strat" class="tab-content">
      <p class="muted">Achats strat√©giques √† venir...</p>
    </div>
    <div id="confort" class="tab-content">
      <p class="muted">Achats de confort √† venir...</p>
    </div>
    <div id="militaire" class="tab-content">
      <p class="muted">Achats militaires √† venir...</p>
    </div>
  </div>
</div>

<!-- Firebase SDK (modular v9) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // ==========================================
  // CONFIGURATION FIREBASE
  // ==========================================
  // NOTE: L'apiKey peut √™tre expos√©e publiquement.
  // La s√©curit√© repose sur les r√®gles Firestore c√¥t√© serveur.
  // Remplace ces valeurs par ta vraie configuration Firebase
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  // Initialisation Firebase
  let app, db;
  try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    console.log("‚úÖ Firestore initialis√© avec succ√®s");
  } catch (error) {
    console.error("‚ùå Erreur initialisation Firebase:", error);
    showError("Impossible de se connecter √† Firebase. V√©rifiez votre configuration.");
  }

  // ==========================================
  // GESTION ID UTILISATEUR
  // ==========================================
  function getUserId() {
    let userId = localStorage.getItem('userId');
    if (!userId) {
      // G√©n√©ration d'un ID unique bas√© sur timestamp + random
      userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('userId', userId);
      console.log("üÜï Nouvel utilisateur cr√©√©:", userId);
    }
    return userId;
  }

  const userId = getUserId();
  document.getElementById('player-id').textContent = userId.substr(0, 15) + '...';

  // ==========================================
  // CONSTANTES
  // ==========================================
  const EXCHANGE_RATE = 20; // 20 points = 1 or
  const COLLECTION_NAME = 'users';

  // ==========================================
  // √âTAT DE L'APPLICATION
  // ==========================================
  let playerData = {
    gold: 0,
    globalScore: 0,
    marcheLevel: 1,
    lastSync: null
  };

  // ==========================================
  // √âL√âMENTS DOM
  // ==========================================
  const loadingEl = document.getElementById('loading');
  const mainContent = document.getElementById('main-content');
  const errorMessageEl = document.getElementById('error-message');
  const successMessageEl = document.getElementById('success-message');
  const displayOr = document.getElementById('display-or');
  const displayGlobalScore = document.getElementById('display-global-score');
  const marcheLevel = document.getElementById('marche-level');
  const goldSlider = document.getElementById('gold-slider');
  const goldCountDisplay = document.getElementById('gold-count-display');
  const inputGold = document.getElementById('input-gold');
  const inputScore = document.getElementById('input-score');
  const btnExchange = document.getElementById('btn-exchange-confirm');
  const btnSync = document.getElementById('btn-sync-server');

  // ==========================================
  // FONCTIONS UTILITAIRES
  // ==========================================
  function showError(message) {
    errorMessageEl.textContent = message;
    errorMessageEl.style.display = 'block';
    setTimeout(() => {
      errorMessageEl.style.display = 'none';
    }, 5000);
  }

  function showSuccess(message) {
    successMessageEl.textContent = message;
    successMessageEl.style.display = 'block';
    setTimeout(() => {
      successMessageEl.style.display = 'none';
    }, 3000);
  }

  function updateUI() {
    displayOr.textContent = playerData.gold;
    displayGlobalScore.textContent = playerData.globalScore;
    marcheLevel.textContent = playerData.marcheLevel;
    
    // Mise √† jour du slider max
    const maxGold = Math.floor(playerData.globalScore / EXCHANGE_RATE);
    goldSlider.max = maxGold;
    
    // Reset des valeurs si le score est insuffisant
    if (parseInt(inputGold.value) > maxGold) {
      inputGold.value = 0;
      inputScore.value = 0;
      goldSlider.value = 0;
      goldCountDisplay.textContent = '0';
    }
  }

  // ==========================================
  // HASH SHA-256 POUR S√âCURIT√â LOCALE
  // ==========================================
  async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }

  // ==========================================
  // SAUVEGARDE/CHARGEMENT LOCAL S√âCURIS√â
  // ==========================================
  async function saveLocalData(data) {
    const json = JSON.stringify(data);
    const hash = await sha256(json);
    localStorage.setItem('marketData', json);
    localStorage.setItem('marketData_hash', hash);
  }

  async function loadLocalData() {
    const stored = localStorage.getItem('marketData');
    const storedHash = localStorage.getItem('marketData_hash');

    if (stored && storedHash) {
      const computedHash = await sha256(stored);
      if (computedHash === storedHash) {
        return JSON.parse(stored);
      } else {
        console.warn("‚ö†Ô∏è Donn√©es locales corrompues, rechargement depuis Firebase");
        return null;
      }
    }
    return null;
  }

  // ==========================================
  // FIREBASE: CHARGEMENT DONN√âES
  // ==========================================
  async function loadFromFirebase() {
    try {
      const docRef = doc(db, COLLECTION_NAME, userId);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const data = docSnap.data();
        playerData = {
          gold: data.gold || 0,
          globalScore: data.globalScore || 0,
          marcheLevel: data.marcheLevel || 1,
          lastSync: data.lastSync || null
        };
        console.log("‚úÖ Donn√©es charg√©es depuis Firebase:", playerData);
      } else {
        // Premier chargement: cr√©er le document
        console.log("üÜï Cr√©ation du profil utilisateur sur Firebase");
        await setDoc(docRef, playerData);
      }

      await saveLocalData(playerData);
      return true;
    } catch (error) {
      console.error("‚ùå Erreur chargement Firebase:", error);
      showError("Erreur de connexion √† Firebase: " + error.message);
      return false;
    }
  }

  // ==========================================
  // FIREBASE: SAUVEGARDE DONN√âES
  // ==========================================
  async function saveToFirebase(updates) {
    try {
      const docRef = doc(db, COLLECTION_NAME, userId);
      
      // Mise √† jour avec timestamp
      const dataToUpdate = {
        ...updates,
        lastSync: new Date().toISOString()
      };

      await updateDoc(docRef, dataToUpdate);
      
      // Mise √† jour de l'√©tat local
      Object.assign(playerData, dataToUpdate);
      await saveLocalData(playerData);
      
      console.log("‚úÖ Donn√©es sauvegard√©es sur Firebase:", dataToUpdate);
      return true;
    } catch (error) {
      console.error("‚ùå Erreur sauvegarde Firebase:", error);
      showError("Erreur de sauvegarde: " + error.message);
      return false;
    }
  }

  // ==========================================
  // LOGIQUE √âCHANGE SCORE ‚Üí OR
  // ==========================================
  async function performExchange() {
    const goldToGet = parseInt(inputGold.value) || 0;
    const scoreToSpend = goldToGet * EXCHANGE_RATE;

    // Validations
    if (goldToGet <= 0) {
      showError("Veuillez s√©lectionner une quantit√© d'or √† √©changer");
      return;
    }

    if (scoreToSpend > playerData.globalScore) {
      showError(`Score insuffisant ! Vous avez ${playerData.globalScore} points, il en faut ${scoreToSpend}`);
      return;
    }

    // D√©sactiver le bouton pendant la transaction
    btnExchange.disabled = true;
    btnExchange.textContent = "‚è≥ √âchange en cours...";

    // Effectuer la transaction sur Firebase
    const newGold = playerData.gold + goldToGet;
    const newScore = playerData.globalScore - scoreToSpend;

    const success = await saveToFirebase({
      gold: newGold,
      globalScore: newScore
    });

    if (success) {
      showSuccess(`‚úÖ √âchange r√©ussi ! +${goldToGet} or (${scoreToSpend} points d√©pens√©s)`);
      
      // Reset des inputs
      inputGold.value = 0;
      inputScore.value = 0;
      goldSlider.value = 0;
      goldCountDisplay.textContent = '0';
      
      updateUI();
    }

    btnExchange.disabled = false;
    btnExchange.textContent = "üí∞ √âchanger";
  }

  // ==========================================
  // SYNCHRONISATION DES INPUTS
  // ==========================================
  function syncExchangeInputs() {
    // Slider ‚Üí inputs
    goldSlider.addEventListener('input', (e) => {
      const goldValue = parseInt(e.target.value) || 0;
      inputGold.value = goldValue;
      inputScore.value = goldValue * EXCHANGE_RATE;
      goldCountDisplay.textContent = goldValue;
    });

    // Input Or ‚Üí autres
    inputGold.addEventListener('input', (e) => {
      let goldValue = parseInt(e.target.value) || 0;
      const maxGold = Math.floor(playerData.globalScore / EXCHANGE_RATE);
      
      if (goldValue > maxGold) {
        goldValue = maxGold;
        e.target.value = maxGold;
      }
      
      goldSlider.value = goldValue;
      inputScore.value = goldValue * EXCHANGE_RATE;
      goldCountDisplay.textContent = goldValue;
    });

    // Input Score ‚Üí autres
    inputScore.addEventListener('input', (e) => {
      let scoreValue = parseInt(e.target.value) || 0;
      
      // Arrondir au multiple de 20 le plus proche
      scoreValue = Math.floor(scoreValue / EXCHANGE_RATE) * EXCHANGE_RATE;
      e.target.value = scoreValue;
      
      const goldValue = scoreValue / EXCHANGE_RATE;
      inputGold.value = goldValue;
      goldSlider.value = goldValue;
      goldCountDisplay.textContent = goldValue;
    });
  }

  // ==========================================
  // GESTION DES ONGLETS
  // ==========================================
  function setupTabs() {
    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        contents.forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });
  }

  // ==========================================
  // INITIALISATION
  // ==========================================
  async function init() {
    console.log("üöÄ Initialisation de la Place du march√©...");

    // Tentative de chargement local d'abord
    const localData = await loadLocalData();
    if (localData) {
      playerData = localData;
      console.log("üì¶ Donn√©es locales charg√©es:", playerData);
    }

    // Synchronisation avec Firebase
    const firebaseLoaded = await loadFromFirebase();
    
    if (!firebaseLoaded) {
      // Mode offline avec donn√©es locales
      console.warn("‚ö†Ô∏è Mode hors ligne - utilisation des donn√©es locales");
      if (!localData) {
        showError("Impossible de charger les donn√©es. Mode hors ligne.");
      }
    }

    // Mise √† jour de l'interface
    updateUI();
    syncExchangeInputs();
    setupTabs();

    // Afficher le contenu
    loadingEl.style.display = 'none';
    mainContent.style.display = 'block';

    console.log("‚úÖ Initialisation termin√©e");
  }

  // ==========================================
  // EVENT LISTENERS
  // ==========================================
  btnExchange.addEventListener('click', performExchange);
  
  btnSync.addEventListener('click', async () => {
    btnSync.disabled = true;
    btnSync.textContent = "üîÑ Synchronisation...";
    
    const success = await loadFromFirebase();
    if (success) {
      showSuccess("‚úÖ Synchronisation r√©ussie !");
      updateUI();
    }
    
    btnSync.disabled = false;
    btnSync.textContent = "üîÑ Synchroniser";
  });

  // ==========================================
  // D√âMARRAGE
  // ==========================================
  init();
</script>
</body>
</html>