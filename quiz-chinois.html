<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Master - Chinois simplifi√©</title>
  <style>
    /* === Style global === */
    body {
      background: linear-gradient(135deg, #0f1115, #1c1c24);
      color: #f0f0f0;
      font-family: 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
    }

    .navbar {
      background: #1a1a24;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .nav-title {
      font-size: 1.2em;
      font-weight: 600;
    }

    .nav-right {
      display: flex;
      gap: 10px;
    }

    .center {
      max-width: 800px;
      margin: 40px auto;
      background: #23233a;
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    h1 {
      text-align: center;
      margin-bottom: 6px;
    }

    .subtitle {
      text-align: center;
      color: #aaa;
      margin-bottom: 18px;
      font-size: 1.05em;
    }

    .action-btn {
      padding: 10px 18px;
      border-radius: 10px;
      background: #3a3a50;
      border: none;
      cursor: pointer;
      color: #f0f0f0;
      transition: 0.20s;
      font-size: 0.98em;
    }

    .action-btn:hover {
      background: #4e4e6a;
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .loading {
      text-align: center;
      padding: 28px;
      font-size: 1.1em;
      color: #aaa;
    }

    /* Timers empil√©s verticalement */
    #timers-container {
      width: 92%;
      max-width: 1000px;
      margin: 25px auto 0;
      /* centr√© + espace en haut */
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .timer-item {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .timer-label {
      font-size: 0.95em;
      color: #ccc;
      margin-bottom: 6px;
      text-align: left;
    }

    .timer-bar {
      width: 100%;
      height: 28px;
      background: #2b2b3a;
      border-radius: 10px;
      overflow: hidden;
    }

    .timer-fill {
      height: 100%;
      width: 100%;
      border-radius: 10px;
      transition: width 0.15s linear;
    }

    #timer-fill {
      background: #9c28a7ff;
      /* violet principal */
    }

    #question-timer-fill {
      background: #a832d6;
      /* violet secondaire (comme dans d√©partements) */
    }

    /* Quiz area */
    #quiz-main {
      display: none;
    }

    #quiz-section {
      display: flex;
      flex-direction: column;
      gap: 18px;
      align-items: center;
      width: 100%;
    }

    .question-box {
      width: 100%;
      text-align: center;
      margin-bottom: 6px;
    }

    .question-text {
      font-size: 1.35em;
      line-height: 1.4;
      margin-bottom: 8px;
    }

    .answers-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      width: 100%;
    }

    .answer-btn {
      padding: 12px 14px;
      border-radius: 10px;
      background: #3a3a50;
      border: none;
      cursor: pointer;
      color: #f0f0f0;
      font-size: 1em;
      min-width: 150px;
      text-align: center;
      transition: transform .12s, background .12s;
    }

    .answer-btn:hover:not(:disabled) {
      transform: translateY(-3px);
      background: #4e4e6a;
    }

    .answer-btn:disabled {
      opacity: 0.85;
      cursor: default;
      transform: none;
    }

    .stats {
      margin: 12px 0;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      font-size: 1.05em;
    }

    .stats div {
      flex: 1;
      text-align: center;
      font-weight: 600;
    }

    #quiz-next-btn,
    #quiz-restart-btn {
      display: none;
      width: 100%;
      margin-top: 6px;
    }

    #quiz-result {
      display: none;
      text-align: center;
    }

    .final-score {
      font-size: 1.8em;
      color: #2ecc71;
      margin: 12px 0;
    }

    .quiz-main-container {
      display: flex;
      gap: 20px;
      width: 100%;
      align-items: flex-start;
    }

    .leaderboard-container {
      background: #2c2c3a;
      padding: 14px;
      border-radius: 10px;
      width: 180px;
      max-height: 300px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 0.9em;
    }

    .leaderboard-item .rank {
      font-weight: bold;
      color: #ffcc00;
      width: 24px;
    }

    .leaderboard-item .name {
      flex: 1;
      text-align: right;
      padding-right: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .leaderboard-item .score {
      font-weight: bold;
      color: #2ecc71;
      margin-left: 6px;
    }

    @media (max-width: 750px) {
      .quiz-main-container {
        flex-direction: column;
        align-items: center;
      }

      .leaderboard-container {
        width: 100%;
        max-width: 300px;
      }
    }

    /* Responsive */
    @media (max-width:700px) {
      .answers-container {
        flex-direction: column;
      }

      #timers-container {
        flex-direction: column;
      }

      #timer-bar-container,
      #question-timer-bar-container {
        width: 100%;
      }
    }

    @media (max-width: 700px) {
      #timers-container {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <header>
    <nav class="navbar">
      <div class="nav-left"><span class="nav-title">üéØ Quiz Master - Chinois simplifi√©</span></div>
      <div class="nav-right">
        <button class="action-btn" onclick="window.location.href='index.html'">‚Üê Retour</button>
        <button class="action-btn" onclick="window.location.href='settings.html'">R√©glages</button>
      </div>
    </nav>
  </header>

  <div class="center">
    <div id="loading" class="loading">
      <p>Chargement du quiz‚Ä¶</p>
    </div>

    <!-- Quiz main -->
    <div id="quiz-main">
      <h1 id="quiz-title">Quiz Chinois</h1>
      <p class="subtitle" id="quiz-subtitle"></p>

      <div id="quiz-section">
        <div class="question-box">
          <div id="quiz-question" class="question-text"></div>
        </div>
        <div class="quiz-main-container">
          <div class="answers-container" id="quiz-answers"></div>
          <div class="leaderboard-container" id="chinois-leaderboard">
            <h3 style="margin: 0 0 12px 0; font-size: 1.1em; text-align: center;">üèÜ Top 5 Chinois</h3>
            <div id="chinois-leaderboard-list" style="font-size: 0.95em;"></div>
          </div>
        </div>

        <!-- ‚ö° TIMERS PLAC√âS ICI, EN DESSOUS DES R√âPONSES -->
        <div id="timers-container">
          <div class="timer-item">
            <div class="timer-label">‚è±Ô∏è Temps restant : <strong id="timer">0</strong>s</div>
            <div id="timer-bar" class="timer-bar">
              <div id="timer-fill" class="timer-fill"></div>
            </div>
          </div>
          <div class="timer-item">
            <div class="timer-label">‚ö° Question : <strong id="question-timer">0</strong>s</div>
            <div id="question-timer-bar" class="timer-bar">
              <div id="question-timer-fill" class="timer-fill"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="stats">
        <div>Score : <span id="quiz-score">0</span></div>
        <div>Vies : <span id="quiz-lives">‚ù§‚ù§‚ù§</span></div>
        <div>Question : <span id="quiz-index">0</span>/<span id="quiz-total">0</span></div>
      </div>

      <!-- Pas de boutons "Suivant" ici -->
    </div>

    <!-- Result -->
    <div id="quiz-result">
      <h1>üéâ Quiz termin√© !</h1>
      <div class="final-score">Score : <span id="quiz-final-score">0</span></div>
      <p id="result-message" style="font-size:1.05em; margin:8px 0 16px 0;"></p>
      <button class="action-btn" onclick="window.location.href='index.html'" style="width:100%; margin-top:8px;">Retour
        au menu principal</button>
      <button class="action-btn" id="retry-btn" style="width:100%; margin-top:10px;">Recommencer ce niveau</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ==========================================
    // CONFIGURATION FIREBASE
    // ==========================================
    const firebaseConfig = {
      apiKey: "AIzaSyDytQnPS_ZVbVuTkS8m3iUAOGMgm64A0XE",
      authDomain: "quiz-master-io.firebaseapp.com",
      projectId: "quiz-master-io",
      storageBucket: "quiz-master-io.firebasestorage.app",
      messagingSenderId: "773382469164",
      appId: "1:773382469164:web:5e24a9a62ce543f5190389"
    };

    // Initialisation
    let app, db, auth;
    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      console.log("‚úÖ Firebase initialis√©");
    } catch (error) {
      console.error("‚ùå Erreur Firebase:", error);
    }

    // ==========================================
    // UTILITAIRES
    // ==========================================
    function shuffle(array) {
      return [...array].sort(() => Math.random() - 0.5);
    }

    function pickWrong(pool, correctItem, key) {
      const wrong = new Set();
      while (wrong.size < 4) {
        const r = pool[Math.floor(Math.random() * pool.length)];
        if (r[key] !== correctItem[key]) {
          wrong.add(r);
        }
      }
      return Array.from(wrong);
    }

    // ==========================================
    // DONN√âES DES QUIZ
    // ==========================================

    // --- G√©n√©ration chinois 1 ‚Üí 100 ---
    const digits = ["Èõ∂", "‰∏Ä", "‰∫å", "‰∏â", "Âõõ", "‰∫î", "ÂÖ≠", "‰∏É", "ÂÖ´", "‰πù"];
    function numberToChinese(n) {
      if (n <= 10) return ["Èõ∂", "‰∏Ä", "‰∫å", "‰∏â", "Âõõ", "‰∫î", "ÂÖ≠", "‰∏É", "ÂÖ´", "‰πù", "ÂçÅ"][n];
      if (n < 20) return "ÂçÅ" + digits[n % 10];
      if (n < 100) {
        const tens = Math.floor(n / 10);
        const ones = n % 10;
        return digits[tens] + "ÂçÅ" + (ones ? digits[ones] : "");
      }
      if (n === 100) return "‰∏ÄÁôæ";
      return "";
    }

    // --- Questions culturelles enrichies (Niveau 1 & Niveau 2) ---
    const type3Questions = [
      { q: "Combien y a-t-il de continents ?", a: "7" },
      { q: "Combien y a-t-il d‚Äôoc√©ans sur Terre ?", a: "5" },
      { q: "Combien de jours dans une semaine ?", a: "7" },
      { q: "Combien de minutes dans une heure ?", a: "60" },
      { q: "Combien de secondes dans une minute ?", a: "60" },
      { q: "Combien de mois dans une ann√©e ?", a: "12" },
      { q: "Combien de pourcent vaut une moiti√© ?", a: "50" },
      { q: "Combien y a-t-il de continents ?", a: "7" },
      { q: "Combien y a-t-il d‚Äôoc√©ans sur Terre ?", a: "5" },
      { q: "Combien de jours dans une semaine ?", a: "7" },
      { q: "Combien de minutes dans une heure ?", a: "60" },
      { q: "Combien de secondes dans une minute ?", a: "60" },
      { q: "Combien de mois dans une ann√©e ?", a: "12" },
      { q: "Combien de semaines dans une ann√©e scolaire ?", a: "36" },
      { q: "Combien de jours dans un mois de f√©vrier non bissextile ?", a: "28" }, { q: "Combien de jours dans un mois de f√©vrier bissextile ?", a: "29" },
      { q: "Combien d‚Äôheures dans une journ√©e ?", a: "24" },
      { q: "Combien de minutes dans une demi-heure ?", a: "30" },
      { q: "Combien de secondes dans une demi-minute ?", a: "30" },
      { q: "Combien de mois ont 31 jours ?", a: "7" },
      { q: "Combien de mois ont 30 jours ?", a: "4" },
      { q: "Combien de fuseaux horaires existe-t-il dans le monde ?", a: "24" },
      { q: "Combien de jours dure une r√©volution compl√®te de Mercure autour du Soleil ?", a: "88" },
      { q: "Combien de kilom√®tres fait un marathon arrondi √† l‚Äôentier le plus proche ?", a: "42" },
      { q: "Combien de minutes fait un quart d'heure ?", a: "15" },
      { q: "Combien de secondes dans une heure arrondie √† la centaine la plus proche ?", a: "60" },
      { q: "Combien de semaines font 3 mois ?", a: "13" },
      { q: "Combien de jours dure un cycle lunaire complet arrondi ?", a: "30" },
      { q: "Combien de jours dans 2 mois ?", a: "60" },
      { q: "Combien de rotations compl√®tes la Lune effectue-t-elle autour de la Terre en un an ?", a: "13" },
      { q: "Combien de minutes faut-il pour que la lumi√®re du Soleil atteigne la Terre ?", a: "8" },
      { q: "Quelle est la vitesse maximale d‚Äôun TGV en service (en km/h) ?", a: "90" },
      { q: "Combien de minutes dans 1h30 ?", a: "90" },
      { q: "Combien de mois font 5 ans ?", a: "60" },
      { q: "Combien de semaines environ dans un mois ?", a: "4" },
      { q: "Combien de jours dure un mois lunaire moyen arrondi ?", a: "30" },
      { q: "Combien de minutes met un train √† 300 km/h pour faire 100 km ?", a: "20" },
      { q: "Combien de jours met la lumi√®re pour parcourir 1 orbite terrestre autour du Soleil ?", a: "0" },
      { q: "Combien de secondes met un son pour parcourir 1 km arrondi ?", a: "3" },
      { q: "Combien de m√®tres fait un kilom√®tre divis√© par 10 ?", a: "100" },
      { q: "Combien de centim√®tres fait un m√®tre ?", a: "100" },
      { q: "Combien de millim√®tres fait un centim√®tre ?", a: "10" },
      { q: "Combien de jours dans 4 semaines ?", a: "28" },
      { q: "Combien d‚Äôheures dans 240 minutes ?", a: "4" },
      { q: "Combien de minutes dans un tiers d‚Äôheure ?", a: "20" },
      { q: "√Ä combien de pourcent correspond 1/4 ?", a: "25" },
      { q: "Combien d‚Äôheures dans 3 jours ?", a: "72" },
      { q: "Combien de jours dans 6 semaines ?", a: "42" },
      { q: "Combien de secondes dans 30 secondes ?", a: "30" },
      { q: "Combien de secondes dans 10 minutes ?", a: "600" },
      { q: "Combien de pourcent font 3 quarts ?", a: "75" },
      { q: "Combien de minutes met un train √† 100 km/h pour parcourir 50 km ?", a: "30" },
      { q: "Combien y a-t-il de fuseaux horaires naturels couvrant la Chine enti√®re (m√™me si un seul est utilis√©) ?", a: "5" },
      { q: "Combien de minutes dure le trajet P√©kin‚ÄìTianjin en TGV (environ) ?", a: "30" },
      { q: "Combien de kilom√®tres fait la ligne de m√©tro la plus longue de Shanghai (arrondi √† la dizaine la plus proche) ?", a: "50" },
      { q: "Combien d‚Äôann√©es a dur√© la construction du Grand Canal moderne restaur√© sous les Ming (approx.) ?", a: "40" },
      { q: "Combien d‚Äôheures faut-il en avion entre Shanghai et Tokyo (approx.) ?", a: "3" },
      { q: "Combien de minutes dure en moyenne un √©pisode du Nouvel An chinois diffus√© √† la CCTV (Gala) par segment ?", a: "10" },
      { q: "Combien de kilom√®tres s√©parent Hong Kong de Shenzhen (√† vol d‚Äôoiseau) ?", a: "30" },
      { q: "Combien de minutes dure un trajet de bus typique entre deux districts centraux de P√©kin ?", a: "20" },
      { q: "Combien de kilom√®tres fait la mont√©e principale de la Grande Muraille √† Badaling (aller simple) ?", a: "3" }
    ];

    // =======================================
    // LEXIQUE NIVEAU 2
    // =======================================
    const vocabulaireN2 = [
        // Temps
        { fr: "Hier", ch: "Êò®Â§©", py: "zu√≥tiƒÅn" },
        { fr: "Aujourd'hui", ch: "‰ªäÂ§©", py: "jƒ´ntiƒÅn" },
        { fr: "Demain", ch: "ÊòéÂ§©", py: "m√≠ngtiƒÅn" },
        { fr: "Matin", ch: "Êó©‰∏ä", py: "z«éoshang" },
        { fr: "Apr√®s-midi", ch: "‰∏ãÂçà", py: "xi√†w«î" },
        { fr: "Soir", ch: "Êôö‰∏ä", py: "w«énshang" },
        { fr: "Maintenant", ch: "Áé∞Âú®", py: "xi√†nz√†i" },
        { fr: "Plus tard", ch: "‰ª•Âêé", py: "y«êh√≤u" },

        // Lieux / spatial
        { fr: "Ici", ch: "ËøôÈáå", py: "zh√®l«ê" },
        { fr: "L√†-bas", ch: "ÈÇ£Èáå", py: "n√†l«ê" },
        { fr: "√Ä droite", ch: "Âè≥Ëæπ", py: "y√≤ubiƒÅn" },
        { fr: "√Ä gauche", ch: "Â∑¶Ëæπ", py: "zu«íbiƒÅn" },
        { fr: "Devant", ch: "ÂâçÈù¢", py: "qi√°nmi√†n" },
        { fr: "Derri√®re", ch: "ÂêéÈù¢", py: "h√≤umi√†n" },
        { fr: "√Ä c√¥t√©", ch: "ÊóÅËæπ", py: "p√°ngbiƒÅn" },

        // Expressions utiles
        { fr: "Bonjour", ch: "‰Ω†Â•Ω", py: "n«ê h«éo" },
        { fr: "Bonsoir", ch: "Êôö‰∏äÂ•Ω", py: "w«énshang h«éo" },
        { fr: "Merci", ch: "Ë∞¢Ë∞¢", py: "xi√®xi√®" },
        { fr: "Excusez-moi", ch: "ÂØπ‰∏çËµ∑", py: "du√¨buq«ê" },
        { fr: "Je comprends", ch: "ÊàëÊáÇ‰∫Ü", py: "w«í d«íng le" },
        { fr: "Je ne comprends pas", ch: "Êàë‰∏çÊáÇ", py: "w«í b√π d«íng" },
        { fr: "Au revoir", ch: "ÂÜçËßÅ", py: "z√†iji√†n" },
        { fr: "√Ä demain", ch: "ÊòéÂ§©ËßÅ", py: "m√≠ngtiƒÅn ji√†n" },

        // Jours / calendrier
        { fr: "Lundi", ch: "ÊòüÊúü‰∏Ä", py: "xƒ´ngqƒ´ yƒ´" },
        { fr: "Mardi", ch: "ÊòüÊúü‰∫å", py: "xƒ´ngqƒ´ √®r" },
        { fr: "Mercredi", ch: "ÊòüÊúü‰∏â", py: "xƒ´ngqƒ´ sƒÅn" },
        { fr: "Jeudi", ch: "ÊòüÊúüÂõõ", py: "xƒ´ngqƒ´ s√¨" },
        { fr: "Vendredi", ch: "ÊòüÊúü‰∫î", py: "xƒ´ngqƒ´ w«î" },
        { fr: "Samedi", ch: "ÊòüÊúüÂÖ≠", py: "xƒ´ngqƒ´ li√π" },
        { fr: "Dimanche", ch: "ÊòüÊúüÂ§©", py: "xƒ´ngqƒ´ tiƒÅn" },
        { fr: "Week-end", ch: "Âë®Êú´", py: "zh≈çum√≤" },

        // F√™tes
        { fr: "Nouvel an chinois", ch: "Êò•ËäÇ", py: "Ch≈´nji√©" },
        { fr: "F√™te de la Lune", ch: "‰∏≠ÁßãËäÇ", py: "Zh≈çngqi≈´ji√©" },
        { fr: "F√™te nationale", ch: "ÂõΩÂ∫ÜËäÇ", py: "Gu√≥q√¨ngji√©" }
    ];

    // --- Patterns pour les phrases contextuelles ---
    const n2Patterns = [
        ["Je suis ici maintenant", "ÊàëÁé∞Âú®Âú®ËøôÈáå", "w«í xi√†nz√†i z√†i zh√®l«ê"],
        ["Je vais l√†-bas demain", "ÊàëÊòéÂ§©ÂéªÈÇ£Èáå", "w«í m√≠ngtiƒÅn q√π n√†l«ê"],
        ["Je viens ce soir", "ÊàëÊôö‰∏äÊù•", "w«í w«énshang l√°i"],
        ["Nous partons apr√®s-demain", "Êàë‰ª¨ÂêéÂ§©Ëµ∞", "w«ímen h√≤utiƒÅn z«íu"],
        ["Elle arrive demain matin", "Â•πÊòéÂ§©Êó©‰∏äÂà∞", "tƒÅ m√≠ngtiƒÅn z«éoshang d√†o"],
        ["Ils sont derri√®re toi", "‰ªñ‰ª¨Âú®‰Ω†ÂêéÈù¢", "tƒÅmen z√†i n«ê h√≤umi√†n"],
        ["Il est √† c√¥t√© de moi", "‰ªñÂú®ÊàëÁöÑÊóÅËæπ", "tƒÅ z√†i w«í de p√°ngbiƒÅn"],
        ["Je ne comprends pas", "Êàë‰∏çÊáÇ", "w«í b√π d«íng"]
    ];

    // =======================================
    // LEXIQUE NIVEAU 3
    // =======================================
    const vocabulaireN3 = [
        // Verbes fr√©quents
        { fr: "vouloir", ch: "ÊÉ≥", py: "xi«éng" },
        { fr: "pouvoir (capacit√©)", ch: "‰ºö", py: "hu√¨" },
        { fr: "pouvoir (permission)", ch: "ÂèØ‰ª•", py: "kƒõy«ê" },
        { fr: "devoir", ch: "Ë¶Å", py: "y√†o" },
        { fr: "aller", ch: "Âéª", py: "q√π" },
        { fr: "venir", ch: "Êù•", py: "l√°i" },
        { fr: "manger", ch: "ÂêÉ", py: "chƒ´" },
        { fr: "boire", ch: "Âñù", py: "hƒì" },
        { fr: "voir", ch: "Áúã", py: "k√†n" },

        // Phrases utiles
        { fr: "Je veux manger", ch: "ÊàëÊÉ≥ÂêÉÈ•≠", py: "w«í xi«éng chƒ´ f√†n" },
        { fr: "Je ne comprends pas", ch: "Êàë‰∏çÊáÇ", py: "w«í b√π d«íng" },
        { fr: "Peux-tu m'aider ?", ch: "‰Ω†ÂèØ‰ª•Â∏ÆÊàëÂêóÔºü", py: "n«ê kƒõy«ê bƒÅng w«í ma?" },
        { fr: "O√π vas-tu ?", ch: "‰Ω†ÂéªÂì™ÂÑøÔºü", py: "n«ê q√π n«ér?" },
        { fr: "Je suis occup√©", ch: "ÊàëÂæàÂøô", py: "w«í hƒõn m√°ng" },
        { fr: "J'arrive bient√¥t", ch: "ÊàëÈ©¨‰∏äÊù•", py: "w«í m«ésh√†ng l√°i" },
        { fr: "Attends-moi un moment", ch: "Á≠âÊàë‰∏Ä‰∏ã", py: "dƒõng w«í y√≠xi√†" },

        // Expressions + particules
        { fr: "C'est vrai ?", ch: "ÁúüÁöÑÂêóÔºü", py: "zhƒìn de ma?" },
        { fr: "D'accord", ch: "Â•ΩÁöÑ", py: "h«éo de" },
        { fr: "Pas de probl√®me", ch: "Ê≤°ÈóÆÈ¢ò", py: "m√©i w√®nt√≠" },
        { fr: "Tr√®s bien", ch: "ÂæàÂ•Ω", py: "hƒõn h«éo" },

        // Temporalit√© plus avanc√©e
        { fr: "Je suis en train de manger", ch: "ÊàëÊ≠£Âú®ÂêÉÈ•≠", py: "w«í zh√®ngz√†i chƒ´ f√†n" },
        { fr: "Je viens de finir", ch: "ÊàëÂàöÂàöÁªìÊùü", py: "w«í gƒÅnggƒÅng ji√©sh√π" },
    ];

    // --- Fonctions de g√©n√©ration Niveau 3 ---
    function qN3_type1() {
        const item = vocabulaireN3[Math.floor(Math.random() * vocabulaireN3.length)];

        const wrong = pickWrong(vocabulaireN3, item, "ch");
        const opts = shuffle([...wrong, item].map(o => ({ raw: o.ch, display: `${o.ch} (${o.py})` })));

        return {
            q: `Comment dit-on : <b>${item.fr}</b> ?`,
            a: item.ch,
            opts
        };
    }

    function qN3_type2() {
        const item = vocabulaireN3[Math.floor(Math.random() * vocabulaireN3.length)];

        const wrong = pickWrong(vocabulaireN3, item, "fr");
        const opts = shuffle([...wrong, item].map(o => ({ raw: o.fr, display: o.fr })));

        return {
            q: `Que signifie : <b>${item.ch}</b> (${item.py}) ?`,
            a: item.fr,
            opts
        };
    }

    function qN3_type3() {
        const item = vocabulaireN3[Math.floor(Math.random() * vocabulaireN3.length)];

        const wrong = pickWrong(vocabulaireN3, item, "ch");
        const opts = shuffle([...wrong, item].map(o => ({ raw: o.ch, display: `${o.ch}` })));

        return {
            q: `Quel est l'√©criture chinoise de : <b>${item.py}</b> ?`,
            a: item.ch,
            opts
        };
    }

    function qN3_type4() {
        const candidates = vocabulaireN3.filter(o => /ÊÉ≥|‰ºö|Ë¶Å|ÂèØ‰ª•|Ê≠£Âú®/.test(o.ch));
        const item = candidates[Math.floor(Math.random() * candidates.length)];

        const missing = item.ch.match(/ÊÉ≥|‰ºö|Ë¶Å|ÂèØ‰ª•|Ê≠£Âú®/)[0];
        const question = item.ch.replace(missing, "___");

        const opts = shuffle([
            { raw: missing, display: missing },
            { raw: "‰∏ç", display: "‰∏ç" },
            { raw: "Âæà", display: "Âæà" },
            { raw: "Âú®", display: "Âú®" },
            { raw: "Âêó", display: "Âêó" }
        ]);

        return {
            q: `Compl√®te la phrase : <b>${question}</b>`,
            a: missing,
            opts
        };
    }

    function qN3_type5() {
        const sentences = [
            ["Êàë", "ÊÉ≥", "Âéª", "Âåó‰∫¨"],
            ["‰Ω†", "‰ºö", "ËØ¥", "‰∏≠Êñá"],
            ["Êàë", "Ê≠£Âú®", "ÂêÉÈ•≠"],
            ["‰ªñ", "ÊòéÂ§©", "Êù•", "ËøôÈáå"]
        ];

        const s = sentences[Math.floor(Math.random() * sentences.length)];
        const shuffled = shuffle([...s]);

        const allVariants = new Set([s.join(" ")]);
        while (allVariants.size < 5) {
            const variant = shuffle([...s]).join(" ");
            allVariants.add(variant);
        }

        const opts = shuffle(Array.from(allVariants).map(o => ({ raw: o, display: o }))).slice(0, 5);

        return {
            q: `Remets la phrase en ordre : <b>${shuffled.join(" / ")}</b>`,
            a: s.join(" "),
            opts
        };
    }

    function qN3_type6() {
        const bank = [
            { q: "‰Ω†ÂêÉ___È•≠ÂêóÔºü", a: "Ëøá" },
            { q: "‰Ω†ÂéªÂåó‰∫¨___Ôºü", a: "Âêó" },
            { q: "Êàë‰ª¨Ëµ∞___ÔºÅ", a: "Âêß" },
            { q: "ÊàëÂêÉ___‰∫ÜÈ•≠", a: "" }
        ];

        const item = bank[Math.floor(Math.random() * bank.length)];

        const allOpts = new Set(["‰∫Ü", "Âêó", "Âêß", "Ëøá", "‰∏ç", "", item.a]);
        const opts = shuffle(Array.from(allOpts).map(o => ({ raw: o, display: o || "‚àÖ" }))).slice(0, 5);

        return {
            q: `Compl√®te : <b>${item.q}</b>`,
            a: item.a,
            opts
        };
    }

    function qN3_type7() {
        const base = [
            { fr: "Je mange maintenant", ch: "ÊàëÁé∞Âú®ÂêÉÈ•≠" },
            { fr: "Je veux aller en Chine", ch: "ÊàëÊÉ≥Âéª‰∏≠ÂõΩ" },
            { fr: "Je peux venir demain", ch: "ÊàëÊòéÂ§©ÂèØ‰ª•Êù•" }
        ];

        const item = base[Math.floor(Math.random() * base.length)];

        const wrong = [
            "ÊàëÂêÉÈ•≠Áé∞Âú®",
            "Áé∞Âú®ÊàëÈ•≠ÂêÉ",
            "ÊàëÈ©¨‰∏äÂêÉÈ•≠",
            "Êàë‰ªäÂ§©ÂêÉÈ•≠"
        ];

        const opts = shuffle([item.ch, ...wrong].slice(0, 5).map(o => ({ raw: o, display: o })));

        return {
            q: `Comment dire : <b>${item.fr}</b> ?`,
            a: item.ch,
            opts
        };
    }

    // --- G√©n√©rateur d'une question al√©atoire pour niveau 1 ---
    function generateRandomQuestion() {
      const type = Math.floor(Math.random() * 4) + 1;

      // ------------------------- (1) Quel est le caract√®re pour XX ? -------------------------
      if (type === 1) {
        const n = Math.floor(Math.random() * 100) + 1;
        const correct = numberToChinese(n);

        const wrong = new Set();
        while (wrong.size < 5) {
          const r = Math.floor(Math.random() * 100) + 1;
          if (r !== n) wrong.add(numberToChinese(r));
        }

        const allOpts = [correct, ...wrong];
        const shuffleOpts = [...allOpts].sort(() => Math.random() - 0.5);

        return {
          q: `Quel est le caract√®re pour <br><span style="font-size:4rem;font-weight:800;display:block;">${n}</span> ?`,
          a: correct,
          opts: shuffleOpts.map(char => ({
            raw: char,
            display: `<span style="font-size: calc(1rem + 3px);">${char}</span>`
          }))
        };
      }

      // ------------------------- (2) Calcul XX - YY = ? -------------------------
      if (type === 2) {
        let a = Math.floor(Math.random() * 100) + 1;
        let b = Math.floor(Math.random() * 100) + 1;
        if (b > a) [a, b] = [b, a];

        const result = a - b;

        const displayA = Math.random() > 0.5 ? String(a) : numberToChinese(a);
        const displayB = Math.random() > 0.5 ? String(b) : numberToChinese(b);

        return {
          q: `${displayA} ‚àí ${displayB} = ?`,
          a: String(result),
          opts: generateRandomOpts(result, 6)
        };
      }

      // ------------------------- (3) Questions culturelles -------------------------
      if (type === 3) {
        const item = type3Questions[Math.floor(Math.random() * type3Questions.length)];
        const correct = Number(item.a);

        return {
          q: item.q,
          a: item.a,
          opts: generateType3RndOpts(correct, 6)
        };
      }

      // ------------------------- (4) Quel est ce caract√®re ? -------------------------
      if (type === 4) {
        const n = Math.floor(Math.random() * 100) + 1;
        const ch = numberToChinese(n);

        const wrong = new Set();
        while (wrong.size < 5) {
          const r = Math.floor(Math.random() * 100) + 1;
          if (r !== n) wrong.add(r);
        }

        const allOpts = [n, ...wrong];
        const shuffledOpts = [...allOpts].sort(() => Math.random() - 0.5);

        return {
          q: `Quel est ce caract√®re : <br><span style="font-size:4rem;font-weight:800;display:block;">${ch}</span>`,
          a: String(n),
          opts: shuffledOpts.map(v => ({
            raw: v,
            display: `<span style="font-size: calc(1rem + 3px);">${v}</span>`
          }))
        };
      }
    }

    // --- G√©n√®re des options FR + CH al√©atoires ---
    function generateRandomOpts(correctAnswer, count = 6) {
      const values = new Set();
      values.add(Number(correctAnswer));

      while (values.size < count) {
        let v = Number(correctAnswer) + Math.floor(Math.random() * 21) - 10;
        if (v < 0 || v > 100) v = Math.floor(Math.random() * 101);
        values.add(v);
      }

      const opts = [...values].map(v => ({
        raw: v,
        display: `<span style="font-size: calc(1rem + 3px);">${v} (${numberToChinese(v)})</span>`
      }));

      return opts.sort(() => Math.random() - 0.5);
    }

    function generateType3RndOpts(correctAnswer, count = 6) {
      const values = new Set();
      values.add(Number(correctAnswer));

      while (values.size < count) {
        let v = Number(correctAnswer) + Math.floor(Math.random() * 21) - 10;
        if (v < 0 || v > 100) v = Math.floor(Math.random() * 101);
        values.add(v);
      }

      return [...values].map(v => ({
        raw: v,
        display: `<span style="font-size: calc(1rem + 3px);">${numberToChinese(v)}</span>`
      })).sort(() => Math.random() - 0.5);
    }

    // --- G√©n√©rateur de question pour niveau 2 ---
    function generateN2Question() {
      const type = Math.floor(Math.random() * 3) + 1;

      // ----------------------------------------------------------
      // TYPE 1 ‚Äî FR ‚Üí CH + PINYIN (25% des questions en FR)
      // ----------------------------------------------------------
      if (type === 1) {
        const item = vocabulaireN2[Math.floor(Math.random() * vocabulaireN2.length)];

        const wrong = new Set();
        while (wrong.size < 4) {
          const r = vocabulaireN2[Math.floor(Math.random() * vocabulaireN2.length)];
          if (r.ch !== item.ch) wrong.add(r);
        }

        const opts = [...wrong, item]
          .sort(() => Math.random() - 0.5)
          .map(o => ({
            raw: o.ch,
            display: `${o.ch} (${o.py})`
          }));

        return {
          q: `Comment s'√©crit : <b>${item.fr}</b> ?`,
          a: item.ch,
          opts
        };
      }

      // ----------------------------------------------------------
      // TYPE 2 ‚Äî CH ‚Üí FR + PINYIN (75% des questions en CH)
      // ----------------------------------------------------------
      if (type === 2) {
        const item = vocabulaireN2[Math.floor(Math.random() * vocabulaireN2.length)];

        const wrong = new Set();
        while (wrong.size < 4) {
          const r = vocabulaireN2[Math.floor(Math.random() * vocabulaireN2.length)];
          if (r.fr !== item.fr) wrong.add(r);
        }

        const opts = [...wrong, item]
          .sort(() => Math.random() - 0.5)
          .map(o => ({
            raw: o.fr,
            display: o.fr
          }));

        return {
          q: `Que signifie : <b>${item.ch}</b> (${item.py}) ?`,
          a: item.fr,
          opts
        };
      }

      // ----------------------------------------------------------
      // TYPE 3 ‚Äî Contexte temporel/spatial (CH + PINYIN)
      // ----------------------------------------------------------
      if (type === 3) {
        const item = n2Patterns[Math.floor(Math.random() * n2Patterns.length)];

        const wrong = new Set();
        while (wrong.size < 4) {
          const r = n2Patterns[Math.floor(Math.random() * n2Patterns.length)];
          if (r[1] !== item[1]) wrong.add(r);
        }

        const opts = [...wrong, item]
          .sort(() => Math.random() - 0.5)
          .map(o => ({
            raw: o[1],
            display: `${o[1]} (${o[2]})`
          }));

        return {
          q: `Comment dit-on : <b>${item[0]}</b> ?`,
          a: item[1],
          opts
        };
      }
    }

    // --- G√©n√©rateur de question pour niveau 3 ---
    function generateN3Question() {
      const type = Math.floor(Math.random() * 7) + 1;

      switch (type) {
        case 1: return qN3_type1();
        case 2: return qN3_type2();
        case 3: return qN3_type3();
        case 4: return qN3_type4();
        case 5: return qN3_type5();
        case 6: return qN3_type6();
        case 7: return qN3_type7();
        default: return qN3_type1();
      }
    }

    // --- G√©n√©ration de 50 questions pour niveau 1 ---
    function generateQuizN1() {
      const questions = [];
      for (let i = 0; i < 50; i++) {
        questions.push(generateRandomQuestion());
      }

      return {
        title: "Niveau 1 : Chiffres et logiques 1-100",
        subtitle: "Questions al√©atoires m√©langeant chiffres, calculs, culture g√©n√©rale et caract√®res chinois",
        questions
      };
    }

    // --- G√©n√©ration de 50 questions pour niveau 2 ---
    function generateQuizN2() {
      const questions = [];
      for (let i = 0; i < 50; i++) {
        questions.push(generateN2Question());
      }

      return {
        title: "Niveau 2 : Vocabulaire quotidien",
        subtitle: "Temps, lieux, expressions, jours et f√™tes en chinois simplifi√©",
        questions
      };
    }

    // --- G√©n√©ration de 50 questions pour niveau 3 ---
    function generateQuizN3() {
      const questions = [];
      for (let i = 0; i < 50; i++) {
        questions.push(generateN3Question());
      }

      return {
        title: "Niveau 3 : Verbes et constructions",
        subtitle: "Verbes, particules, ordre des mots et phrases complexes en chinois",
        questions
      };
    }

    // --- Donn√©es des quiz ---
    const quizData = {
      1: generateQuizN1(),
      2: generateQuizN2(),
      3: generateQuizN3(),
      4: {
        title: "Niveau 4 : Membres de la famille",
        subtitle: "Apprenez √† d√©signer les membres de la famille",
        questions: [
          { q: "Comment √©crit-on <strong>'maman'</strong> ?", a: "Â¶àÂ¶à", opts: ["Â¶àÂ¶à", "Áà∏Áà∏", "Âì•Âì•", "ÂßêÂßê", "Â¶πÂ¶π"] },
          { q: "Comment √©crit-on <strong>'papa'</strong> ?", a: "Áà∏Áà∏", opts: ["Áà∏Áà∏", "Â¶àÂ¶à", "ÂºüÂºü", "Â¶πÂ¶π", "Âì•Âì•"] },
          { q: "Comment √©crit-on <strong>'grand fr√®re'</strong> ?", a: "Âì•Âì•", opts: ["Âì•Âì•", "ÂºüÂºü", "ÂßêÂßê", "Â¶πÂ¶π", "Áà∏Áà∏"] },
          { q: "Comment √©crit-on <strong>'petit fr√®re'</strong> ?", a: "ÂºüÂºü", opts: ["ÂºüÂºü", "Âì•Âì•", "Áà∏Áà∏", "Â¶àÂ¶à", "ÂèîÂèî"] },
          { q: "Comment √©crit-on <strong>'grande s≈ìur'</strong> ?", a: "ÂßêÂßê", opts: ["ÂßêÂßê", "Â¶πÂ¶π", "Â¶àÂ¶à", "Âì•Âì•", "ÈòøÂß®"] },
          { q: "Comment √©crit-on <strong>'petite s≈ìur'</strong> ?", a: "Â¶πÂ¶π", opts: ["Â¶πÂ¶π", "ÂßêÂßê", "Áà∏Áà∏", "ÂºüÂºü", "Â•∂Â•∂"] },
          { q: "Qui est Áà∏Áà∏ ?", a: "Papa", opts: ["Papa", "Maman", "Grand-p√®re", "Oncle", "Tante"] },
          { q: "Qui est ÂßêÂßê ?", a: "Grande s≈ìur", opts: ["Grande s≈ìur", "Petite s≈ìur", "Maman", "Tante", "Cousine"] },
          { q: "Comment dit-on 'grand-m√®re' ?", a: "Â•∂Â•∂", opts: ["Â•∂Â•∂", "Â§ñÂ©Ü", "Áà∑Áà∑", "Âß•Âß•", "Â¶àÂ¶à"] },
          { q: "Comment dit-on 'oncle' (fr√®re du p√®re) ?", a: "ÂèîÂèî", opts: ["ÂèîÂèî", "ËàÖËàÖ", "‰ºØ‰ºØ", "ÈòøÂß®", "Áà∑Áà∑"] }
        ]
      },
      5: {
        title: "Niveau 5 : Animaux courants",
        subtitle: "D√©couvrez les animaux en chinois simplifi√©",
        questions: [
          { q: "Comment √©crit-on <strong>'chat'</strong> ?", a: "Áå´", opts: ["Áå´", "Áãó", "È∏ü", "È©¨", "Áâõ"] },
          { q: "Comment √©crit-on <strong>'chien'</strong> ?", a: "Áãó", opts: ["Áãó", "Áå´", "È±º", "Áâõ", "È©¨"] },
          { q: "Comment √©crit-on <strong>'oiseau'</strong> ?", a: "È∏ü", opts: ["È∏ü", "È©¨", "Áãó", "Áå´", "Áå™"] },
          { q: "Comment √©crit-on <strong>'poisson'</strong> ?", a: "È±º", opts: ["È±º", "Áâõ", "Áå´", "Áãó", "È∏ü"] },
          { q: "Comment √©crit-on <strong>'cheval'</strong> ?", a: "È©¨", opts: ["È©¨", "È∏ü", "È±º", "Áâõ", "Áæä"] },
          { q: "Comment √©crit-on <strong>'vache'</strong> ?", a: "Áâõ", opts: ["Áâõ", "È©¨", "Áå´", "Áãó", "Áæä"] },
          { q: "Quel animal repr√©sente Áå´ ?", a: "Chat", opts: ["Chat", "Chien", "Tigre", "Lapin", "Oiseau"] },
          { q: "Quel animal repr√©sente È±º ?", a: "Poisson", opts: ["Poisson", "Oiseau", "Grenouille", "Serpent", "Chien"] },
          { q: "Quel animal repr√©sente È©¨ ?", a: "Cheval", opts: ["Cheval", "Vache", "√Çne", "Z√®bre", "Ch√®vre"] },
          { q: "Quel animal repr√©sente Áâõ ?", a: "Vache", opts: ["Vache", "Cheval", "Chien", "Chat", "Mouton"] }
        ]
      }
    };

    // ==========================================
    // CONSTANTES
    // ==========================================
    const TOTAL_TIME_SECONDS = 90;
    const QUESTION_TIME_SECONDS = 10;
    const INITIAL_LIVES = 10;

    // ==========================================
    // VARIABLES D'√âTAT
    // ==========================================
    let currentLevel = null;
    let questions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let lives = INITIAL_LIVES;
    let answered = false;
    let globalTimerInterval = null;
    let questionTimerInterval = null;

    // ==========================================
    // √âL√âMENTS DOM
    // ==========================================
    const loadingEl = document.getElementById('loading');
    const timersContainer = document.getElementById('timers-container');
    const quizMain = document.getElementById('quiz-main');
    const quizResult = document.getElementById('quiz-result');
    const quizTitle = document.getElementById('quiz-title');
    const quizSubtitle = document.getElementById('quiz-subtitle');
    const quizQuestion = document.getElementById('quiz-question');
    const quizAnswers = document.getElementById('quiz-answers');
    const quizScore = document.getElementById('quiz-score');
    const quizLives = document.getElementById('quiz-lives');
    const quizIndex = document.getElementById('quiz-index');
    const quizTotal = document.getElementById('quiz-total');
    const quizNextBtn = document.getElementById('quiz-next-btn');
    const quizRestartBtn = document.getElementById('quiz-restart-btn');
    const quizFinalScore = document.getElementById('quiz-final-score');
    const resultMessage = document.getElementById('result-message');
    const retryBtn = document.getElementById('retry-btn');
    const timerDisplay = document.getElementById('timer');
    const questionTimerDisplay = document.getElementById('question-timer');
    const timerFill = document.getElementById('timer-fill');
    const questionTimerFill = document.getElementById('question-timer-fill');

    // ==========================================
    // GESTION DES TIMERS
    // ==========================================
    function startGlobalTimer() {
      clearInterval(globalTimerInterval);
      let remaining = TOTAL_TIME_SECONDS;
      timerDisplay.textContent = remaining;
      timerFill.style.width = '100%';

      globalTimerInterval = setInterval(() => {
        remaining--;
        timerDisplay.textContent = remaining;
        const percentElapsed = ((TOTAL_TIME_SECONDS - remaining) / TOTAL_TIME_SECONDS) * 100;
        const percentRemaining = 100 - percentElapsed;
        timerFill.style.width = percentRemaining + '%';

        if (remaining <= 0) {
          clearInterval(globalTimerInterval);
          endQuiz(true);
        }
      }, 1000);
    }

    function highlightAnswers(correctAnswer, selectedAnswer = null) {
      Array.from(quizAnswers.children).forEach(btn => {
        btn.disabled = true;
        const btnValue = btn.dataset.value;
        if (btnValue === correctAnswer) {
          btn.style.background = '#2ecc71';
        } else if (selectedAnswer !== null && btnValue === selectedAnswer) {
          btn.style.background = '#e74c3c';
        }
      });
    };

    function startQuestionTimer() {
      clearInterval(questionTimerInterval);
      let remaining = QUESTION_TIME_SECONDS;
      questionTimerDisplay.textContent = remaining;
      questionTimerFill.style.width = '100%';

      questionTimerInterval = setInterval(() => {
        remaining--;
        questionTimerDisplay.textContent = remaining;
        const percentElapsed = ((QUESTION_TIME_SECONDS - remaining) / QUESTION_TIME_SECONDS) * 100;
        const percentRemaining = 100 - percentElapsed;
        questionTimerFill.style.width = percentRemaining + '%';

        if (remaining <= 0) {
          clearInterval(questionTimerInterval);
          handleQuestionTimeout();
        }
      }, 1000);
    }

    function stopQuestionTimer() {
      clearInterval(questionTimerInterval);
    }

    function stopAllTimers() {
      clearInterval(globalTimerInterval);
      clearInterval(questionTimerInterval);
    }

    // ==========================================
    // GESTION DU QUIZ
    // ==========================================
    async function initQuiz() {
      const hash = window.location.hash.replace('#', '');
      const level = parseInt(hash, 10);

      if (!level || !quizData[level]) {
        window.location.href = 'index.html';
        return;
      }

      currentLevel = level;
      const data = quizData[level];

      quizTitle.textContent = data.title;
      quizSubtitle.textContent = data.subtitle;
      questions = [...data.questions].sort(() => Math.random() - 0.5);
      currentQuestionIndex = 0;
      score = 0;
      lives = INITIAL_LIVES;

      loadingEl.style.display = 'none';
      quizMain.style.display = 'block';
      quizResult.style.display = 'none';
      timersContainer.style.display = 'flex';

      updateStats();
      showQuestion();
      startGlobalTimer();
      await loadChinoisLeaderboard();
    }

    function showQuestion() {
      stopQuestionTimer();

      if (currentQuestionIndex >= questions.length || lives <= 0) {
        endQuiz(false);
        return;
      }

      const question = questions[currentQuestionIndex];
      quizQuestion.innerHTML = question.q;

      const shuffledOpts = [...question.opts].sort(() => Math.random() - 0.5);
      quizAnswers.innerHTML = '';

      shuffledOpts.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn';

        let value, display;
        if (typeof opt === 'object') {
          value = String(opt.raw);
          display = opt.display;
        } else {
          value = opt;
          display = opt;
        }

        btn.innerHTML = display;
        btn.dataset.value = value;
        btn.onclick = () => selectAnswer(value, question.a);
        quizAnswers.appendChild(btn);
      });

      quizIndex.textContent = currentQuestionIndex + 1;
      quizTotal.textContent = questions.length;

      startQuestionTimer();
    }

    function selectAnswer(selected, correct) {
      if (answered) return;
      answered = true;
      stopQuestionTimer();

      highlightAnswers(correct, selected);

      if (selected === correct) {
        score++;
      } else {
        lives--;
      }

      updateStats();
      setTimeout(nextQuestion, 1000);
    }

    function handleQuestionTimeout() {
      if (answered) return;
      answered = true;
      const question = questions[currentQuestionIndex];
      highlightAnswers(question.a);
      lives--;
      updateStats();
      setTimeout(nextQuestion, 1000);
    }

    function nextQuestion() {
      currentQuestionIndex++;
      answered = false;
      showQuestion();
    }

    function updateStats() {
      quizScore.textContent = score;
      quizLives.textContent = '‚ù§'.repeat(Math.max(0, lives)) + '‚ô°'.repeat(Math.max(0, INITIAL_LIVES - lives));
    }

    async function endQuiz(timeout = false) {
      stopAllTimers();

      quizMain.style.display = 'none';
      quizResult.style.display = 'block';

      quizFinalScore.textContent = score + ' / ' + questions.length;

      // Sauvegarde du score r√©el via Firebase
      await saveQuizScore(score);
      await loadChinoisLeaderboard();

      if (timeout) {
        resultMessage.textContent = '‚è≥ Temps √©coul√© ! Essayez encore ‚Äî vous pouvez recommencer le niveau.';
      } else {
        const percentage = questions.length > 0 ? (score / questions.length) * 100 : 0;
        if (percentage === 100) {
          resultMessage.textContent = 'üèÜ Parfait ! Vous ma√Ætrisez ce niveau !';
        } else if (percentage >= 80) {
          resultMessage.textContent = 'üëè Excellent travail ! Continuez comme √ßa !';
        } else if (percentage >= 60) {
          resultMessage.textContent = 'üëç Bon travail ! Encore un peu de pratique !';
        } else {
          resultMessage.textContent = 'üí™ Continuez √† pratiquer, vous progressez !';
        }
      }
    }

    // ==========================================
    // SAUVEGARDE FIREBASE (originale, non simul√©e)
    // ==========================================
    async function saveQuizScore(finalScore) {
      try {
        const currentUser = auth.currentUser;
        if (!currentUser) {
          console.log("Utilisateur non connect√©, score non sauvegard√©");
          return;
        }

        const userDocRef = doc(db, "users", currentUser.uid);
        const userDoc = await getDoc(userDocRef);
        let userData = userDoc.exists() ? userDoc.data() : null;

        // Cr√©ation du profil si n√©cessaire
        if (!userData) {
          userData = {
            pseudo: currentUser.email.split("@")[0],
            email: currentUser.email,
            globalScore: 0,
            quizScores: { departements: 0, chinois: 0 },
            createdAt: new Date().toISOString()
          };
          await setDoc(userDocRef, userData);
        }

        // Mise √† jour des scores
        const oldGlobalScore = userData.globalScore || 0;
        const newGlobalScore = oldGlobalScore + finalScore;
        const oldChinoisScore = userData.quizScores?.chinois || 0;
        const newChinoisScore = oldChinoisScore + finalScore;

        await updateDoc(userDocRef, {
          globalScore: newGlobalScore,
          'quizScores.chinois': newChinoisScore,
          lastQuizDate: new Date().toISOString()
        });

        console.log("‚úÖ Score sauvegard√©:", finalScore);
      } catch (error) {
        console.error("‚ùå Erreur sauvegarde score:", error);
      }
    }

    async function loadChinoisLeaderboard() {
      const listEl = document.getElementById('chinois-leaderboard-list');
      if (!listEl) return;

      listEl.innerHTML = '<div style="text-align:center; opacity:0.6;">Chargement...</div>';

      try {
        // Requ√™te Firestore : top 5 par quizScores.chinois
        const q = query(
          collection(db, 'users'),
          orderBy('quizScores.chinois', 'desc'),
          limit(5)
        );
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          listEl.innerHTML = '<div style="text-align:center; opacity:0.6;">Aucun score</div>';
          return;
        }

        let html = '';
        let rank = 1;
        snapshot.forEach(doc => {
          const data = doc.data();
          const pseudo = (data.pseudo || 'Anonyme').substring(0, 12);
          const score = data.quizScores?.chinois || 0;

          // Emoji pour le top 3
          let rankText = `${rank}.`;
          if (rank === 1) rankText = 'ü•á';
          else if (rank === 2) rankText = 'ü•à';
          else if (rank === 3) rankText = 'ü•â';

          html += `
            <div class="leaderboard-item">
              <span class="rank">${rankText}</span>
              <span class="name">${pseudo}</span>
              <span class="score">${score}</span>
            </div>
          `;
          rank++;
        });

        listEl.innerHTML = html;
      } catch (error) {
        console.error("Erreur chargement leaderboard chinois:", error);
        listEl.innerHTML = '<div style="text-align:center; opacity:0.6;">Erreur</div>';
      }
    }

    retryBtn.addEventListener('click', () => {
      stopAllTimers();
      initQuiz();
    });

    window.addEventListener('hashchange', () => {
      stopAllTimers();
      initQuiz();
    });

    // ==========================================
    // D√âMARRAGE
    // ==========================================
    window.addEventListener('load', initQuiz);
  </script>
</body>

</html>

